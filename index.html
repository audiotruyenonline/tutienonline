<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Truyện Online</title>
  <meta name="theme-color" content="#0b1020" />
  <style>
    :root{
      --bg:#070a14;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --soft: rgba(255,255,255,.12);
      --line: rgba(255,255,255,.14);
      --brand1:#7c3aed;
      --brand2:#22d3ee;
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 28px;
      --blur: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    [data-theme="light"]{
      --bg:#f6f7fb;
      --panel: rgba(10,20,40,.06);
      --panel2: rgba(10,20,40,.08);
      --text: rgba(10,20,40,.92);
      --muted: rgba(10,20,40,.65);
      --soft: rgba(10,20,40,.12);
      --line: rgba(10,20,40,.14);
      --shadow: 0 18px 40px rgba(10,20,40,.10);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 20% -10%, rgba(124,58,237,.35), transparent 55%),
        radial-gradient(900px 520px at 90% 0%, rgba(34,211,238,.25), transparent 55%),
        radial-gradient(900px 600px at 50% 120%, rgba(99,102,241,.22), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }
    .stars{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.55;
      filter: blur(.2px);
      background-image:
        radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(1.5px 1.5px at 140px 80px, rgba(255,255,255,.30), transparent 60%),
        radial-gradient(1.2px 1.2px at 260px 140px, rgba(255,255,255,.25), transparent 60%),
        radial-gradient(1.8px 1.8px at 420px 60px, rgba(255,255,255,.28), transparent 60%),
        radial-gradient(1.3px 1.3px at 520px 180px, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(1.6px 1.6px at 760px 90px, rgba(255,255,255,.22), transparent 60%);
      background-size: 900px 380px;
      animation: drift 14s linear infinite;
    }
    @keyframes drift{ 0%{transform:translate3d(0,0,0)} 100%{transform:translate3d(-60px,40px,0)} }

    .app{ min-height:100%; display:flex; flex-direction:column; }
    .header{
      position:sticky; top:0; z-index:50;
      padding: 10px 12px;
      padding-top: calc(10px + env(safe-area-inset-top));
      backdrop-filter: blur(var(--blur));
      background: linear-gradient(to bottom, rgba(10,14,28,.65), rgba(10,14,28,.25));
      border-bottom:1px solid var(--line);
    }
    [data-theme="light"] .header{
      background: linear-gradient(to bottom, rgba(246,247,251,.90), rgba(246,247,251,.55));
    }
    .hrow{
      max-width: 1180px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
      row-gap: 10px;
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .mark{
      width:34px; height:34px;
      border-radius: 12px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.0) 60%),
        linear-gradient(135deg, var(--brand1), var(--brand2));
      position:relative; overflow:hidden;
    }
    .mark:after{
      content:"";
      position:absolute; inset:-10px;
      background: radial-gradient(20px 20px at 30% 40%, rgba(255,255,255,.5), transparent 65%);
      transform: rotate(18deg);
      opacity:.8;
    }
    .brand{ display:flex; flex-direction:column; line-height:1.05; }
    .brand b{ font-size: 14px; letter-spacing:.2px;}
    .brand span{ font-size: 11px; color:var(--muted);}

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color: var(--muted);
      white-space:nowrap;
    }
    .pill.hide{ display:none; }
    .onlineText{ display:flex; align-items:center; gap:6px; }
    .onlineWord{ opacity:.88; }

    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--ok);
      box-shadow: 0 0 0 6px rgba(34,197,94,.15);
    }

    .search{
      flex:1;
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      min-width: 140px;
    }
    .search input{
      width:100%;
      border:none; outline:none;
      background:transparent;
      color:var(--text);
      font-size: 14px;
    }

    .iconbtn{
      width:42px; height:42px;
      border-radius: 16px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      cursor:pointer;
      transition: transform .15s ease, background .15s ease;
      user-select:none;
    }
    .iconbtn:active{ transform: scale(.98); }
    .iconbtn:hover{ background: rgba(255,255,255,.09); }

    .btn{
      height:42px;
      padding: 0 14px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: linear-gradient(135deg, rgba(124,58,237,.35), rgba(34,211,238,.18));
      color: var(--text);
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ filter: brightness(1.04); }
    .btn:active{ transform: translateY(1px); }

    .right{ display:flex; align-items:center; gap:10px; }

    /* ====== Header responsive: luôn hiện đủ, không bị ẩn ====== */
    @media (max-width: 980px){
      .hrow{ gap: 8px; }
      .logo{ order: 1; }
      .right{ order: 2; margin-left: auto; }
      .pill{ order: 3; }
      .btn{ order: 4; }
      .search{ order: 5; flex: 1 1 100%; min-width: 0; }
    }
    @media (max-width: 520px){
      /* thu gọn nút Nạp thành icon để không tràn header */
      #topupBtn{
        width: 42px;
        padding: 0;
        justify-content: center;
        gap: 0;
        font-size: 0;
      }
      #topupBtn .ico{ width: 18px; height: 18px; }
      .search{ padding: 9px 10px; }
      .search input{ font-size: 13px; }
    }

    .view{
      width:100%;
      max-width: 1180px;
      margin: 0 auto;
      padding: 16px 12px 78px;
    }

    .pageTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 14px;
    }
    .crumb{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .crumb b{ color: var(--text); }
    .back{
      height:40px; padding:0 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:10px;
    }
    .card .hd h2{ margin:0; font-size: 16px; letter-spacing:.2px; }
    .card .hd .sub{ color:var(--muted); font-size: 12px; }
    .card .bd{ padding: 0 14px 14px; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      padding: 8px 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      cursor:pointer;
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(124,58,237,.35), rgba(34,211,238,.14));
      color: var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
    }
    @media (max-width: 720px){
      .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .brand span{ display:none; }
      /* Online pill dạng icon nhỏ trên mobile */
      .pill{ padding: 8px 10px; }
      .onlineWord{ display:none; }
    }

    .story{
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      cursor:pointer;
      transition: transform .15s ease;
    }
    .story:hover{ transform: translateY(-2px); }
    .cover{
      height: 92px;
      background:
        radial-gradient(120px 80px at 30% 20%, rgba(255,255,255,.22), transparent 60%),
        linear-gradient(135deg, rgba(124,58,237,.55), rgba(34,211,238,.22));
      position:relative;
    }
    .badge{
      position:absolute; left:10px; top:10px;
      padding: 6px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.22);
      backdrop-filter: blur(10px);
    }
    .story .meta{
      padding: 10px 10px 12px;
      display:flex; flex-direction:column; gap:6px;
    }
    .title{
      font-weight:700;
      font-size: 13px;
      line-height:1.25;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .mini{
      display:flex; gap:10px; flex-wrap:wrap;
      color: var(--muted);
      font-size: 11px;
    }
    .mini span{ display:flex; align-items:center; gap:6px; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .row{
      display:flex; gap:10px;
      padding: 10px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      align-items:center;
      cursor:pointer;
    }
    .rank{
      width:34px; height:34px;
      border-radius: 14px;
      display:grid; place-items:center;
      font-weight:800;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
    }
    .row .info{ flex:1; min-width:0; }
    .row .info b{
      display:block;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .row .info span{ color:var(--muted); font-size: 11px; }
    .kpi{ font-size: 12px; color: var(--muted); white-space:nowrap; }

    /* Drawer */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      opacity:0; pointer-events:none;
      transition: opacity .2s ease;
      z-index:80;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }
    .drawer{
      position:fixed; top:0; right:0; height:100%;
      width: 340px; max-width: 92vw;
      background: rgba(10,14,28,.75);
      backdrop-filter: blur(22px);
      border-left: 1px solid rgba(255,255,255,.14);
      transform: translateX(110%);
      transition: transform .22s ease;
      z-index:90;
      display:flex; flex-direction:column;
    }
    [data-theme="light"] .drawer{ background: rgba(246,247,251,.92); }
    .drawer.show{ transform: translateX(0%); }
    .dhd{
      padding: 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
    }
    .userbox{ display:flex; align-items:center; gap:10px; padding: 12px 14px; }
    .ava{
      width:44px; height:44px; border-radius: 18px;
      background: linear-gradient(135deg, rgba(124,58,237,.6), rgba(34,211,238,.25));
      border:1px solid rgba(255,255,255,.22);
      display:grid; place-items:center;
      font-weight:900;
    }
    .userbox b{ display:block; font-size: 14px; }
    .userbox span{ display:block; font-size: 12px; color:var(--muted); }
    .dnav{
      padding: 10px 10px 18px;
      display:flex; flex-direction:column; gap:8px;
      overflow:auto;
    }
    .navitem{
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
      user-select:none;
    }
    .navitem .left{ min-width:0; }
    .navitem .left b{ font-size: 13px; display:block; }
    .navitem .left span{ font-size: 11px; color:var(--muted); display:block; }
    .navitem:hover{ background: rgba(255,255,255,.08); }
    .navitem.danger{ border-color: rgba(239,68,68,.35); }
    .navitem.danger:hover{ background: rgba(239,68,68,.10); }

    /* Story page (full info space) */
    .storyHero{
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background:
        radial-gradient(520px 260px at 20% 0%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(420px 260px at 100% 0%, rgba(34,211,238,.22), transparent 60%),
        rgba(255,255,255,.04);
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
      overflow:hidden;
    }
    .storyHeroGrid{
      display:grid;
      grid-template-columns: 130px 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 520px){
      .storyHeroGrid{ grid-template-columns: 110px 1fr; }
    }
    .coverBig{
      width:100%;
      height: 170px;
      border-radius: 18px;
      border:1px solid var(--line);
      background:
        radial-gradient(120px 90px at 25% 25%, rgba(255,255,255,.25), transparent 60%),
        linear-gradient(135deg, rgba(124,58,237,.55), rgba(34,211,238,.20));
      position:relative;
      overflow:hidden;
    }
    .pillTag{
      display:inline-flex;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size: 11px;
      color: var(--text);
      margin-right: 6px;
      margin-top: 6px;
    }
    .heroTitle{
      font-size: 18px;
      font-weight: 900;
      margin:0;
      line-height:1.25;
    }
    .heroMeta{
      margin-top:6px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.45;
    }
    .heroActions{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .smallbtn{
      height:38px;
      padding: 0 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .smallbtn:hover{ background: rgba(255,255,255,.08); }
    .smallbtn.primary{ background: linear-gradient(135deg, rgba(124,58,237,.35), rgba(34,211,238,.12)); }
    .smallbtn.danger{ border-color: rgba(239,68,68,.35); }
    .smallbtn.danger:hover{ background: rgba(239,68,68,.10); }

    .storyLayout{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .storyLayout{ grid-template-columns: 1fr; }
    }
    .reader{
      border-radius: 22px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      overflow:hidden;
    }
    .readerTop{
      padding: 12px;
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
    }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; }
    .text{
      padding: 14px;
      line-height:1.7;
      color: rgba(255,255,255,.88);
      font-size: 14px;
      max-height: 58vh;
      overflow:auto;
      white-space: pre-wrap;
    }
    [data-theme="light"] .text{ color: rgba(10,20,40,.88); }

    .box{
      border-radius: 22px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding: 12px;
    }
    .box h3{ margin:0 0 8px; font-size: 13px; }
    .chapters{
      display:flex; flex-direction:column; gap:8px;
      max-height: 36vh;
      overflow:auto;
      padding-right: 4px;
    }
    .chapter{
      padding: 10px 10px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    .chapter.active{
      background: rgba(124,58,237,.18);
      border-color: rgba(124,58,237,.35);
    }
    .chapter span{ font-size: 12px; color: var(--muted); }

    .comment{
      padding: 10px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .comment .bubble{
      flex:1; min-width:0;
    }
    .comment .bubble b{ display:block; font-size: 12px; }
    .comment .bubble p{ margin:6px 0 0; color: var(--muted); font-size: 12px; line-height:1.5; }

    .formRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .input{
      flex:1; min-width: 160px;
      height:42px; padding:0 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
    }
    textarea.input{ height:auto; padding: 10px 12px; }
    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height:1.45;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%) translateY(20px);
      background: rgba(10,14,28,.82);
      border:1px solid rgba(255,255,255,.16);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 16px;
      backdrop-filter: blur(16px);
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 200;
      max-width: 92vw;
      font-size: 13px;
    }
    [data-theme="light"] .toast{ background: rgba(246,247,251,.95); }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }

    .ico{ width:18px; height:18px; opacity:.92; }
    .ico.muted{ opacity:.72; }
  
    /* ====== Modern sections + horizontal carousel (home) ====== */
    .hnav{
      display:none;
      gap:10px;
      align-items:center;
      padding: 8px 14px 12px;
      border-top: 1px solid rgba(255,255,255,.06);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .hnav::-webkit-scrollbar{ display:none; }
    @media (min-width: 880px){
      .hnav{ display:flex; }
    }
    .hlink{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 12px;
      color: var(--muted);
      text-decoration:none;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
      white-space: nowrap;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      cursor:pointer;
      font-size: 13px;
      font-weight: 700;
    }
    .hlink:hover{ transform: translateY(-1px); background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.1); color: var(--text); }
    .hlink.ghost{ background: rgba(255,255,255,.02); }

    .section{
      margin-top: 14px;
    }
    .sectionTop{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin: 0 0 10px;
    }
    .sectionTop h2{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .sectionTop .sub{
      margin-top: 4px;
      color: var(--muted);
      font-size: 12px;
    }
    .seeAll{
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 800;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      white-space: nowrap;
    }
    .seeAll:hover{ transform: translateY(-1px); background: rgba(255,255,255,.05); color: var(--text); }

    .hscroll{
      display:flex;
      gap: 12px;
      overflow-x:auto;
      padding: 2px 2px 10px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .hscroll::-webkit-scrollbar{ display:none; }
    .hcard{
      min-width: 160px;
      max-width: 160px;
      scroll-snap-align: start;
      border-radius: var(--radius2);
      overflow:hidden;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: 0 10px 40px rgba(0,0,0,.22);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
    }
    .hcard:hover{ transform: translateY(-2px); border-color: rgba(255,255,255,.12); }
    .hcover{
      height: 210px;
      position:relative;
      background-size: cover;
      background-position: center;
    }
    .hcover::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(to top, rgba(0,0,0,.65), rgba(0,0,0,.12), rgba(0,0,0,0));
    }
    .hbadge{
      position:absolute;
      left:10px; top:10px;
      z-index:2;
      font-size: 11px;
      font-weight: 900;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
    }
    .hcta{
      position:absolute;
      left:10px; bottom:10px;
      z-index:2;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,214,84,.9);
      color: rgba(0,0,0,.9);
      font-weight: 1000;
      font-size: 12px;
      cursor:pointer;
    }
    .hmeta{ padding: 10px 10px 12px; }
    .htitle{
      font-size: 13px;
      font-weight: 900;
      line-height: 1.25;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
      min-height: 33px;
    }
    .hmini{
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* ====== Popover (theme menu) ====== */
    .popover{
      position: fixed;
      z-index: 120;
      right: 14px;
      top: 66px;
      width: 260px;
      display:none;
      border-radius: 18px;
      background: rgba(20,20,30,.78);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .popover.show{ display:block; }
    .popTitle{
      padding: 12px 14px;
      font-weight: 1000;
      letter-spacing: .2px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .popItem{
      width:100%;
      text-align:left;
      padding: 12px 14px;
      border:0;
      background: transparent;
      color: var(--text);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap: 3px;
    }
    .popItem:hover{ background: rgba(255,255,255,.06); }
    .popMain{ font-weight: 1000; }
    .popSub{ font-size: 12px; color: var(--muted); }

    /* ====== Extra themes ====== */
    html[data-theme="sepia"]{
      --bg:#0f0b06;
      --panel: rgba(255,243,228,.08);
      --panel2: rgba(255,243,228,.12);
      --text: rgba(255,247,236,.92);
      --muted: rgba(255,235,210,.68);
      --soft: rgba(255,243,228,.14);
      --line: rgba(255,243,228,.12);
    }
    html[data-theme="amoled"]{
      --bg:#000;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --soft: rgba(255,255,255,.12);
      --line: rgba(255,255,255,.10);
    }

  </style>
</head>
<body>
  <div class="stars"></div>

  <div class="app" id="app">
    <!-- HEADER -->
    <header class="header">
      <div class="hrow">
        <div class="logo" id="goHome" title="Về trang chủ">
          <div class="mark"></div>
          <div class="brand">
            <b>Truyện Online</b>
            <span>Đọc & nghe truyện mỗi ngày</span>
          </div>
        </div>

        <div class="pill hide" id="onlinePill" title="Số người đang online">
          <span class="dot" id="onlineDot"></span>
          <span class="onlineText"><b id="onlineCount">0</b> <span class="onlineWord">online</span></span>
        </div>

        <div class="search" title="Tìm kiếm truyện">
          <svg class="ico muted" viewBox="0 0 24 24" fill="none"><path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/><path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="searchInput" placeholder="Tìm truyện, tác giả, thể loại..." autocomplete="off" />
        </div>

        <button class="btn" id="topupBtn" title="Nạp / VIP">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M4 7h16v10H4V7Z" stroke="currentColor" stroke-width="2"/><path d="M7 10h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M4 9h16" stroke="currentColor" stroke-width="2" opacity=".6"/></svg>
          Nạp
        </button>

        <div class="right">
          <div class="iconbtn" id="themeBtn" title="Chế độ sáng / tối">
            <svg class="ico" viewBox="0 0 24 24" fill="none">
              <path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12Z" stroke="currentColor" stroke-width="2"/>
              <path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l1.4 1.4M17.6 17.6 19 19M19 5l-1.4 1.4M5 19l1.4-1.4" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".65"/>
            </svg>
          </div>

          <div class="iconbtn" id="notiBtn" title="Thông báo">
            <svg class="ico" viewBox="0 0 24 24" fill="none">
              <path d="M18 8a6 6 0 1 0-12 0c0 7-3 7-3 7h18s-3 0-3-7Z" stroke="currentColor" stroke-width="2"/>
              <path d="M10 19a2 2 0 0 0 4 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>

          <div class="iconbtn" id="menuBtn" title="Menu">
            <svg class="ico" viewBox="0 0 24 24" fill="none">
              <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
</div>
      </div>

      <nav class="hnav" aria-label="Điều hướng nhanh">
        <button class="hlink ghost" id="navGenres" type="button">Thể loại</button>
        <a class="hlink" href="#/updated" data-to="#/updated">Mới cập nhật</a>
        <a class="hlink" href="#/top/day" data-to="#/top/day">Top view</a>
        <a class="hlink" href="#/completed" data-to="#/completed">Hoàn thành</a>
        <a class="hlink" href="#/vip" data-to="#/vip">Bảng giá VIP</a>
        <a class="hlink" href="#/profile" data-to="#/profile">Hồ sơ</a>
      </nav>

        
    </header>


    <!-- THEME POPOVER -->
    <div class="popover" id="themePopover" aria-hidden="true">
      <div class="popTitle">Giao diện</div>
      <button class="popItem" data-theme="dark" type="button">
        <span class="popMain">Tối</span>
        <span class="popSub">Dễ đọc, đúng tông truyện</span>
      </button>
      <button class="popItem" data-theme="light" type="button">
        <span class="popMain">Sáng</span>
        <span class="popSub">Sáng rõ, hợp ban ngày</span>
      </button>
      <button class="popItem" data-theme="sepia" type="button">
        <span class="popMain">Sepia</span>
        <span class="popSub">Nền ấm, đỡ mỏi mắt</span>
      </button>
      <button class="popItem" data-theme="amoled" type="button">
        <span class="popMain">AMOLED</span>
        <span class="popSub">Đen sâu, tiết kiệm pin</span>
      </button>
    </div>


    <!-- ROUTER VIEW -->
    <main class="view" id="view"></main>

    <!-- DRAWER -->
    <div class="overlay" id="overlay"></div>
    <div class="drawer" id="drawer">
      <div class="dhd">
        <b>Menu</b>
        <div class="iconbtn" id="closeDrawer" title="Đóng">
          <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </div>
      </div>

      <div class="userbox">
        <div class="ava" id="drawerAva">T</div>
        <div>
          <b id="drawerName">Khách</b>
          <span id="drawerEmail">Chưa đăng nhập</span>
        </div>
      </div>

      <div class="dnav">
        <div class="navitem" data-to="#/profile">
          <div class="left">
            <b>Hồ sơ cá nhân</b>
            <span>Tên • thống kê • tu vi • lực chiến</span>
          </div>
          <span>›</span>
        </div>

        <div class="navitem" data-to="#/vip">
          <div class="left">
            <b>VIP</b>
            <span>Nạp • quyền lợi • huy hiệu</span>
          </div>
          <span>›</span>
        </div>

        <div class="navitem" data-to="#/tutien">
          <div class="left">
            <b>Tu tiên</b>
            <span>Tu vi • lực chiến • nhiệm vụ</span>
          </div>
          <span>›</span>
        </div>

        <div class="navitem" data-to="#/settings">
          <div class="left">
            <b>Cài đặt</b>
            <span>Giao diện • giọng đọc • lưu dữ liệu</span>
          </div>
          <span>›</span>
        </div>

        <div class="navitem" data-to="#/reading">
          <div class="left">
            <b>Đang đọc</b>
            <span>Tiếp tục truyện gần nhất</span>
          </div>
          <span>›</span>
        </div>

        <div class="navitem" data-to="#/discover">
          <div class="left">
            <b>Khám phá ngẫu nhiên</b>
            <span>Chọn truyện ngẫu nhiên</span>
          </div>
          <span>›</span>
        </div>

        <div class="navitem" data-to="#/updated">
          <div class="left">
            <b>Mới cập nhật</b>
            <span>Truyện mới update</span>
          </div>
          <span>›</span>
        </div>

        <div class="navitem" data-to="#/completed">
          <div class="left">
            <b>Truyện hoàn thành</b>
            <span>Danh sách hoàn thành</span>
          </div>
          <span>›</span>
        </div>

        <div class="navitem" data-to="#/top/day">
          <div class="left">
            <b>Bảng xếp hạng</b>
            <span>Ngày / Tuần / Tháng</span>
          </div>
          <span>›</span>
        </div>

        <div class="navitem" id="loginBtn">
          <div class="left">
            <b id="loginLabel">Đăng nhập</b>
            <span id="loginSub">Demo (lưu local), sau gắn Firebase</span>
          </div>
          <span>›</span>
        </div>

        <div class="navitem danger" id="logoutBtn" style="display:none;">
          <div class="left">
            <b>Đăng xuất</b>
            <span>Thoát tài khoản hiện tại</span>
          </div>
          <span>!</span>
        </div>

        <div class="hint" style="padding:6px 6px 0;">
          <b>Đúng yêu cầu:</b> mỗi mục là 1 trang riêng, không còn “chồng lên nhau”.
        </div>
      </div>
    </div>

    <div class="toast" id="toast">—</div>
  </div>

  <!-- Firebase (optional): dùng để đếm online thật; nếu không cấu hình thì tự chạy demo -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>


  <script>
    /***************
     * Store
     ***************/
    const LS_KEY = "truyen_online_pages_v2";
    const now = () => Date.now();

    const defaultState = {
      theme: "dark",
      user: {
        loggedIn: false,
        uid: "guest",
        name: "Khách",
        email: "Chưa đăng nhập",
        joinedAt: now(),
        lastNameChangeAt: 0,
        stats: { storiesRead: 0, comments: 0 },
        cultivation: { tuvi: "Luyện Khí 1", lucchien: 1200 }
      },
      reading: {
        lastStoryId: null,
        progressByStory: {} // storyId: { chapterIndex, scrollTop }
      },
      follows: {},          // storyId: true
      comments: {}          // storyId: [{id, uid, name, text, createdAt}]
    };

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(defaultState);
        const s = JSON.parse(raw);
        return {
          ...structuredClone(defaultState),
          ...s,
          user: { ...structuredClone(defaultState.user), ...(s.user||{}) },
          reading: { ...structuredClone(defaultState.reading), ...(s.reading||{}) },
          follows: { ...(s.follows||{}) },
          comments: { ...(s.comments||{}) }
        };
      }catch(e){ return structuredClone(defaultState); }
    }
    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    let state = loadState();

    function normalizeState(){
      state.readerPrefs ??= { fontSize: 18, lineHeight: 1.8, maxWidth: 820, ttsRate: 1.15 };
      state.reading ??= {};
      state.reading.progressByStory ??= {};
      state.reading.completed ??= {}; // storyId -> { [chapterIndex]: true }
      for(const sid of Object.keys(state.reading.progressByStory)){
        const p = state.reading.progressByStory[sid] || {};
        if(typeof p.chapterIndex !== "number") p.chapterIndex = 0;
        if(!p.scrollByChapter){
          p.scrollByChapter = {};
          if(typeof p.scrollTop === "number"){
            p.scrollByChapter[p.chapterIndex] = p.scrollTop;
            delete p.scrollTop;
          }
        }
        state.reading.progressByStory[sid] = p;
      }
    }
    normalizeState();


    /****************
     * Demo Data
     ****************/
    function lorem(seed){
      const p = [
        "Gió đêm thổi qua mái ngói, ánh đèn trong ngõ nhỏ lay động như có linh khí.",
        "Hắn mở mắt, trong lòng như có tiếng chuông vang lên: con đường tu hành bắt đầu từ hôm nay.",
        "Bên ngoài thành, mưa rơi lộp bộp, từng giọt như rửa sạch máu trên lưỡi kiếm.",
        "Người đời chỉ thấy kết quả, nhưng không biết phía sau là vô số lần gục ngã và đứng dậy.",
        "Một tia linh quang lóe lên, hệ thống đáp xuống như định mệnh đã sắp đặt.",
        "Nếu muốn vượt qua thiên đạo, trước tiên phải thắng chính mình."
      ];
      let out = "";
      for(let i=0;i<8;i++) out += p[(seed+i)%p.length] + " ";
      out += "\n\n" + "—".repeat(22) + "\n\n";
      for(let i=0;i<9;i++) out += p[(seed+i+3)%p.length] + " ";
      return out.trim();
    }

    const stories = [
      { id:"t1", title:"Vô Cực Đạo Giới: Khai Thiên", author:"Thiên Ngoại Khách", tags:["Tu Tiên","Huyền Huyễn"], status:"Đang ra", updatedAt:"Hôm nay",
        desc:"Thiên đạo rạn nứt, khí vận hỗn loạn. Một thiếu niên bình thường vô tình mở ra con đường 'khai thiên' để đối kháng vận mệnh.",
        views:{ day: 18400, week: 95300, month: 412000 },
        chapters:[ {name:"Chương 1: Thiên Đạo Tàn Khuyết", text:lorem(1)}, {name:"Chương 2: Linh Căn Thức Tỉnh", text:lorem(2)}, {name:"Chương 3: Nhập Môn", text:lorem(3)} ]
      },
      { id:"t2", title:"Trảm Thần: Đêm Mưa Trên Thành", author:"Hắc Vũ", tags:["Kiếm Hiệp","Dị Năng"], status:"Hoàn thành", updatedAt:"2 ngày trước",
        desc:"Một đêm mưa, thành thị chìm trong bí ẩn. Lưỡi kiếm vô danh chém mở màn cuộc săn thần giữa nhân gian.",
        views:{ day: 9200, week: 60800, month: 210000 },
        chapters:[ {name:"Chương 1: Lời Thề", text:lorem(4)}, {name:"Chương 2: Mũi Kiếm", text:lorem(5)} ]
      },
      { id:"t3", title:"Ta Ở Dị Giới Nuôi Linh Thú", author:"Mộc Dương", tags:["Hài","Tu Tiên"], status:"Đang ra", updatedAt:"Hôm qua",
        desc:"Xuyên không, mở trang trại linh thú và vô tình trở thành đại lão. Hài hước + tu luyện + hệ thống.",
        views:{ day: 12200, week: 70200, month: 298000 },
        chapters:[ {name:"Chương 1: Trứng Linh Thú", text:lorem(6)}, {name:"Chương 2: Hệ Thống", text:lorem(7)}, {name:"Chương 3: Thôn Nhỏ", text:lorem(8)}, {name:"Chương 4: Thử Nghiệm", text:lorem(9)} ]
      },
      { id:"t4", title:"Bắc Vực Thiên Tôn", author:"Lam Vân", tags:["Huyền Huyễn","Nhiệt Huyết"], status:"Đang ra", updatedAt:"3 giờ trước",
        desc:"Bắc Vực băng hàn, tôn giả xuất thế. Một dấu ấn thiên tôn làm rung chuyển vạn giới.",
        views:{ day: 15800, week: 81500, month: 356000 },
        chapters:[ {name:"Chương 1: Vực Bắc", text:lorem(10)}, {name:"Chương 2: Thiên Tôn Ấn", text:lorem(11)} ]
      },
      { id:"t5", title:"Tân Thần Y: Quy Thành", author:"Bạch Y", tags:["Đô Thị","Y Thuật"], status:"Hoàn thành", updatedAt:"1 tuần trước",
        desc:"Trở về sau biến cố, thần y tái xuất. Y thuật cứu người, cũng là con đường tu tâm.",
        views:{ day: 6100, week: 40200, month: 188000 },
        chapters:[ {name:"Chương 1: Trở Về", text:lorem(12)} ]
      },
      { id:"t6", title:"Tuyết Lạc Trường An", author:"Tiêu Dao", tags:["Cổ Đại","Ngôn Tình"], status:"Đang ra", updatedAt:"Mới cập nhật",
        desc:"Trường An tuyết rơi, một cuộc gặp gỡ đổi thay nhân sinh. Dịu dàng nhưng đầy sóng gió.",
        views:{ day: 7400, week: 48800, month: 160000 },
        chapters:[ {name:"Chương 1: Tuyết", text:lorem(13)}, {name:"Chương 2: Gặp Gỡ", text:lorem(14)} ]
      }
    ];

    /****************
     * Helpers
     ****************/
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    function escapeHtml(str){
      return (str||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
    }
    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=> t.classList.remove("show"), 2200);
    }
    function formatNum(n){ return new Intl.NumberFormat("vi-VN").format(n); }
    function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
    function daysBetween(ts){ return Math.max(0, Math.floor((now()-ts)/(1000*60*60*24))); }
    function initials(name){
      const s = (name||"T").trim().split(/\s+/);
      const a = (s[0]||"T")[0] || "T";
      const b = (s.length>1 ? s[s.length-1][0] : "") || "";
      return (a+b).toUpperCase();
    }
    function storyBadge(s){
      if((s.status||"").toLowerCase().includes("hoàn")) return "Hoàn thành";
      return "Mới";
    }

    /****************
     * Theme
     ****************/
    function applyTheme(){
      const allowed = ["dark","light","sepia","amoled"];
      if(!allowed.includes(state.theme)) state.theme = "dark";
      document.documentElement.setAttribute("data-theme", state.theme);
      saveState();
    }

        /****************
     * Online (Firebase realtime + fallback demo)
     * - Nếu bạn cấu hình Firebase RTDB, pill online sẽ hiện khi có người đang online thật.
     * - Nếu chưa cấu hình / bị chặn CDN (content://), hệ thống tự chạy số demo để không bị trống.
     ****************/
    // DÁN firebaseConfig (có databaseURL) vào đây hoặc set window.FIREBASE_CONFIG trước khi load trang.
    // Ví dụ:
    // window.FIREBASE_CONFIG = { apiKey:"...", authDomain:"...", databaseURL:"https://xxx.asia-southeast1.firebasedatabase.app", projectId:"...", ... };
    const FIREBASE_CONFIG = window.FIREBASE_CONFIG || null;

    const __clamp = (n,a,b)=> Math.max(a, Math.min(b,n));
    const __randId = (p="v") => p + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);

    function updateOnlineUI(count){
      const pill = document.getElementById("onlinePill");
      const countEl = document.getElementById("onlineCount");
      if(!pill || !countEl) return;
      const c = Math.max(0, Number(count)||0);
      countEl.textContent = c;
      if(c > 0) pill.classList.remove("hide");
      else pill.classList.add("hide"); // đúng yêu cầu: chỉ hiện khi có người online
    }

    function initOnlineFirebase(){
      try{
        // Firebase CDN compat phải load được
        if(!window.firebase || typeof firebase.initializeApp !== "function") return false;
        if(!FIREBASE_CONFIG || !FIREBASE_CONFIG.databaseURL) return false;

        if(!firebase.apps || firebase.apps.length === 0) firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.database();

        // UID theo session để tính “đang online” cho cả khách
        const ssKey = "to_presence_uid_v1";
        let uid = sessionStorage.getItem(ssKey) || state.user?.uid || null;
        if(!uid || uid === "guest"){
          uid = __randId("guest");
          sessionStorage.setItem(ssKey, uid);
          // đồng bộ vào state để các chỗ khác dùng
          state.user.uid = uid;
          saveState();
        }

        const presenceRoot = db.ref("presence");
        const meRef = presenceRoot.child(uid);

        // Khi có kết nối: set online + đảm bảo tự xóa khi rời trang / mất mạng
        db.ref(".info/connected").on("value", (snap)=>{
          if(snap.val() === false) return;
          meRef.onDisconnect().remove();
          meRef.set({
            uid,
            name: (state.user?.name || "Khách"),
            at: firebase.database.ServerValue.TIMESTAMP
          });
        });

        // Cập nhật tên/heartbeat định kỳ (giữ kết nối, tránh bị “treo” trên vài thiết bị)
        setInterval(()=>{
          try{
            meRef.update({
              name: (state.user?.name || "Khách"),
              last: firebase.database.ServerValue.TIMESTAMP
            });
          }catch(_){}
        }, 30000);

        // Đếm online: số key trong /presence
        presenceRoot.on("value", (snap)=>{
          const val = snap.val() || {};
          updateOnlineUI(Object.keys(val).length);
        });

        return true;
      }catch(e){
        console.warn("Online Firebase init failed:", e);
        return false;
      }
    }

    function initOnlineFallbackDemo(){
      // Demo: luôn >0 để pill hiện (trong trường hợp bạn mở file local / chặn CDN)
      function setOnlineDemo(){
        const seed = (state.user?.uid || "guest").split("").reduce((a,c)=>a+c.charCodeAt(0), 0);
        const base = 120 + (seed % 80);
        const wave = Math.round(40 * Math.sin(Date.now()/15000));
        updateOnlineUI(__clamp(base + wave, 80, 420));
      }
      setOnlineDemo();
      setInterval(setOnlineDemo, 1500);
    }

    // Khởi động online
    updateOnlineUI(0);
    const __onlineOk = initOnlineFirebase();
    if(!__onlineOk) initOnlineFallbackDemo();


    /****************
     * Drawer
     ****************/
    function openDrawer(){
      $("#overlay").classList.add("show");
      $("#drawer").classList.add("show");
    }
    function closeDrawer(){
      $("#overlay").classList.remove("show");
      $("#drawer").classList.remove("show");
    }

    /****************
     * TTS
     ****************/
    let speaking = false;
    function canTTS(){ return "speechSynthesis" in window && "SpeechSynthesisUtterance" in window; }
    function speak(text, opts={}){
      try{
        if(!("speechSynthesis" in window)){ toast("Thiết bị không hỗ trợ TTS."); return; }
        stopTTS();
        const rate = clamp(Number(opts.rate ?? state.readerPrefs?.ttsRate ?? 1.15), 0.6, 2.5);
        const lang = opts.lang || "vi-VN";
        // chunk text to avoid very long utterances
        const chunks = String(text||"")
          .replace(/\s+/g," ")
          .split(/(?<=[\.\!\?\n])\s+/)
          .filter(Boolean);
        let i = 0;
        speaking = true;

        const speakNext = ()=>{
          if(i >= chunks.length){ speaking = false; return; }
          const u = new SpeechSynthesisUtterance(chunks[i++]);
          u.lang = lang;
          u.rate = rate;
          u.onend = ()=> speakNext();
          u.onerror = ()=> { speaking = false; };
          window.speechSynthesis.speak(u);
        };
        speakNext();
      }catch(e){
        speaking = false;
        console.error(e);
      }
    }
function stopTTS(){
      if(canTTS()) window.speechSynthesis.cancel();
      speaking = false;
    }

    /****************
     * Auth (demo)
     ****************/
    function demoLogin(){
      const name = prompt("Nhập tên hiển thị:", state.user.name === "Khách" ? "" : state.user.name) || "";
      if(!name.trim()) return;
      const email = prompt("Nhập email (demo):", "user@example.com") || "user@example.com";
      state.user.loggedIn = true;
      state.user.uid = "u_" + Math.random().toString(16).slice(2);
      state.user.name = name.trim();
      state.user.email = email.trim();
      if(!state.user.joinedAt) state.user.joinedAt = now();
      saveState();
      syncUserUI();
      toast("Đăng nhập thành công (demo).");
      location.hash = "#/profile";
    }
    function logout(){
      if(!confirm("Bạn chắc chắn muốn đăng xuất?")) return;
      state.user = structuredClone(defaultState.user);
      saveState();
      syncUserUI();
      toast("Đã đăng xuất.");
      location.hash = "#/home";
    }
    function syncUserUI(){
      const u = state.user;
      $("#drawerName").textContent = u.name || "Khách";
      $("#drawerEmail").textContent = u.loggedIn ? (u.email || "") : "Chưa đăng nhập";
      $("#drawerAva").textContent = initials(u.name || "T");
      $("#logoutBtn").style.display = u.loggedIn ? "" : "none";
      $("#loginLabel").textContent = u.loggedIn ? "Tài khoản" : "Đăng nhập";
      $("#loginSub").textContent = u.loggedIn ? "Xem hồ sơ • tu vi • đổi tên" : "Demo (lưu local), sau gắn Firebase";
    }

    /****************
     * Profile: change name every 7 days
     ****************/
    function nameCooldownRemaining(){
      const last = state.user.lastNameChangeAt || 0;
      if(!last) return 0;
      const diffDays = Math.floor((now() - last) / (1000*60*60*24));
      return Math.max(0, 7 - diffDays);
    }
    function saveName(newName){
      newName = (newName||"").trim();
      if(newName.length < 2){ toast("Tên quá ngắn."); return false; }
      const remain = nameCooldownRemaining();
      if(remain > 0){ toast(`Chưa thể đổi tên. Còn ${remain} ngày.`); return false; }
      state.user.name = newName;
      state.user.lastNameChangeAt = now();
      saveState();
      syncUserUI();
      toast("Đổi tên thành công!");
      return true;
    }

    /****************
     * Cultivation demo
     ****************/
    function markRead(){
      state.user.stats.storiesRead = (state.user.stats.storiesRead||0) + 1;
      state.user.cultivation.lucchien = (state.user.cultivation.lucchien||1200) + 120;
      const n = state.user.stats.storiesRead;
      const level = 1 + Math.floor(n / 3);
      state.user.cultivation.tuvi = `Luyện Khí ${clamp(level, 1, 10)}`;
      saveState();
      toast("Đã ghi nhận! +Tu vi +Lực chiến (demo)");
    }

    /****************
     * Follow
     ****************/
    function isFollowed(storyId){ return !!state.follows[storyId]; }
    function toggleFollow(storyId){
      if(isFollowed(storyId)) delete state.follows[storyId];
      else state.follows[storyId] = true;
      saveState();
    }

    /****************
     * Comments (demo)
     ****************/
    function getComments(storyId){
      state.comments[storyId] ??= [];
      return state.comments[storyId];
    }
    function addComment(storyId, text){
      text = (text||"").trim();
      if(text.length < 2){ toast("Bình luận quá ngắn."); return false; }
      const u = state.user;
      const c = {
        id: "c_"+Math.random().toString(16).slice(2),
        uid: u.uid,
        name: u.name || "Khách",
        text,
        createdAt: now()
      };
      state.comments[storyId] ??= [];
      state.comments[storyId].unshift(c);
      state.user.stats.comments = (state.user.stats.comments||0) + 1;
      saveState();
      toast("Đã gửi bình luận (demo).");
      return true;
    }
    function timeAgo(ts){
      const s = Math.floor((now()-ts)/1000);
      if(s < 60) return "vừa xong";
      const m = Math.floor(s/60);
      if(m < 60) return m+" phút trước";
      const h = Math.floor(m/60);
      if(h < 24) return h+" giờ trước";
      const d = Math.floor(h/24);
      return d+" ngày trước";
    }

    /****************
     * Router
     ****************/
    function parseRoute(){
      const raw = (location.hash || "#/home").replace(/^#/, "");
      const parts = raw.split("/").filter(Boolean);
      const page = parts[0] || "home";
      const p1 = parts[1] || null;
      const p2 = parts[2] || null;
      return { page, p1, p2, raw };
    }
    function nav(to){
      location.hash = to.startsWith("#") ? to : ("#"+to);
    }

    /****************
     * Shared render helpers
     ****************/
    function renderStoryGrid(list, container){
      container.innerHTML = "";
      if(list.length === 0){
        container.innerHTML = `<div style="grid-column:1/-1; padding:18px; color:var(--muted)">Không có dữ liệu.</div>`;
        return;
      }
      container.innerHTML = list.map(s => `
        <div class="story" data-story="${s.id}">
          <div class="cover"><div class="badge">${storyBadge(s)}</div></div>
          <div class="meta">
            <div class="title">${escapeHtml(s.title)}</div>
            <div class="mini">
              <span>👤 ${escapeHtml(s.author)}</span>
              <span>👁️ ${formatNum(s.views.month)} /tháng</span>
              <span>⏱️ ${escapeHtml(s.updatedAt)}</span>
            </div>
          </div>
        </div>
      `).join("");
      $$(".story", container).forEach(el=>{
        el.addEventListener("click", ()=> nav(`#/story/${el.dataset.story}`));
      });
    }


    function coverGradient(key){
      // deterministic gradient from id/title
      let h = 0;
      for(let i=0;i<key.length;i++) h = (h*31 + key.charCodeAt(i)) >>> 0;
      const a = 160 + (h % 70);
      const b = 40 + (h % 60);
      const c = 190 + ((h>>>8) % 50);
      const d = 50 + ((h>>>16) % 80);
      return `linear-gradient(135deg, rgba(${a},${b},${c},.45), rgba(${d},${a%255},${b%255},.12)), radial-gradient(1200px 500px at 20% 10%, rgba(255,214,84,.25), transparent 60%), radial-gradient(900px 500px at 80% 30%, rgba(142,110,255,.22), transparent 60%)`;
    }

    function renderStoryRow(list, container, { ctaLabel="Đọc tiếp", max=10 } = {}){
      container.innerHTML = "";
      const arr = (list||[]).slice(0, max);
      if(arr.length === 0){
        container.innerHTML = `<div style="padding:14px; color:var(--muted)">Chưa có dữ liệu.</div>`;
        return;
      }
      container.innerHTML = arr.map(s => `
        <div class="hcard" data-story="${s.id}">
          <div class="hcover" style="background-image:${coverGradient(s.id + s.title)}">
            <div class="hbadge">${storyBadge(s)}</div>
            <button class="hcta" type="button">${ctaLabel}</button>
          </div>
          <div class="hmeta">
            <div class="htitle">${escapeHtml(s.title)}</div>
            <div class="hmini">
              <span>👤 ${escapeHtml(s.author)}</span>
              <span>👁️ ${formatNum(s.views.month)} /tháng</span>
            </div>
          </div>
        </div>
      `).join("");

      $$(".hcard", container).forEach(el=>{
        const sid = el.dataset.story;
        el.addEventListener("click", ()=> nav(`#/story/${sid}`));
        const btn = el.querySelector(".hcta");
        if(btn){
          btn.addEventListener("click", (e)=>{ e.stopPropagation(); nav(`#/story/${sid}`); });
        }
      });
    }


    function filteredStoriesBySearch(q){
      q = (q||"").trim().toLowerCase();
      let arr = stories.slice();
      if(q){
        arr = arr.filter(s =>
          s.title.toLowerCase().includes(q) ||
          s.author.toLowerCase().includes(q) ||
          s.tags.join(" ").toLowerCase().includes(q)
        );
      }
      return arr;
    }

    /****************
     * Pages
     ****************/
    function renderHome(){
      const view = $("#view");
      const q = $("#searchInput").value || "";
      const arr = filteredStoriesBySearch(q);

      // Build "Đang đọc" row: last read + followed, fallback to top month
      const readingIds = [];
      if(state.reading.lastStoryId) readingIds.push(state.reading.lastStoryId);
      Object.keys(state.follows||{}).forEach(id=>{
        if(!readingIds.includes(id)) readingIds.push(id);
      });
      let readingList = readingIds.map(id=> arr.find(s=>s.id===id)).filter(Boolean);
      if(readingList.length < 4){
        const filler = arr.slice().sort((a,b)=> (b.views.month||0)-(a.views.month||0));
        filler.forEach(s=>{
          if(readingList.length >= 10) return;
          if(!readingList.find(x=>x.id===s.id)) readingList.push(s);
        });
      }

      // Discover row: random
      const shuffled = arr.slice().sort(()=> Math.random()-0.5);
      const discoverList = shuffled.slice(0, 10);

      // Featured grid
      const featured = arr.slice().sort((a,b)=> (b.views.month||0)-(a.views.month||0)).slice(0,6);

      view.innerHTML = `
        <div class="pageTop">
          <div class="crumb"><b>Trang chủ</b> <span>• Giao diện hiện đại + không gian riêng</span></div>
        </div>

        <div class="section">
          <div class="sectionTop">
            <div>
              <h2>⏱️ Đang đọc</h2>
              <div class="sub">Kéo ngang để xem thêm • bấm “Đọc tiếp” để vào truyện</div>
            </div>
            <button class="seeAll" data-to="#/reading" type="button">Xem tất cả →</button>
          </div>
          <div class="hscroll" id="homeReadingRow"></div>
        </div>

        <div class="section">
          <div class="sectionTop">
            <div>
              <h2>🎲 Khám phá ngẫu nhiên</h2>
              <div class="sub">Gợi ý ngẫu nhiên để đổi “khẩu vị”</div>
            </div>
            <button class="seeAll" data-to="#/discover" type="button">Thử vận may →</button>
          </div>
          <div class="hscroll" id="homeDiscoverRow"></div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>Truyện nổi bật</h2>
              <div class="sub">Gợi ý từ top tháng</div>
            </div>
            <div class="tabs">
              <div class="tab active">Danh sách</div>
              <div class="tab" data-to="#/updated">Mới cập nhật</div>
              <div class="tab" data-to="#/completed">Hoàn thành</div>
              <div class="tab" data-to="#/top/month">Top tháng</div>
            </div>
          </div>
          <div class="bd">
            <div class="grid" id="homeGrid"></div>
          </div>
        </div>
      `;

      // Bind nav buttons inside home
      $$(".tab[data-to], .seeAll[data-to]", view).forEach(t=>{
        t.addEventListener("click", ()=> nav(t.dataset.to));
      });

      renderStoryRow(readingList, $("#homeReadingRow"), { ctaLabel: "Đọc tiếp", max: 12 });
      renderStoryRow(discoverList, $("#homeDiscoverRow"), { ctaLabel: "Đọc thử", max: 12 });

      renderStoryGrid(featured, $("#homeGrid"));
    }


    function renderReading(){
      const view = $("#view");
      const id = state.reading.lastStoryId || stories[0].id;
      const s = stories.find(x=>x.id===id);

      view.innerHTML = `
        <div class="pageTop">
          <div class="crumb"><b>Đang đọc</b><span>• Không gian riêng</span></div>
          <button class="back" id="goBack">← Quay lại</button>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>Tiếp tục</h2>
              <div class="sub">${s ? "Truyện gần nhất của bạn" : "Chưa có tiến độ"}</div>
            </div>
          </div>
          <div class="bd" style="padding-top:12px">
            ${s ? `
              <div class="row" id="resumeRow">
                <div class="rank">▶</div>
                <div class="info">
                  <b>${escapeHtml(s.title)}</b>
                  <span>Chạm để vào trang truyện • lưu tiến độ tự động</span>
                </div>
                <div class="kpi">→</div>
              </div>
            ` : `<div style="color:var(--muted); padding:10px">Chưa có truyện đang đọc.</div>`}
          </div>
        </div>
      `;
      $("#goBack").addEventListener("click", ()=> history.back());
      if(s) $("#resumeRow").addEventListener("click", ()=> nav(`#/story/${s.id}`));
    }

    function renderDiscover(){
      const view = $("#view");
      const pick = stories[Math.floor(Math.random()*stories.length)];
      view.innerHTML = `
        <div class="pageTop">
          <div class="crumb"><b>Khám phá ngẫu nhiên</b><span>• Không gian riêng</span></div>
          <button class="back" id="goBack">← Quay lại</button>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>Gợi ý ngẫu nhiên</h2>
              <div class="sub">Bấm đổi để lấy truyện khác</div>
            </div>
            <div class="tabs">
              <div class="tab" id="btnReroll">Đổi truyện</div>
            </div>
          </div>
          <div class="bd">
            <div class="grid" id="discoverGrid"></div>
          </div>
        </div>
      `;
      $("#goBack").addEventListener("click", ()=> history.back());
      $("#btnReroll").addEventListener("click", ()=> renderDiscover());
      renderStoryGrid([pick], $("#discoverGrid"));
    }

    function renderUpdated(){
      const view = $("#view");
      const q = $("#searchInput").value || "";
      const arr = filteredStoriesBySearch(q);

      const priority = (s) => {
        const t = (s.updatedAt||"").toLowerCase();
        if(t.includes("hôm nay") || t.includes("mới") || t.includes("giờ")) return 0;
        if(t.includes("hôm qua")) return 1;
        if(t.includes("ngày")) return 2;
        if(t.includes("tuần")) return 3;
        return 9;
      };
      const list = arr.slice().sort((a,b)=> priority(a)-priority(b));

      view.innerHTML = `
        <div class="pageTop">
          <div class="crumb"><b>Mới cập nhật</b><span>• Không gian riêng</span></div>
          <button class="back" id="goBack">← Quay lại</button>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>Danh sách mới cập nhật</h2>
              <div class="sub">Sắp xếp theo “độ mới” (demo)</div>
            </div>
          </div>
          <div class="bd">
            <div class="grid" id="updatedGrid"></div>
          </div>
        </div>
      `;
      $("#goBack").addEventListener("click", ()=> history.back());
      renderStoryGrid(list, $("#updatedGrid"));
    }

    function renderCompleted(){
      const view = $("#view");
      const q = $("#searchInput").value || "";
      const arr = filteredStoriesBySearch(q);
      const list = arr.filter(s=> (s.status||"").toLowerCase().includes("hoàn"));

      view.innerHTML = `
        <div class="pageTop">
          <div class="crumb"><b>Truyện hoàn thành</b><span>• Không gian riêng</span></div>
          <button class="back" id="goBack">← Quay lại</button>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>Danh sách hoàn thành</h2>
              <div class="sub">Chỉ hiển thị truyện đã hoàn thành</div>
            </div>
          </div>
          <div class="bd">
            <div class="grid" id="completedGrid"></div>
          </div>
        </div>
      `;
      $("#goBack").addEventListener("click", ()=> history.back());
      renderStoryGrid(list, $("#completedGrid"));
    }

    function renderTop(mode){
      mode = mode || "day";
      const view = $("#view");
      const q = $("#searchInput").value || "";
      const arr = filteredStoriesBySearch(q);

      const title = mode==="day" ? "Top ngày" : mode==="week" ? "Top tuần" : "Top tháng";
      const list = arr.slice().sort((a,b)=> (b.views[mode]||0)-(a.views[mode]||0)).slice(0, 20);

      view.innerHTML = `
        <div class="pageTop">
          <div class="crumb"><b>Bảng xếp hạng</b> <span>• ${title} • Không gian riêng</span></div>
          <button class="back" id="goBack">← Quay lại</button>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>${title}</h2>
              <div class="sub">Xếp theo lượt xem ${mode==="day"?"ngày":mode==="week"?"tuần":"tháng"} (demo)</div>
            </div>
            <div class="tabs">
              <div class="tab ${mode==="day"?"active":""}" data-to="#/top/day">Ngày</div>
              <div class="tab ${mode==="week"?"active":""}" data-to="#/top/week">Tuần</div>
              <div class="tab ${mode==="month"?"active":""}" data-to="#/top/month">Tháng</div>
            </div>
          </div>
          <div class="bd" style="padding-top:12px">
            <div class="list" id="topList"></div>
          </div>
        </div>
      `;

      $("#goBack").addEventListener("click", ()=> history.back());
      $$(".tab[data-to]", view).forEach(t=> t.addEventListener("click", ()=> nav(t.dataset.to)));

      const wrap = $("#topList");
      wrap.innerHTML = list.map((s,i)=>`
        <div class="row" data-story="${s.id}">
          <div class="rank">${i+1}</div>
          <div class="info">
            <b>${escapeHtml(s.title)}</b>
            <span>${escapeHtml(s.author)} • ${escapeHtml(s.status)}</span>
          </div>
          <div class="kpi">👁️ ${formatNum(s.views[mode])}</div>
        </div>
      `).join("");
      $$(".row", wrap).forEach(r=>{
        r.addEventListener("click", ()=> nav(`#/story/${r.dataset.story}`));
      });
    }

    
function getStoryOrNull(storyId){
      return stories.find(x=>x.id===storyId) || null;
    }
    function getChapterOrNull(story, chapterIndex){
      if(!story) return null;
      chapterIndex = Number(chapterIndex);
      if(!Number.isFinite(chapterIndex)) chapterIndex = 0;
      chapterIndex = clamp(chapterIndex, 0, story.chapters.length-1);
      return { chapter: story.chapters[chapterIndex], chapterIndex };
    }
    function ensureProgress(storyId){
      state.reading.lastStoryId = storyId;
      state.reading.progressByStory[storyId] ??= { chapterIndex: 0, scrollByChapter: {} };
      saveState();
      return state.reading.progressByStory[storyId];
    }

    /****************
     * Story detail (không gian riêng)
     ****************/
    function renderStory(storyId){
      const s = getStoryOrNull(storyId);
      const view = $("#view");
      if(!s){
        view.innerHTML = `
          <div class="pageTop">
            <div class="crumb"><b>Không tìm thấy truyện</b></div>
            <button class="back" id="goBack">← Quay lại</button>
          </div>
          <div class="card"><div class="bd" style="padding:16px;color:var(--muted)">Truyện không tồn tại.</div></div>
        `;
        $("#goBack").addEventListener("click", ()=> history.back());
        return;
      }

      const prog = ensureProgress(s.id);
      const lastIdx = clamp(prog.chapterIndex ?? 0, 0, s.chapters.length-1);
      const lastCh = s.chapters[lastIdx];
      const followed = isFollowed(s.id);

      // related stories: same first tag
      const tag0 = s.tags?.[0];
      const related = tag0 ? stories.filter(x=>x.id!==s.id && (x.tags||[]).includes(tag0)).slice(0,4) : [];

      view.innerHTML = `
        <div class="pageTop">
          <div class="crumb">
            <span style="opacity:.8">Trang chủ</span> <span style="opacity:.7">›</span> <b>${escapeHtml(s.title)}</b>
            <span>• Không gian riêng</span>
          </div>
          <button class="back" id="goBack">← Quay lại</button>
        </div>

        <div class="storyHero">
          <div class="coverBig" style="background-image:${coverGradient(s.id + s.title)}"></div>
          <div class="heroMeta">
            <div class="heroTop">
              <div>
                <div class="heroTitle">${escapeHtml(s.title)}</div>
                <div class="heroMini">
                  <span>👤 ${escapeHtml(s.author)}</span>
                  <span>🏷️ ${(s.tags||[]).slice(0,3).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join("")}</span>
                  <span>⏱️ ${escapeHtml(s.updatedAt||"")}</span>
                </div>
              </div>
              <div class="heroActions">
                <button class="smallbtn ${followed ? "" : "primary"}" id="btnFollow">${followed ? "✓ Đang theo dõi" : "+ Theo dõi"}</button>
                <button class="smallbtn" id="btnShare">⤴ Chia sẻ</button>
              </div>
            </div>

            <div class="heroDesc">${escapeHtml(s.desc||"")}</div>

            <div class="heroPrimary">
              <button class="bigbtn primary" id="btnReadContinue">📖 Đọc tiếp</button>
              <button class="bigbtn" id="btnListenContinue">🎧 Nghe tiếp</button>
              <div class="hint" style="margin:0">
                Tiếp tục: <b>${escapeHtml(lastCh.name)}</b> • Chương ${lastIdx+1}/${s.chapters.length}
              </div>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <div class="hd">
              <div>
                <h2>Danh sách chương</h2>
                <div class="sub">Bấm chương để đọc • giữ lâu để nghe (hoặc bấm nút Nghe)</div>
              </div>
              <div class="tabs">
                <div class="tab" id="btnGoTop">Về đầu</div>
              </div>
            </div>
            <div class="bd">
              <div class="chapList" id="chapList"></div>
            </div>
          </div>

          <div class="card">
            <div class="hd">
              <div>
                <h2>Gợi ý cùng thể loại</h2>
                <div class="sub">${tag0 ? `Cùng tag “${escapeHtml(tag0)}”` : "Ngẫu nhiên"}</div>
              </div>
            </div>
            <div class="bd">
              <div class="grid" id="relatedGrid"></div>
              <div style="height:10px"></div>
              <div class="box">
                <h3>Mẹo đọc nhanh</h3>
                <div class="hint" style="margin-top:0">
                  Bạn có thể chỉnh <b>cỡ chữ</b>, <b>line-height</b>, <b>tốc độ TTS</b> trong trang đọc/nghe (Sprint 1).
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      $("#goBack").addEventListener("click", ()=> history.back());
      $("#btnReadContinue").addEventListener("click", ()=> nav(`#/read/${s.id}/${lastIdx}`));
      $("#btnListenContinue").addEventListener("click", ()=> nav(`#/listen/${s.id}/${lastIdx}`));
      $("#btnFollow").addEventListener("click", ()=>{
        toggleFollow(s.id);
        renderStory(s.id);
        toast(isFollowed(s.id) ? "Đã theo dõi." : "Đã bỏ theo dõi.");
      });
      $("#btnShare").addEventListener("click", async ()=>{
        const url = location.origin + location.pathname + `#/story/${s.id}`;
        try{
          if(navigator.share) await navigator.share({ title: s.title, text: s.desc || s.title, url });
          else { await navigator.clipboard.writeText(url); toast("Đã copy link."); }
        }catch(e){
          try{ await navigator.clipboard.writeText(url); toast("Đã copy link."); }catch(_){ toast("Không thể chia sẻ trên thiết bị này."); }
        }
      });

      const chapList = $("#chapList");
      chapList.innerHTML = s.chapters.map((c, idx)=>{
        const done = !!(state.reading.completed?.[s.id]?.[idx]);
        return `
          <div class="chapItem" data-idx="${idx}">
            <div class="left">
              <b>${escapeHtml(c.name)}</b>
              <span>Chương ${idx+1} ${done ? "• ✅ đã đọc" : ""}</span>
            </div>
            <div class="right">
              <button class="smallbtn" data-act="read">Đọc</button>
              <button class="smallbtn" data-act="listen">Nghe</button>
            </div>
          </div>
        `;
      }).join("");

      $$(".chapItem", chapList).forEach(row=>{
        const idx = Number(row.dataset.idx);
        row.addEventListener("click", (e)=>{
          const btn = e.target.closest("button");
          if(btn){
            const act = btn.dataset.act;
            if(act==="listen") nav(`#/listen/${s.id}/${idx}`);
            else nav(`#/read/${s.id}/${idx}`);
            return;
          }
          nav(`#/read/${s.id}/${idx}`);
        });

        // long-press to listen (mobile-friendly)
        let pressTimer = null;
        row.addEventListener("touchstart", ()=>{
          pressTimer = setTimeout(()=> nav(`#/listen/${s.id}/${idx}`), 420);
        }, {passive:true});
        row.addEventListener("touchend", ()=>{ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } }, {passive:true});
      });

      $("#btnGoTop").addEventListener("click", ()=>{
        chapList.scrollTop = 0;
      });

      renderStoryGrid(related.length ? related : stories.slice().sort(()=>Math.random()-0.5).slice(0,4), $("#relatedGrid"));
    }

    /****************
     * Reader (Trang đọc chương)
     ****************/
    function clampPrefs(){
      state.readerPrefs.fontSize = clamp(Number(state.readerPrefs.fontSize||18), 12, 34);
      state.readerPrefs.lineHeight = clamp(Number(state.readerPrefs.lineHeight||1.8), 1.2, 2.6);
      state.readerPrefs.maxWidth = clamp(Number(state.readerPrefs.maxWidth||820), 520, 1100);
      state.readerPrefs.ttsRate = clamp(Number(state.readerPrefs.ttsRate||1.15), 0.6, 2.5);
      saveState();
    }

    function renderReader(storyId, chapterIndex){
      const s = getStoryOrNull(storyId);
      const view = $("#view");
      if(!s){ renderNotFound(); return; }

      const prog = ensureProgress(s.id);
      const info = getChapterOrNull(s, chapterIndex);
      const idx = info.chapterIndex;
      const c = info.chapter;

      prog.chapterIndex = idx;
      saveState();

      // restore scroll for this chapter
      prog.scrollByChapter ??= {};
      const savedScroll = Number(prog.scrollByChapter[idx] || 0);

      const pct = Math.round(((idx+1)/s.chapters.length)*100);

      clampPrefs();

      view.innerHTML = `
        <div class="pageTop">
          <div class="crumb">
            <span style="opacity:.8">${escapeHtml(s.title)}</span> <span style="opacity:.7">›</span>
            <b>${escapeHtml(c.name)}</b>
            <span>• Đọc chương</span>
          </div>
          <button class="back" id="goStory">← Truyện</button>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>${escapeHtml(c.name)}</h2>
              <div class="sub">Tiến độ: ${pct}% • Chương ${idx+1}/${s.chapters.length}</div>
            </div>
            <div class="tabs">
              <div class="tab" id="btnPrefs">Cỡ chữ</div>
              <div class="tab" id="btnMarkDone">Đã đọc xong</div>
            </div>
          </div>

          <div class="bd">
            <div class="readerBar">
              <div class="controls">
                <button class="smallbtn" id="btnPrev">‹ Trước</button>
                <button class="smallbtn primary" id="btnTTS">🔊 TTS</button>
                <button class="smallbtn" id="btnStop">■ Dừng</button>
                <button class="smallbtn" id="btnNext">Sau ›</button>
              </div>
              <div class="controls">
                <button class="smallbtn" id="fsMinus">A−</button>
                <button class="smallbtn" id="fsPlus">A+</button>
                <button class="smallbtn" id="lhMinus">LH−</button>
                <button class="smallbtn" id="lhPlus">LH+</button>
                <button class="smallbtn" id="rateMinus">x−</button>
                <button class="smallbtn" id="ratePlus">x+</button>
              </div>
            </div>

            <div class="textWrap" id="textWrap">
              <div class="text2" id="readerText"></div>
            </div>

            <div class="hint">
              Mẹo: Lướt đến cuối chương sẽ tự lưu vị trí. Bạn có thể tăng tốc TTS (x+/x−). 
            </div>
          </div>
        </div>
      `;

      $("#goStory").addEventListener("click", ()=> nav(`#/story/${s.id}`));

      const wrap = $("#textWrap");
      const textEl = $("#readerText");
      textEl.textContent = c.text || "";

      function applyPrefs(){
        clampPrefs();
        textEl.style.fontSize = state.readerPrefs.fontSize + "px";
        textEl.style.lineHeight = state.readerPrefs.lineHeight;
        wrap.style.maxWidth = state.readerPrefs.maxWidth + "px";
      }
      applyPrefs();

      requestAnimationFrame(()=> { wrap.scrollTop = savedScroll; });

      // save scroll
      wrap.addEventListener("scroll", ()=>{
        prog.scrollByChapter[idx] = wrap.scrollTop;
        saveState();
      }, {passive:true});

      function goTo(newIdx){
        stopTTS();
        newIdx = clamp(newIdx, 0, s.chapters.length-1);
        prog.chapterIndex = newIdx;
        saveState();
        nav(`#/read/${s.id}/${newIdx}`);
      }

      $("#btnPrev").addEventListener("click", ()=> goTo(idx-1));
      $("#btnNext").addEventListener("click", ()=> goTo(idx+1));

      $("#btnTTS").addEventListener("click", ()=>{
        if(speaking){ toast("Đang đọc... bấm Dừng để ngắt."); return; }
        clampPrefs();
        speak(`${s.title}. ${c.name}. ${c.text}`, { rate: state.readerPrefs.ttsRate });
        toast(`Bắt đầu TTS (x${state.readerPrefs.ttsRate.toFixed(2)})`);
      });
      $("#btnStop").addEventListener("click", ()=>{ stopTTS(); toast("Đã dừng."); });

      $("#fsMinus").addEventListener("click", ()=>{ state.readerPrefs.fontSize -= 1; applyPrefs(); });
      $("#fsPlus").addEventListener("click", ()=>{ state.readerPrefs.fontSize += 1; applyPrefs(); });
      $("#lhMinus").addEventListener("click", ()=>{ state.readerPrefs.lineHeight = (Number(state.readerPrefs.lineHeight)||1.8) - 0.1; applyPrefs(); });
      $("#lhPlus").addEventListener("click", ()=>{ state.readerPrefs.lineHeight = (Number(state.readerPrefs.lineHeight)||1.8) + 0.1; applyPrefs(); });
      $("#rateMinus").addEventListener("click", ()=>{ state.readerPrefs.ttsRate = (Number(state.readerPrefs.ttsRate)||1.15) - 0.1; applyPrefs(); toast(`TTS x${state.readerPrefs.ttsRate.toFixed(2)}`); });
      $("#ratePlus").addEventListener("click", ()=>{ state.readerPrefs.ttsRate = (Number(state.readerPrefs.ttsRate)||1.15) + 0.1; applyPrefs(); toast(`TTS x${state.readerPrefs.ttsRate.toFixed(2)}`); });

      $("#btnPrefs").addEventListener("click", ()=>{
        toast(`Cỡ chữ: ${state.readerPrefs.fontSize}px • LH: ${Number(state.readerPrefs.lineHeight).toFixed(2)} • TTS: x${Number(state.readerPrefs.ttsRate).toFixed(2)}`);
      });

      $("#btnMarkDone").addEventListener("click", ()=>{
        state.reading.completed[s.id] ??= {};
        if(!state.reading.completed[s.id][idx]){
          state.reading.completed[s.id][idx] = true;
          saveState();
          toast("✅ Đã đánh dấu đã đọc xong chương.");
          // optional: game hook (demo)
          state.user.stats.storiesRead = (state.user.stats.storiesRead||0) + 1;
          saveState();
        }else{
          toast("Chương này đã được đánh dấu trước đó.");
        }
      });
    }

    /****************
     * Listen (Nghe truyện)
     ****************/
    function renderListen(storyId, chapterIndex){
      const s = getStoryOrNull(storyId);
      const view = $("#view");
      if(!s){ renderNotFound(); return; }

      const prog = ensureProgress(s.id);
      const info = getChapterOrNull(s, chapterIndex);
      const idx = info.chapterIndex;
      const c = info.chapter;

      prog.chapterIndex = idx;
      saveState();

      clampPrefs();

      const audioUrl = c.audioUrl || ""; // nếu bạn lưu Storage: chapters[].audioUrl
      view.innerHTML = `
        <div class="pageTop">
          <div class="crumb">
            <span style="opacity:.8">${escapeHtml(s.title)}</span> <span style="opacity:.7">›</span>
            <b>${escapeHtml(c.name)}</b>
            <span>• Nghe chương</span>
          </div>
          <button class="back" id="goStory">← Truyện</button>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>🎧 ${escapeHtml(c.name)}</h2>
              <div class="sub">Chương ${idx+1}/${s.chapters.length} • Ưu tiên audioUrl, không có thì dùng TTS</div>
            </div>
            <div class="tabs">
              <div class="tab" id="btnReadPage">Mở trang đọc</div>
            </div>
          </div>

          <div class="bd">
            <div class="box">
              <h3>Audio theo chương</h3>
              ${audioUrl ? `
                <audio id="audioPlayer" controls preload="metadata" style="width:100%">
                  <source src="${escapeHtml(audioUrl)}" />
                </audio>
              ` : `
                <div class="hint" style="margin-top:0">Chương này chưa có <b>audioUrl</b>. Bạn có thể dùng TTS bên dưới.</div>
              `}
            </div>

            <div style="height:12px"></div>

            <div class="box">
              <h3>TTS đọc chữ</h3>
              <div class="formRow" style="gap:10px; flex-wrap:wrap">
                <button class="smallbtn primary" id="btnTTS">🔊 Bắt đầu TTS</button>
                <button class="smallbtn" id="btnStop">■ Dừng</button>
                <button class="smallbtn" id="rateMinus">x−</button>
                <button class="smallbtn" id="ratePlus">x+</button>
                <span class="hint" id="rateInfo" style="margin:0; padding:0">Tốc độ: x${Number(state.readerPrefs.ttsRate).toFixed(2)}</span>
              </div>
              <div class="hint">TTS sẽ đọc nội dung chương hiện tại. Trên Android, đôi khi cần bật tiếng Việt trong “Text-to-speech output”.</div>
            </div>

            <div style="height:12px"></div>

            <div class="readerBar">
              <div class="controls">
                <button class="smallbtn" id="btnPrev">‹ Trước</button>
                <button class="smallbtn" id="btnNext">Sau ›</button>
              </div>
            </div>
          </div>
        </div>
      `;

      $("#goStory").addEventListener("click", ()=> nav(`#/story/${s.id}`));
      $("#btnReadPage").addEventListener("click", ()=> nav(`#/read/${s.id}/${idx}`));

      function goTo(newIdx){
        stopTTS();
        newIdx = clamp(newIdx, 0, s.chapters.length-1);
        prog.chapterIndex = newIdx;
        saveState();
        nav(`#/listen/${s.id}/${newIdx}`);
      }
      $("#btnPrev").addEventListener("click", ()=> goTo(idx-1));
      $("#btnNext").addEventListener("click", ()=> goTo(idx+1));

      const rateInfo = $("#rateInfo");
      const updateRate = ()=>{
        clampPrefs();
        rateInfo.textContent = `Tốc độ: x${Number(state.readerPrefs.ttsRate).toFixed(2)}`;
      };
      updateRate();

      $("#rateMinus").addEventListener("click", ()=>{ state.readerPrefs.ttsRate -= 0.1; updateRate(); toast(rateInfo.textContent); });
      $("#ratePlus").addEventListener("click", ()=>{ state.readerPrefs.ttsRate += 0.1; updateRate(); toast(rateInfo.textContent); });

      $("#btnTTS").addEventListener("click", ()=>{
        if(speaking){ toast("Đang đọc... bấm Dừng để ngắt."); return; }
        speak(`${s.title}. ${c.name}. ${c.text}`, { rate: state.readerPrefs.ttsRate });
        toast(`Bắt đầu TTS (x${state.readerPrefs.ttsRate.toFixed(2)})`);
      });
      $("#btnStop").addEventListener("click", ()=>{ stopTTS(); toast("Đã dừng."); });
    }


    function renderProfile(){
      const u = state.user;
      const remain = nameCooldownRemaining();
      $("#view").innerHTML = `
        <div class="pageTop">
          <div class="crumb"><b>Hồ sơ cá nhân</b><span>• Không gian riêng</span></div>
          <button class="back" id="goBack">← Quay lại</button>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>Thông tin tài khoản</h2>
              <div class="sub">Tên • số ngày tham gia • số truyện đã đọc • số bình luận • tu vi • lực chiến</div>
            </div>
          </div>
          <div class="bd" style="padding-top:14px">
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
              <div class="ava">${initials(u.name)}</div>
              <div>
                <div style="font-weight:900; font-size:16px">${escapeHtml(u.name)}</div>
                <div style="color:var(--muted); font-size:12px">${u.loggedIn ? escapeHtml(u.email) : "Chưa đăng nhập"}</div>
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="box">
              <h3>Thống kê</h3>
              <div class="hint" style="margin-top:0">
                <b>Số ngày tham gia:</b> ${daysBetween(u.joinedAt)} ngày<br>
                <b>Số truyện đã đọc:</b> ${u.stats?.storiesRead||0}<br>
                <b>Số bình luận:</b> ${u.stats?.comments||0}
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="box">
              <h3>Tu vi & Lực chiến</h3>
              <div class="hint" style="margin-top:0">
                <b>Tu vi hiện tại:</b> ${escapeHtml(u.cultivation?.tuvi||"Luyện Khí 1")}<br>
                <b>Lực chiến:</b> ${formatNum(u.cultivation?.lucchien||1200)}
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="box">
              <h3>Đổi tên</h3>
              <div class="formRow">
                <input class="input" id="nameInput" value="${escapeHtml(u.name)}" placeholder="Đổi tên (mỗi 7 ngày)" />
                <button class="smallbtn primary" id="saveNameBtn">Lưu</button>
              </div>
              <div class="hint" id="nameHint">${remain>0 ? `Bạn còn <b>${remain}</b> ngày nữa mới đổi tên được.` : "Bạn có thể đổi tên mỗi 7 ngày."}</div>
            </div>
          </div>
        </div>
      `;
      $("#goBack").addEventListener("click", ()=> history.back());
      $("#saveNameBtn").addEventListener("click", ()=>{
        const ok = saveName($("#nameInput").value);
        if(ok) renderProfile();
      });
    }

    function renderVip(){
      $("#view").innerHTML = `
        <div class="pageTop">
          <div class="crumb"><b>VIP / Nạp</b><span>• Không gian riêng</span></div>
          <button class="back" id="goBack">← Quay lại</button>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>VIP / Nạp</h2>
              <div class="sub">Nạp • quyền lợi • huy hiệu</div>
            </div>
          </div>
          <div class="bd" style="padding-top:14px">
            <div class="box">
              <h3>Gợi ý triển khai</h3>
              <div class="hint" style="margin-top:0">
                • Tạo gói VIP: Tháng / Quý / Năm.<br>
                • Quyền lợi: tắt quảng cáo, tốc độ load nhanh, huy hiệu, quà tu vi.<br>
                • Khi làm “online thật”: thanh toán nên xác thực bằng webhook server (chống giả mạo).<br>
              </div>
              <div style="height:10px"></div>
              <button class="smallbtn primary" id="goTutien">Xem Tu tiên</button>
            </div>
          </div>
        </div>
      `;
      $("#goBack").addEventListener("click", ()=> history.back());
      $("#goTutien").addEventListener("click", ()=> nav("#/tutien"));
    }

    function renderTutien(){
      const c = state.user.cultivation;
      $("#view").innerHTML = `
        <div class="pageTop">
          <div class="crumb"><b>Tu tiên</b><span>• Không gian riêng</span></div>
          <button class="back" id="goBack">← Quay lại</button>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>Tu luyện</h2>
              <div class="sub">Tu vi • lực chiến • nhiệm vụ (khung)</div>
            </div>
          </div>
          <div class="bd" style="padding-top:14px">
            <div class="box">
              <h3>Trạng thái hiện tại</h3>
              <div class="hint" style="margin-top:0">
                <b>Tu vi:</b> ${escapeHtml(c.tuvi)}<br>
                <b>Lực chiến:</b> ${formatNum(c.lucchien)}
              </div>
              <div style="height:10px"></div>
              <div class="formRow">
                <button class="smallbtn" id="btnPlus">+ Tu vi (demo)</button>
                <button class="smallbtn" id="btnBackStory">Quay lại truyện đang đọc</button>
              </div>
              <div class="hint">Gợi ý: đọc chương/nghe chương → +EXP tu luyện, nhiệm vụ ngày/tuần, boss/pvp…</div>
            </div>
          </div>
        </div>
      `;
      $("#goBack").addEventListener("click", ()=> history.back());
      $("#btnPlus").addEventListener("click", ()=>{
        markRead();
        renderTutien();
      });
      $("#btnBackStory").addEventListener("click", ()=>{
        const id = state.reading.lastStoryId || stories[0].id;
        nav(`#/story/${id}`);
      });
    }

    function renderSettings(){
      $("#view").innerHTML = `
        <div class="pageTop">
          <div class="crumb"><b>Cài đặt</b><span>• Không gian riêng</span></div>
          <button class="back" id="goBack">← Quay lại</button>
        </div>

        <div class="card">
          <div class="hd">
            <div>
              <h2>Cài đặt</h2>
              <div class="sub">Giao diện • giọng đọc • lưu dữ liệu</div>
            </div>
          </div>
          <div class="bd" style="padding-top:14px">
            <div class="box">
              <h3>Giao diện</h3>
              <div class="formRow">
                <button class="smallbtn" id="toggleTheme">Đổi Dark/Light</button>
              </div>
              <div class="hint">Bạn cũng có thể đổi bằng nút trên header.</div>
            </div>

            <div style="height:12px"></div>

            <div class="box">
              <h3>Giọng đọc (TTS)</h3>
              <div class="hint" style="margin-top:0">
                • Dùng Web Speech API. Một số máy sẽ có nhiều giọng hơn.<br>
                • Nếu muốn “audio thật”: bạn có thể lưu mp3 theo chương và phát bằng audio tag.
              </div>
            </div>

            <div style="height:12px"></div>

            <div class="box">
              <h3>Lưu dữ liệu</h3>
              <div class="hint" style="margin-top:0">
                • Hiện tại: LocalStorage (offline).<br>
                • Khi online thật: gắn Firebase Auth + Database/Firestore để sync lịch sử đọc, theo dõi, bình luận.
              </div>
            </div>
          </div>
        </div>
      `;
      $("#goBack").addEventListener("click", ()=> history.back());
      $("#toggleTheme").addEventListener("click", ()=>{
        state.theme = state.theme === "light" ? "dark" : "light";
        applyTheme();
        toast(state.theme === "light" ? "Chế độ sáng" : "Chế độ tối");
      });
    }

    function renderNotFound(){
      $("#view").innerHTML = `
        <div class="card">
          <div class="bd" style="padding:16px;color:var(--muted)">
            Không tìm thấy trang. Quay về <a href="#/home" style="color:inherit">Trang chủ</a>.
          </div>
        </div>
      `;
    }

    function render(){
      stopTTS();
      const { page, p1 } = parseRoute();

      // search active on listing pages
      const allowSearch = ["home","updated","completed","top"].includes(page);
      $("#searchInput").disabled = !allowSearch;
      $("#searchInput").style.opacity = allowSearch ? "1" : ".55";
      $("#searchInput").style.pointerEvents = allowSearch ? "auto" : "none";
      if(!allowSearch) $("#searchInput").value = "";

      if(page === "home") renderHome();
      else if(page === "reading") renderReading();
      else if(page === "discover") renderDiscover();
      else if(page === "updated") renderUpdated();
      else if(page === "completed") renderCompleted();
      else if(page === "top") renderTop(p1 || "day");
      else if(page === "story") renderStory(p1);
      else if(page === "read") renderReader(p1, p2);
      else if(page === "listen") renderListen(p1, p2);
      else if(page === "profile") renderProfile();
      else if(page === "vip") renderVip();
      else if(page === "tutien") renderTutien();
      else if(page === "settings") renderSettings();
      else renderNotFound();
    }

    /****************
     * Header events
     ****************/
    $("#menuBtn").addEventListener("click", openDrawer);
    $("#closeDrawer").addEventListener("click", closeDrawer);
    $("#overlay").addEventListener("click", closeDrawer);

    
    function positionPopover(){
      const pop = $("#themePopover");
      const btn = $("#themeBtn");
      if(!pop || !btn) return;
      const r = btn.getBoundingClientRect();
      const w = pop.offsetWidth || 260;
      const top = Math.min(window.innerHeight - 12 - pop.offsetHeight, Math.max(56, r.bottom + 10));
      let left = r.right - w;
      left = Math.max(12, Math.min(left, window.innerWidth - 12 - w));
      pop.style.top = top + "px";
      pop.style.left = left + "px";
      pop.style.right = "auto";
    }
    function openThemePopover(){
      const pop = $("#themePopover");
      pop.classList.add("show");
      pop.setAttribute("aria-hidden","false");
      positionPopover();
    }
    function closeThemePopover(){
      const pop = $("#themePopover");
      pop.classList.remove("show");
      pop.setAttribute("aria-hidden","true");
    }
    function toggleThemePopover(){
      const pop = $("#themePopover");
      pop.classList.contains("show") ? closeThemePopover() : openThemePopover();
    }
    function setTheme(theme){
      state.theme = theme;
      applyTheme();
      const map = { dark:"Giao diện tối", light:"Giao diện sáng", sepia:"Giao diện Sepia", amoled:"Giao diện AMOLED" };
      toast(map[theme] || "Đã đổi giao diện");
      closeThemePopover();
    }

    $("#themeBtn").addEventListener("click", (e)=>{
      e.stopPropagation();
      toggleThemePopover();
    });
    window.addEventListener("resize", ()=>{ if($("#themePopover").classList.contains("show")) positionPopover(); });
    document.addEventListener("click", (e)=>{
      const pop = $("#themePopover");
      if(!pop.classList.contains("show")) return;
      if(e.target.closest("#themePopover") || e.target.closest("#themeBtn")) return;
      closeThemePopover();
    });
    $$("#themePopover .popItem").forEach(b=>{
      b.addEventListener("click", ()=> setTheme(b.dataset.theme));
    });

$("#notiBtn").addEventListener("click", ()=> toast("Thông báo (demo): Chưa có thông báo mới."));

    // Desktop nav bar (under header)
    $("#navGenres")?.addEventListener("click", ()=>{
      openDrawer();
      setTimeout(()=>{ $("#genreFilter")?.scrollIntoView?.({behavior:"smooth", block:"center"}); }, 80);
    });
    $$(".hnav [data-to]").forEach(a=>{
      a.addEventListener("click", (e)=>{ e.preventDefault(); nav(a.dataset.to); });
    });

    $("#topupBtn").addEventListener("click", ()=> nav("#/vip"));
    $("#goHome").addEventListener("click", ()=> nav("#/home"));

    $("#searchInput").addEventListener("input", ()=>{
      if(["home","updated","completed","top"].includes(parseRoute().page)) render();
    });

    // drawer nav
    $$("#drawer .navitem[data-to]").forEach(item=>{
      item.addEventListener("click", ()=>{
        closeDrawer();
        nav(item.dataset.to);
      });
    });

    $("#loginBtn").addEventListener("click", ()=>{
      closeDrawer();
      if(state.user.loggedIn) nav("#/profile");
      else demoLogin();
    });

    $("#logoutBtn").addEventListener("click", ()=>{
      closeDrawer();
      logout();
    });

    /****************
     * Init
     ****************/
    function init(){
      applyTheme();
      syncUserUI();
      // Online được khởi động ở phần Online (Firebase realtime)

      if(!location.hash) location.hash = "#/home";
      window.addEventListener("hashchange", render);
      render();
    }
    init();
  </script>
</body>
</html>
