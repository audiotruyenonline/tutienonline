<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tu Ti√™n Online ‚Äî GitHub Edition</title>
  <style>
    :root{
      --bg1:#0b0f1a; --bg2:#16002a; --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10); --txt:#fff; --mut:#b9c0ff;
      --a:#7c3aed; --b:#06b6d4; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--txt);
      background:radial-gradient(1200px 800px at 20% 10%, #1d1140 0%, transparent 60%),
                 radial-gradient(1000px 700px at 80% 20%, #072a3b 0%, transparent 60%),
                 linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:5;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.35); backdrop-filter: blur(10px);
    }
    .brand{display:flex; flex-direction:column; gap:2px}
    .brand b{font-size:14px}
    .brand small{color:var(--mut); font-size:12px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:0; cursor:pointer; color:white; font-weight:700;
      padding:10px 12px; border-radius:12px;
      background:linear-gradient(90deg,var(--a),var(--b));
      box-shadow:0 10px 22px rgba(0,0,0,.25);
    }
    .btn.secondary{background:rgba(255,255,255,.10); box-shadow:none}
    .btn.danger{background:rgba(239,68,68,.25)}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .wrap{max-width:1100px; margin:0 auto; padding:14px}
    .grid{display:grid; grid-template-columns: 360px 1fr; gap:12px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      box-shadow:0 12px 26px rgba(0,0,0,.25);
    }
    .card h3{margin:0 0 10px 0; font-size:14px; color:#e7e7ff}
    .kv{display:grid; grid-template-columns: 1fr auto; gap:6px; font-size:13px}
    .kv span{color:var(--mut)}
    .kv b{font-weight:800}
    .pill{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(0,0,0,.25); font-size:12px; color:var(--mut)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{padding:9px 10px; border-radius:12px; border:1px solid var(--line); background:rgba(0,0,0,.2);
      cursor:pointer; font-weight:700; color:#dfe2ff; font-size:13px}
    .tab.active{background:linear-gradient(90deg,rgba(124,58,237,.45),rgba(6,182,212,.35))}
    .list{display:flex; flex-direction:column; gap:8px}
    .item{display:flex; justify-content:space-between; gap:10px; padding:10px; border-radius:14px;
      border:1px solid var(--line); background:rgba(0,0,0,.22)}
    .mut{color:var(--mut); font-size:12px}
    input,select{
      width:100%; padding:10px 10px; border-radius:12px;
      border:1px solid var(--line); background:rgba(0,0,0,.25); color:#fff; outline:none;
    }
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .log{font-family:ui-monospace,Menlo,Consolas,monospace; font-size:12px; color:#dbeafe;
      max-height:160px; overflow:auto; background:rgba(0,0,0,.35); border:1px solid var(--line);
      border-radius:12px; padding:10px; white-space:pre-wrap}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .hr{height:1px; background:var(--line); margin:10px 0}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <b>Tu Ti√™n Online</b>
    <small>GitHub Pages + Firebase ‚Äî MVP</small>
  </div>
  <div class="row">
    <span id="who" class="pill">Ch∆∞a ƒëƒÉng nh·∫≠p</span>
    <button id="btnLogin" class="btn">ƒêƒÉng nh·∫≠p Google</button>
    <button id="btnLogout" class="btn secondary" disabled>ƒêƒÉng xu·∫•t</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h3>H·ªì s∆°</h3>
      <div class="kv">
        <span>T√™n</span><b id="pName">-</b>
        <span>Tu vi</span><b id="pCult">-</b>
        <span>C·∫•p</span><b id="pRealm">-</b>
        <span>L·ª±c chi·∫øn</span><b id="pPower">-</b>
        <span>Linh th·∫°ch</span><b id="pStone">-</b>
        <span>VIP</span><b id="pVip">-</b>
        <span>Map hi·ªán t·∫°i</span><b id="pMap">-</b>
      </div>

      <div class="hr"></div>

      <div class="two">
        <button id="btnTrain" class="btn secondary" disabled>Tu luy·ªán +Tu vi</button>
        <button id="btnClaimDaily" class="btn secondary" disabled>Nh·∫≠n online</button>
      </div>

      <div class="hr"></div>

      <h3>N·∫°p VIP (QR + Code)</h3>
      <div class="mut">Ng∆∞·ªùi ch∆°i chuy·ªÉn kho·∫£n theo QR c·ªßa b·∫°n v√† nh·∫≠p <b>CODE</b> v√†o ƒë√¢y. H·ªá th·ªëng t·∫°o ‚Äúphi·∫øu n·∫°p‚Äù <b>pending</b> ƒë·ªÉ b·∫°n duy·ªát th·ªß c√¥ng.</div>
      <div style="height:8px"></div>
      <div class="two">
        <input id="topupCode" placeholder="CODE chuy·ªÉn kho·∫£n (vd: MSU123)" />
        <select id="vipPack">
          <option value="VIP1">VIP1</option>
          <option value="VIP2">VIP2</option>
          <option value="VIP3">VIP3</option>
          <option value="VIP4">VIP4</option>
          <option value="VIP5">VIP5</option>
        </select>
      </div>
      <div style="height:8px"></div>
      <button id="btnTopup" class="btn secondary" disabled>T·∫°o phi·∫øu n·∫°p</button>
      <div class="mut">* B·∫°n c√≥ th·ªÉ thay QR + h∆∞·ªõng d·∫´n ·ªü m·ª•c ‚ÄúC·∫•u h√¨nh‚Äù trong code.</div>

      <div class="hr"></div>

      <h3>Nh·∫≠t k√Ω</h3>
      <div id="log" class="log">Ch∆∞a c√≥.</div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="adventure">C√†y qu√°i</button>
        <button class="tab" data-tab="inventory">Trang b·ªã</button>
        <button class="tab" data-tab="pvp">PvP</button>
        <button class="tab" data-tab="guild">Bang h·ªôi</button>
        <button class="tab" data-tab="leaderboard">Top server</button>
      </div>

      <div class="hr"></div>

      <!-- Adventure -->
      <section id="tab-adventure">
        <h3>Map & Boss</h3>
        <div class="two">
          <select id="mapSelect"></select>
          <select id="mobSelect"></select>
        </div>
        <div style="height:10px"></div>
        <div class="two">
          <button id="btnFight" class="btn" disabled>ƒê√°nh qu√°i</button>
          <button id="btnBoss" class="btn secondary" disabled>ƒê√°nh boss</button>
        </div>
        <div class="mut" style="margin-top:10px">
          VIP tƒÉng t·ªëc: +% tu vi, +% t·ª∑ l·ªá r∆°i ƒë·ªì (ƒëang set trong config).
        </div>
      </section>

      <!-- Inventory -->
      <section id="tab-inventory" style="display:none">
        <h3>Kho ƒë·ªì</h3>
        <div id="invList" class="list"></div>
        <div class="hr"></div>
        <h3>ƒêang trang b·ªã</h3>
        <div id="equipBox" class="list"></div>
      </section>

      <!-- PvP -->
      <section id="tab-pvp" style="display:none">
        <h3>PvP</h3>
        <div class="mut">MVP: gh√©p ng·∫´u nhi√™n 1 ƒë·ªëi th·ªß trong server, t√≠nh th·∫Øng/thua theo l·ª±c chi·∫øn + ch√∫t random, c·∫≠p nh·∫≠t ELO.</div>
        <div style="height:10px"></div>
        <button id="btnMatch" class="btn" disabled>T√¨m ƒë·ªëi th·ªß</button>
        <div style="height:10px"></div>
        <div id="pvpBox" class="list"></div>
      </section>

      <!-- Guild -->
      <section id="tab-guild" style="display:none">
        <h3>Bang h·ªôi</h3>
        <div class="two">
          <input id="guildName" placeholder="T√™n bang (t·∫°o m·ªõi)" />
          <button id="btnCreateGuild" class="btn secondary" disabled>T·∫°o bang</button>
        </div>
        <div style="height:10px"></div>
        <div class="two">
          <input id="guildJoinId" placeholder="ID bang ƒë·ªÉ xin v√†o" />
          <button id="btnJoinGuild" class="btn secondary" disabled>Xin v√†o</button>
        </div>
        <div class="hr"></div>
        <div id="guildBox" class="list"></div>
      </section>

      <!-- Leaderboard -->
      <section id="tab-leaderboard" style="display:none">
        <h3>Top server</h3>
        <div class="two">
          <button id="btnTopPower" class="btn secondary" disabled>Top l·ª±c chi·∫øn</button>
          <button id="btnTopCult" class="btn secondary" disabled>Top tu vi</button>
        </div>
        <div style="height:10px"></div>
        <div id="topBox" class="list"></div>
      </section>
    </div>
  </div>
</div>

<script type="module">
  // ========= 0) CONFIG =========
  // TODO: D√°n firebaseConfig c·ªßa b·∫°n v√†o ƒë√¢y
  const firebaseConfig = {
    apiKey: "PASTE_HERE",
    authDomain: "PASTE_HERE",
    projectId: "PASTE_HERE",
    storageBucket: "PASTE_HERE",
    messagingSenderId: "PASTE_HERE",
    appId: "PASTE_HERE"
  };

  // Game balance (b·∫°n ch·ªânh ·ªü ƒë√¢y)
  const GAME = {
    realms: [
      { name:"Ph√†m Nh√¢n", need:0 },
      { name:"Luy·ªán Kh√≠", need:200 },
      { name:"Tr√∫c C∆°", need:900 },
      { name:"Kim ƒêan", need:2600 },
      { name:"Nguy√™n Anh", need:6000 },
      { name:"H√≥a Th·∫ßn", need:12000 },
      { name:"Luy·ªán H∆∞", need:22000 },
      { name:"H·ª£p Th·ªÉ", need:38000 },
      { name:"ƒê·∫°i Th·ª´a", need:60000 }
    ],
    vip: {
      NONE:{ cultMult:1.0, dropBonus:0.00 },
      VIP1:{ cultMult:1.10, dropBonus:0.03 },
      VIP2:{ cultMult:1.20, dropBonus:0.06 },
      VIP3:{ cultMult:1.35, dropBonus:0.10 },
      VIP4:{ cultMult:1.55, dropBonus:0.15 },
      VIP5:{ cultMult:1.85, dropBonus:0.22 },
    },
    maps: [
      {
        id:"map_1", name:"Thanh V√¢n S∆°n",
        mobs:[
          { id:"m1", name:"S√≥i U Minh", hp:80, atk:10, cult:60, stone:8, dropTable:[
            { item:"Ki·∫øm G·ªó", type:"weapon", power:10, rate:0.10 },
            { item:"Gi√°p V·∫£i", type:"armor", power:8, rate:0.10 },
            { item:"Linh ƒêan Nh·ªè", type:"consumable", power:0, rate:0.20 },
          ]},
          { id:"m2", name:"Y√™u Th·ª≠", hp:100, atk:12, cult:80, stone:10, dropTable:[
            { item:"Ki·∫øm S·∫Øt", type:"weapon", power:14, rate:0.08 },
            { item:"Nh·∫´n T·ª• Linh", type:"ring", power:9, rate:0.06 },
          ]},
        ],
        boss:{ id:"b1", name:"H·∫Øc H·ªï V∆∞∆°ng", hp:260, atk:22, cult:260, stone:40, dropTable:[
          { item:"H·ªï Nha ƒêao", type:"weapon", power:26, rate:0.15 },
          { item:"√Åo Gi√°p H·∫Øc H·ªï", type:"armor", power:22, rate:0.12 },
          { item:"Ng·ªçc Ph√π H·ªô Th√¢n", type:"amulet", power:18, rate:0.10 },
        ]}
      },
      {
        id:"map_2", name:"Huy·∫øt ƒê·∫ßm C·ªï ƒê·ªãa",
        mobs:[
          { id:"m3", name:"Huy·∫øt Linh", hp:150, atk:18, cult:140, stone:16, dropTable:[
            { item:"Huy·∫øt Ki·∫øm", type:"weapon", power:22, rate:0.08 },
            { item:"Gi√†y ·∫¢nh B·ªô", type:"boots", power:15, rate:0.06 },
          ]},
        ],
        boss:{ id:"b2", name:"C·ªï Thi V∆∞∆°ng", hp:420, atk:32, cult:500, stone:85, dropTable:[
          { item:"C·ªët ƒêao", type:"weapon", power:38, rate:0.12 },
          { item:"Gi√°p C·ªët", type:"armor", power:32, rate:0.10 },
          { item:"T·ª• Linh Ch√¢u", type:"amulet", power:28, rate:0.08 },
        ]}
      }
    ],
    onlineReward: { stone: 10, everySec: 300 }, // 5 ph√∫t
    train: { cult: 70, cooldownSec: 20 }, // 20s/l·∫ßn (MVP)
    bossCooldownSec: 90,
  };

  // QR info (b·∫°n thay b·∫±ng text/·∫£nh sau)
  const PAYMENT = {
    bankName: "Ng√¢n h√†ng c·ªßa b·∫°n",
    note: "Chuy·ªÉn kho·∫£n theo QR + nh·∫≠p CODE ·ªü √¥ n·∫°p. B·∫°n s·∫Ω duy·ªát th·ªß c√¥ng trong Firestore."
  };

  // ========= 1) Firebase imports =========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
    collection, addDoc, query, where, getDocs, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  let app, auth, db, user=null, profile=null;

  // ========= 2) UI helpers =========
  const $ = (id)=>document.getElementById(id);
  const logBox = $("log");
  function log(msg, cls=""){
    const line = `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    logBox.textContent = (logBox.textContent==="Ch∆∞a c√≥.") ? line : (line + logBox.textContent);
  }
  function fmt(n){ return Math.floor(Number(n||0)).toLocaleString("vi-VN"); }
  function realmOf(cult){
    let r = GAME.realms[0].name;
    for(const it of GAME.realms){ if(cult >= it.need) r = it.name; }
    return r;
  }
  function calcPower(p){
    const base = 50;
    const eq = p.equip || {};
    const inv = p.inventory || {};
    const eqPower = Object.values(eq).reduce((a,x)=>a+(x?.power||0),0);
    const realmBonus = Math.floor((p.cult||0) / 200); // MVP
    return base + eqPower + realmBonus;
  }
  function vipBuff(vip){ return GAME.vip[vip] || GAME.vip.NONE; }

  // ========= 3) Game data shape =========
  function defaultProfile(u){
    return {
      uid:u.uid,
      name: u.displayName || "Tu sƒ© v√¥ danh",
      cult: 0,
      stone: 0,
      vip: "NONE",
      mapId: GAME.maps[0].id,
      inventory: {}, // key -> {name,type,power,qty}
      equip: { weapon:null, armor:null, ring:null, amulet:null, boots:null },
      lastTrainAt: 0,
      lastOnlineClaimAt: 0,
      lastBossAt: 0,
      elo: 1000,
      guildId: null,
      updatedAt: serverTimestamp(),
      createdAt: serverTimestamp()
    };
  }

  // ========= 4) Init =========
  function initFirebase(){
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
  }

  async function ensureProfile(){
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      profile = defaultProfile(user);
      await setDoc(ref, profile);
      log("T·∫°o h·ªì s∆° m·ªõi ‚úÖ", "good");
    }else{
      profile = snap.data();
      // fill missing fields for upgrades
      profile.inventory ??= {};
      profile.equip ??= { weapon:null, armor:null, ring:null, amulet:null, boots:null };
      profile.vip ??= "NONE";
      profile.mapId ??= GAME.maps[0].id;
    }
    await syncProfileUI();
  }

  async function saveProfile(patch){
    const ref = doc(db, "users", user.uid);
    profile = { ...profile, ...patch, updatedAt: serverTimestamp() };
    await updateDoc(ref, patch);
    await syncProfileUI();
  }

  async function syncProfileUI(){
    const power = calcPower(profile);
    $("pName").textContent = profile.name;
    $("pCult").textContent = fmt(profile.cult);
    $("pRealm").textContent = realmOf(profile.cult);
    $("pPower").textContent = fmt(power);
    $("pStone").textContent = fmt(profile.stone);
    $("pVip").textContent = profile.vip;
    $("pMap").textContent = (GAME.maps.find(m=>m.id===profile.mapId)?.name) || "-";
    $("who").textContent = user ? `‚úÖ ${profile.name}` : "Ch∆∞a ƒëƒÉng nh·∫≠p";

    // refresh selects & lists
    renderMaps();
    renderInventory();
  }

  // ========= 5) Adventure =========
  function currentMap(){
    return GAME.maps.find(m=>m.id===profile.mapId) || GAME.maps[0];
  }

  function renderMaps(){
    const mapSel = $("mapSelect");
    mapSel.innerHTML = "";
    for(const m of GAME.maps){
      const opt = document.createElement("option");
      opt.value = m.id; opt.textContent = m.name;
      if(m.id===profile.mapId) opt.selected = true;
      mapSel.appendChild(opt);
    }
    mapSel.onchange = async ()=>{
      await saveProfile({ mapId: mapSel.value });
      renderMobs();
      log(`Chuy·ªÉn map: ${currentMap().name}`);
    };
    renderMobs();
  }

  function renderMobs(){
    const m = currentMap();
    const mobSel = $("mobSelect");
    mobSel.innerHTML="";
    for(const mob of m.mobs){
      const opt = document.createElement("option");
      opt.value = mob.id;
      opt.textContent = `${mob.name} (Tu vi +${mob.cult}, LS +${mob.stone})`;
      mobSel.appendChild(opt);
    }
  }

  function rollDrop(dropTable, vipBonus=0){
    // ch·ªçn item theo rate (rate + vipBonus*rate)
    const drops = [];
    for(const it of (dropTable||[])){
      const rate = Math.min(0.95, it.rate * (1 + vipBonus));
      if(Math.random() < rate){
        drops.push({ name: it.item, type: it.type, power: it.power, qty: 1 });
      }
    }
    return drops;
  }

  function addToInventory(items){
    const inv = { ...(profile.inventory||{}) };
    for(const it of items){
      const key = `${it.type}:${it.name}`;
      inv[key] = inv[key] || { name: it.name, type: it.type, power: it.power||0, qty: 0 };
      inv[key].qty += (it.qty||1);
      inv[key].power = Math.max(inv[key].power, it.power||0);
    }
    return inv;
  }

  async function fightMob(){
    const m = currentMap();
    const mobId = $("mobSelect").value;
    const mob = m.mobs.find(x=>x.id===mobId);
    if(!mob) return;

    const buff = vipBuff(profile.vip);
    const cultGain = Math.floor(mob.cult * buff.cultMult);
    const stoneGain = mob.stone;

    const drops = rollDrop(mob.dropTable, buff.dropBonus);
    const inv = addToInventory(drops);

    await saveProfile({
      cult: (profile.cult||0) + cultGain,
      stone: (profile.stone||0) + stoneGain,
      inventory: inv
    });

    log(`ƒê√°nh ${mob.name}: +${cultGain} tu vi, +${stoneGain} linh th·∫°ch`, "good");
    if(drops.length) log(`R∆°i ƒë·ªì: ${drops.map(d=>d.name).join(", ")}`, "warn");
  }

  async function fightBoss(){
    const now = Date.now();
    const cd = GAME.bossCooldownSec * 1000;
    if(now - (profile.lastBossAt||0) < cd){
      const left = Math.ceil((cd - (now-profile.lastBossAt))/1000);
      log(`Boss ƒëang h·ªìi chi√™u: c√≤n ${left}s`, "bad");
      return;
    }

    const b = currentMap().boss;
    const buff = vipBuff(profile.vip);
    const cultGain = Math.floor(b.cult * buff.cultMult);
    const stoneGain = b.stone;
    const drops = rollDrop(b.dropTable, buff.dropBonus);
    const inv = addToInventory(drops);

    await saveProfile({
      cult: (profile.cult||0) + cultGain,
      stone: (profile.stone||0) + stoneGain,
      inventory: inv,
      lastBossAt: now
    });

    log(`üî• H·∫° boss ${b.name}: +${cultGain} tu vi, +${stoneGain} linh th·∫°ch`, "good");
    if(drops.length) log(`üéÅ Boss r∆°i: ${drops.map(d=>d.name).join(", ")}`, "warn");
  }

  // ========= 6) Train & Online =========
  async function train(){
    const now = Date.now();
    const cd = GAME.train.cooldownSec*1000;
    if(now - (profile.lastTrainAt||0) < cd){
      const left = Math.ceil((cd - (now-profile.lastTrainAt))/1000);
      log(`Tu luy·ªán ƒëang h·ªìi: c√≤n ${left}s`, "bad");
      return;
    }
    const buff = vipBuff(profile.vip);
    const cultGain = Math.floor(GAME.train.cult * buff.cultMult);
    await saveProfile({ cult:(profile.cult||0)+cultGain, lastTrainAt: now });
    log(`Tu luy·ªán: +${cultGain} tu vi`, "good");
  }

  async function claimOnline(){
    const now = Date.now();
    const cd = GAME.onlineReward.everySec*1000;
    if(now - (profile.lastOnlineClaimAt||0) < cd){
      const left = Math.ceil((cd - (now-profile.lastOnlineClaimAt))/1000);
      log(`Ch∆∞a ƒë·ªß th·ªùi gian online: c√≤n ${left}s`, "bad");
      return;
    }
    await saveProfile({ stone:(profile.stone||0)+GAME.onlineReward.stone, lastOnlineClaimAt: now });
    log(`Nh·∫≠n online: +${GAME.onlineReward.stone} linh th·∫°ch`, "good");
  }

  // ========= 7) Inventory / Equip =========
  function renderInventory(){
    const invList = $("invList");
    const equipBox = $("equipBox");
    invList.innerHTML = "";
    equipBox.innerHTML = "";

    const inv = profile?.inventory || {};
    const items = Object.entries(inv)
      .map(([k,v])=>({ key:k, ...v }))
      .sort((a,b)=> (b.power||0)-(a.power||0));

    if(!items.length){
      invList.innerHTML = `<div class="mut">Ch∆∞a c√≥ ƒë·ªì. H√£y ƒëi c√†y qu√°i/boss.</div>`;
    } else {
      for(const it of items){
        const el = document.createElement("div");
        el.className="item";
        el.innerHTML = `
          <div>
            <div><b>${it.name}</b> <span class="mut">(${it.type})</span></div>
            <div class="mut">L·ª±c +${it.power||0} ‚Ä¢ SL: ${it.qty||0}</div>
          </div>
          <div class="row">
            <button class="btn secondary" ${["weapon","armor","ring","amulet","boots"].includes(it.type) ? "" : "disabled"}>
              Trang b·ªã
            </button>
          </div>
        `;
        const btn = el.querySelector("button");
        btn.onclick = async ()=>{
          if(!["weapon","armor","ring","amulet","boots"].includes(it.type)) return;
          const eq = { ...(profile.equip||{}) };
          eq[it.type] = { name: it.name, power: it.power||0, type: it.type };
          await saveProfile({ equip: eq });
          log(`Trang b·ªã: ${it.name} (+${it.power||0})`, "good");
        };
        invList.appendChild(el);
      }
    }

    const eq = profile?.equip || {};
    const slots = ["weapon","armor","ring","amulet","boots"];
    for(const s of slots){
      const v = eq[s];
      const el = document.createElement("div");
      el.className="item";
      el.innerHTML = `
        <div>
          <div><b>${s.toUpperCase()}</b></div>
          <div class="mut">${v ? `${v.name} (+${v.power})` : "Ch∆∞a trang b·ªã"}</div>
        </div>
        <div class="row">
          <button class="btn secondary" ${v ? "" : "disabled"}>Th√°o</button>
        </div>
      `;
      const btn = el.querySelector("button");
      btn.onclick = async ()=>{
        const eq2 = { ...(profile.equip||{}) };
        eq2[s] = null;
        await saveProfile({ equip:eq2 });
        log(`Th√°o ${s}`, "warn");
      };
      equipBox.appendChild(el);
    }
  }

  // ========= 8) VIP topup (pending) =========
  async function createTopup(){
    const code = $("topupCode").value.trim();
    const pack = $("vipPack").value;
    if(!code || code.length < 3){
      log("CODE kh√¥ng h·ª£p l·ªá.", "bad");
      return;
    }
    await addDoc(collection(db, "topups"), {
      uid: user.uid,
      name: profile.name,
      code,
      pack,
      status: "pending",
      createdAt: serverTimestamp(),
      note: PAYMENT.note
    });
    $("topupCode").value = "";
    log(`ƒê√£ t·∫°o phi·∫øu n·∫°p (${pack}) v·ªõi CODE: ${code} ‚Äî tr·∫°ng th√°i pending`, "warn");
    log("B·∫°n v√†o Firestore collection topups ƒë·ªÉ duy·ªát th·ªß c√¥ng (ƒë·ªïi status=approved + set vip cho user).", "warn");
  }

  // ========= 9) PvP (MVP) =========
  function expectedScore(ra, rb){ return 1/(1+Math.pow(10, (rb-ra)/400)); }
  function newElo(r, score, exp){ return Math.round(r + 24*(score-exp)); }

  async function findOpponent(){
    const myPower = calcPower(profile);
    // L·∫•y 20 ng∆∞·ªùi g·∫ßn ƒë√¢y, ch·ªçn ng∆∞·ªùi kh√°c m√¨nh (MVP)
    const qy = query(collection(db, "users"), orderBy("updatedAt","desc"), limit(20));
    const snap = await getDocs(qy);
    const pool = [];
    snap.forEach(d=>{
      const u = d.data();
      if(u.uid !== user.uid) pool.push(u);
    });
    if(!pool.length){
      log("Ch∆∞a c√≥ ƒë·ªëi th·ªß. C·∫ßn c√≥ ng∆∞·ªùi kh√°c ƒëƒÉng nh·∫≠p server.", "bad");
      return;
    }
    const opp = pool[Math.floor(Math.random()*pool.length)];
    const oppPower = calcPower(opp);

    // x√°c su·∫•t th·∫Øng d·ª±a tr√™n l·ª±c chi·∫øn
    const diff = myPower - oppPower;
    const winProb = Math.max(0.15, Math.min(0.85, 0.5 + diff/500));
    const win = Math.random() < winProb;

    const myE = profile.elo || 1000;
    const opE = opp.elo || 1000;
    const exp = expectedScore(myE, opE);
    const myNew = newElo(myE, win?1:0, exp);

    await saveProfile({ elo: myNew });

    // l∆∞u match
    await addDoc(collection(db, "pvp_matches"),{
      a: { uid:user.uid, name:profile.name, power:myPower, eloBefore:myE, eloAfter:myNew },
      b: { uid:opp.uid, name:opp.name, power:oppPower, eloBefore:opE },
      result: win ? "A_WIN" : "B_WIN",
      createdAt: serverTimestamp()
    });

    renderPvpResult(opp, win, myPower, oppPower, myE, myNew);
  }

  function renderPvpResult(opp, win, myPower, oppPower, myE, myNew){
    const box = $("pvpBox");
    const el = document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <div>
        <div><b>${win ? "üèÜ Th·∫Øng" : "üíÄ Thua"}</b> vs <b>${opp.name}</b></div>
        <div class="mut">B·∫°n: ${fmt(myPower)} ‚Ä¢ ƒê·ªãch: ${fmt(oppPower)} ‚Ä¢ ELO: ${myE} ‚Üí ${myNew}</div>
      </div>
      <div class="pill">${new Date().toLocaleString()}</div>
    `;
    box.prepend(el);
  }

  // ========= 10) Guild (MVP) =========
  async function createGuild(){
    const name = $("guildName").value.trim();
    if(name.length < 3){ log("T√™n bang qu√° ng·∫Øn.", "bad"); return; }
    const docRef = await addDoc(collection(db, "guilds"), {
      name,
      leaderUid: user.uid,
      members: [{ uid:user.uid, name:profile.name, joinedAt: Date.now() }],
      score: 0,
      createdAt: serverTimestamp()
    });
    await saveProfile({ guildId: docRef.id });
    $("guildName").value="";
    log(`T·∫°o bang: ${name} (ID: ${docRef.id})`, "good");
    await loadGuildBox();
  }

  async function joinGuild(){
    const gid = $("guildJoinId").value.trim();
    if(gid.length < 8){ log("ID bang kh√¥ng h·ª£p l·ªá.", "bad"); return; }
    const ref = doc(db, "guilds", gid);
    const snap = await getDoc(ref);
    if(!snap.exists()){ log("Kh√¥ng th·∫•y bang n√†y.", "bad"); return; }
    const g = snap.data();
    const members = g.members || [];
    if(members.some(m=>m.uid===user.uid)){ log("B·∫°n ƒë√£ ·ªü trong bang n√†y.", "warn"); return; }
    members.push({ uid:user.uid, name:profile.name, joinedAt: Date.now() });
    await updateDoc(ref, { members });
    await saveProfile({ guildId: gid });
    $("guildJoinId").value="";
    log(`ƒê√£ xin v√†o bang: ${g.name}`, "good");
    await loadGuildBox();
  }

  async function loadGuildBox(){
    const box = $("guildBox");
    box.innerHTML = "";
    if(!profile.guildId){
      box.innerHTML = `<div class="mut">B·∫°n ch∆∞a c√≥ bang. T·∫°o ho·∫∑c xin v√†o bang.</div>`;
      return;
    }
    const ref = doc(db, "guilds", profile.guildId);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      box.innerHTML = `<div class="mut">Bang kh√¥ng t·ªìn t·∫°i (c√≥ th·ªÉ b·ªã x√≥a).</div>`;
      return;
    }
    const g = snap.data();
    const el = document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <div>
        <div><b>${g.name}</b></div>
        <div class="mut">ID: ${profile.guildId}</div>
        <div class="mut">Th√†nh vi√™n: ${(g.members||[]).length}</div>
      </div>
      <div class="pill">Score: ${fmt(g.score||0)}</div>
    `;
    box.appendChild(el);

    // list members
    const list = document.createElement("div");
    list.className="card";
    list.style.marginTop="10px";
    list.innerHTML = `<h3>Th√†nh vi√™n</h3><div class="list" id="gMembers"></div>`;
    box.appendChild(list);
    const mbox = list.querySelector("#gMembers");
    (g.members||[]).slice(0,30).forEach(m=>{
      const x = document.createElement("div");
      x.className="item";
      x.innerHTML = `<div><b>${m.name}</b><div class="mut">${m.uid}</div></div><div class="pill">Joined</div>`;
      mbox.appendChild(x);
    });
  }

  // ========= 11) Leaderboard =========
  async function loadTop(mode){
    const box = $("topBox");
    box.innerHTML = "";
    let qy;
    if(mode==="power"){
      // Firestore kh√¥ng sort theo power (t√≠nh t·ª´ equip) tr·ª±c ti·∫øp trong MVP.
      // MVP: sort theo cult (t·∫°m) + hi·ªÉn th·ªã power t√≠nh t·∫°i client t·ª´ doc user.
      qy = query(collection(db,"users"), orderBy("cult","desc"), limit(20));
    } else {
      qy = query(collection(db,"users"), orderBy("cult","desc"), limit(20));
    }
    const snap = await getDocs(qy);
    const arr = [];
    snap.forEach(d=>arr.push(d.data()));
    // compute power locally
    arr.forEach(u=>u._power = calcPower(u));
    if(mode==="power") arr.sort((a,b)=>b._power-a._power);
    else arr.sort((a,b)=>(b.cult||0)-(a.cult||0));

    arr.slice(0,20).forEach((u,i)=>{
      const el = document.createElement("div");
      el.className="item";
      el.innerHTML = `
        <div>
          <div><b>#${i+1} ${u.name || "?"}</b> <span class="mut">${u.vip||"NONE"}</span></div>
          <div class="mut">Tu vi: ${fmt(u.cult)} ‚Ä¢ L·ª±c chi·∫øn: ${fmt(u._power)} ‚Ä¢ ELO: ${u.elo||1000}</div>
        </div>
        <div class="pill">${realmOf(u.cult||0)}</div>
      `;
      box.appendChild(el);
    });
  }

  // ========= 12) Tabs =========
  document.querySelectorAll(".tab").forEach(t=>{
    t.onclick = async ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const tab = t.dataset.tab;
      ["adventure","inventory","pvp","guild","leaderboard"].forEach(k=>{
        document.getElementById("tab-"+k).style.display = (k===tab) ? "" : "none";
      });
      if(tab==="guild") await loadGuildBox();
    };
  });

  // ========= 13) Buttons =========
  $("btnTrain").onclick = train;
  $("btnClaimDaily").onclick = claimOnline;
  $("btnFight").onclick = fightMob;
  $("btnBoss").onclick = fightBoss;
  $("btnTopup").onclick = createTopup;
  $("btnMatch").onclick = findOpponent;
  $("btnCreateGuild").onclick = createGuild;
  $("btnJoinGuild").onclick = joinGuild;
  $("btnTopPower").onclick = ()=>loadTop("power");
  $("btnTopCult").onclick = ()=>loadTop("cult");

  // ========= 14) Auth =========
  $("btnLogin").onclick = async ()=>{
    try{
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    }catch(e){
      console.error(e);
      log("L·ªói ƒëƒÉng nh·∫≠p. H√£y ki·ªÉm tra Auth Google ƒë√£ enable.", "bad");
    }
  };
  $("btnLogout").onclick = async ()=>{
    await signOut(auth);
  };

  function setEnabled(on){
    $("btnLogout").disabled = !on;
    $("btnLogin").disabled = on;

    $("btnTrain").disabled = !on;
    $("btnClaimDaily").disabled = !on;
    $("btnFight").disabled = !on;
    $("btnBoss").disabled = !on;
    $("btnTopup").disabled = !on;
    $("btnMatch").disabled = !on;
    $("btnCreateGuild").disabled = !on;
    $("btnJoinGuild").disabled = !on;
    $("btnTopPower").disabled = !on;
    $("btnTopCult").disabled = !on;
  }

  // ========= 15) Boot =========
  try{
    initFirebase();
    onAuthStateChanged(auth, async (u)=>{
      user = u;
      if(!user){
        profile = null;
        $("who").textContent = "Ch∆∞a ƒëƒÉng nh·∫≠p";
        setEnabled(false);
        $("pName").textContent = "-";
        $("pCult").textContent = "-";
        $("pRealm").textContent = "-";
        $("pPower").textContent = "-";
        $("pStone").textContent = "-";
        $("pVip").textContent = "-";
        $("pMap").textContent = "-";
        $("invList").innerHTML = `<div class="mut">H√£y ƒëƒÉng nh·∫≠p ƒë·ªÉ ch∆°i.</div>`;
        $("equipBox").innerHTML = "";
        $("pvpBox").innerHTML = "";
        $("guildBox").innerHTML = "";
        $("topBox").innerHTML = "";
        log("B·∫°n ƒë√£ ƒëƒÉng xu·∫•t.");
        return;
      }
      setEnabled(true);
      await ensureProfile();
      log("ƒêƒÉng nh·∫≠p th√†nh c√¥ng ‚úÖ", "good");
    });
  }catch(e){
    console.error(e);
    log("FirebaseConfig sai ho·∫∑c ch∆∞a d√°n config.", "bad");
  }
</script>

<!--
========================
G·ª¢I √ù FIRESTORE STRUCTURE
========================
users/{uid}:
  cult, stone, vip, mapId, inventory{}, equip{}, elo, guildId,...

guilds/{guildId}:
  name, leaderUid, members[], score,...

topups/{id}:
  uid, code, pack, status: pending/approved/rejected

pvp_matches/{id}:
  a{}, b{}, result, createdAt

========================
G·ª¢I √ù SECURITY RULES (sau khi test xong)
========================
- users: ch·ªâ ch·ªß t√†i kho·∫£n ƒë·ªçc/ghi
- topups: user t·∫°o ƒë∆∞·ª£c, ch·ªâ admin duy·ªát (sau n√†y)
- guilds: ƒë·ªçc public, ghi c√≥ ki·ªÉm so√°t (leader/admin)
- leaderboard: ch·ªâ ƒë·ªçc
-->
</body>
</html>
