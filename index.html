<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Truy·ªán Online - Firebase (Test Full)</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #141b34;
      --panel-2: #1a2345;
      --text: #eaf0ff;
      --muted: #9fb0e0;
      --primary: #4da3ff;
      --danger: #ff5e7a;
      --ok: #4cd38a;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, #16224a 0%, var(--bg) 45%);
      color: var(--text);
      min-height: 100vh;
    }
    .container {
      width: min(1200px, 100% - 24px);
      margin: 18px auto 24px;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
    }
    .card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
    .header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      position: sticky;
      top: 10px;
      z-index: 10;
      backdrop-filter: blur(8px);
    }
    .brand { display: flex; gap: 12px; align-items: center; }
    .logo {
      width: 40px; height: 40px; border-radius: 12px;
      background: conic-gradient(from 180deg, #4da3ff, #7d67ff, #4cd38a, #4da3ff);
      box-shadow: 0 0 20px rgba(77,163,255,.35);
    }
    .title { font-weight: 700; font-size: 18px; }
    .subtitle { color: var(--muted); font-size: 12px; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    button, .btn {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      transition: .2s ease;
      font-weight: 600;
    }
    button:hover { transform: translateY(-1px); border-color: rgba(255,255,255,.16); }
    button:disabled { opacity:.55; cursor:not-allowed; transform:none; }
    .btn-primary { background: linear-gradient(180deg, #3d8ef5, #2c72dc); border-color: rgba(77,163,255,.4); }
    .btn-danger { background: linear-gradient(180deg, #ff6680, #e74d68); border-color: rgba(255,94,122,.3); }
    .btn-ghost { background: transparent; }
    .muted { color: var(--muted); }

    .sidebar, .main { padding: 14px; }
    .panel-title { margin: 0 0 12px; font-size: 15px; font-weight: 700; }

    .user-box {
      display: grid;
      grid-template-columns: 52px 1fr;
      gap: 12px;
      align-items: center;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
    }
    .avatar { width: 52px; height: 52px; border-radius: 14px; object-fit: cover; background: #243052; }
    .user-name { font-weight: 700; }
    .user-email { font-size: 12px; color: var(--muted); word-break: break-all; }
    .user-meta { margin-top: 6px; font-size: 12px; color: var(--muted); }

    .form-group { margin-bottom: 10px; }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, textarea, select {
      width: 100%;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
    }
    textarea { resize: vertical; min-height: 86px; }
    input:focus, textarea:focus, select:focus { border-color: rgba(77,163,255,.45); box-shadow: 0 0 0 3px rgba(77,163,255,.12); }

    .story-list { display:grid; gap:10px; margin-top:10px; }
    .story-item {
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.07);
      background: rgba(255,255,255,.03);
      display:grid;
      gap:6px;
    }
    .story-item .name { font-weight: 700; }
    .story-item .desc { color: var(--muted); font-size: 13px; }
    .story-item .meta { color: var(--muted); font-size: 12px; display:flex; gap:10px; flex-wrap:wrap; }
    .story-actions { display:flex; gap:8px; margin-top:4px; flex-wrap:wrap; }
    .story-actions button { padding: 8px 10px; font-size: 12px; }

    .main-top {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .chat-wrap, .stories-wrap { padding: 14px; }
    .chat-layout {
      display:grid;
      grid-template-rows: auto 1fr auto;
      height: 560px;
      gap: 10px;
    }
    .chat-header {
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chat-status { font-size: 12px; color: var(--muted); }
    .messages {
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 12px;
      padding: 10px;
      overflow: auto;
      background: rgba(0,0,0,.12);
      display: grid;
      gap: 8px;
      align-content: start;
    }
    .msg {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
    }
    .msg.me { border-color: rgba(77,163,255,.35); background: rgba(77,163,255,.08); }
    .msg-top { display:flex; justify-content:space-between; gap:8px; font-size: 12px; }
    .msg-name { font-weight:700; color:#dbe8ff; }
    .msg-time { color: var(--muted); white-space: nowrap; }
    .msg-text { margin-top: 6px; line-height: 1.45; white-space: pre-wrap; word-wrap: break-word; }
    .chat-input-row { display:grid; grid-template-columns: 1fr auto; gap:8px; }

    .stat-grid { display:grid; grid-template-columns: repeat(2,1fr); gap: 8px; margin-top: 10px; }
    .stat {
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255,255,255,.03);
    }
    .stat .k { color: var(--muted); font-size: 12px; }
    .stat .v { font-weight: 700; margin-top: 4px; }

    .notice {
      border:1px dashed rgba(255,255,255,.12);
      border-radius:12px; padding:10px; color: var(--muted); font-size:13px;
      background: rgba(255,255,255,.02);
    }
    .hidden { display:none !important; }

    @media (max-width: 980px) {
      .container { grid-template-columns: 1fr; }
      .main-top { grid-template-columns: 1fr; }
      .chat-layout { height: 470px; }
      .header { top: 6px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header card">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Truy·ªán Online (Firebase)</div>
          <div class="subtitle">HTML tƒ©nh + Firebase Auth / Firestore / Realtime Database</div>
        </div>
      </div>
      <div class="toolbar">
        <button id="btnGoogleLogin" class="btn-primary">ƒêƒÉng nh·∫≠p Google</button>
        <button id="btnLogout" class="btn-ghost hidden">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <aside class="sidebar card">
      <h3 class="panel-title">T√†i kho·∫£n ng∆∞·ªùi d√πng</h3>

      <div id="guestBox" class="notice">
        B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. H√£y b·∫•m <b>ƒêƒÉng nh·∫≠p Google</b> ƒë·ªÉ s·ª≠ d·ª•ng chat, ƒëƒÉng truy·ªán v√† ƒë·ªìng b·ªô d·ªØ li·ªáu.
      </div>

      <div id="userPanel" class="hidden">
        <div class="user-box">
          <img id="userAvatar" class="avatar" alt="avatar" />
          <div>
            <div id="userName" class="user-name">---</div>
            <div id="userEmail" class="user-email">---</div>
            <div id="userMeta" class="user-meta">UID: ---</div>
          </div>
        </div>

        <div class="stat-grid">
          <div class="stat"><div class="k">Tr·∫°ng th√°i</div><div class="v" id="presenceText">Offline</div></div>
          <div class="stat"><div class="k">ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi</div><div class="v" id="lastLoginText">---</div></div>
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.06); margin:14px 0;">

        <h3 class="panel-title">Th√¥ng tin h·ªì s∆°</h3>
        <div class="form-group">
          <label for="displayNameInput">T√™n hi·ªÉn th·ªã</label>
          <input id="displayNameInput" type="text" placeholder="VD: Ti·ªÉu Ma Qu√¢n" />
        </div>
        <div class="form-group">
          <label for="bioInput">Gi·ªõi thi·ªáu ng·∫Øn</label>
          <textarea id="bioInput" placeholder="Gi·ªõi thi·ªáu b·∫£n th√¢n..."></textarea>
        </div>
        <div class="form-group">
          <label for="favoriteGenreInput">Th·ªÉ lo·∫°i y√™u th√≠ch</label>
          <input id="favoriteGenreInput" type="text" placeholder="Tu ti√™n, huy·ªÅn huy·ªÖn..." />
        </div>
        <button id="btnSaveProfile" class="btn-primary" style="width:100%;">L∆∞u h·ªì s∆°</button>
      </div>
    </aside>

    <main class="main">
      <div class="main-top">
        <section class="stories-wrap card">
          <h3 class="panel-title">ƒêƒÉng truy·ªán (Firestore)</h3>
          <div class="notice" style="margin-bottom:10px;">
            D·ªØ li·ªáu truy·ªán l∆∞u tr√™n <b>Cloud Firestore</b>. C√≥ th·ªÉ m·ªü r·ªông th√™m ph√¢n trang, duy·ªát truy·ªán, admin ki·ªÉm duy·ªát sau.
          </div>
          <div class="form-group">
            <label for="storyTitle">T√™n truy·ªán</label>
            <input id="storyTitle" type="text" placeholder="Nh·∫≠p t√™n truy·ªán" />
          </div>
          <div class="form-group">
            <label for="storyCover">Link ·∫£nh b√¨a</label>
            <input id="storyCover" type="url" placeholder="https://..." />
          </div>
          <div class="form-group">
            <label for="storyGenre">Th·ªÉ lo·∫°i</label>
            <input id="storyGenre" type="text" placeholder="Tu ti√™n / Huy·ªÅn huy·ªÖn / ƒê√¥ th·ªã..." />
          </div>
          <div class="form-group">
            <label for="storyDesc">M√¥ t·∫£</label>
            <textarea id="storyDesc" placeholder="M√¥ t·∫£ ng·∫Øn truy·ªán..."></textarea>
          </div>
          <button id="btnPostStory" class="btn-primary" style="width:100%;">ƒêƒÉng truy·ªán</button>
        </section>

        <section class="chat-wrap card">
          <div class="chat-layout">
            <div class="chat-header">
              <div>
                <h3 class="panel-title" style="margin:0;">Tin nh·∫Øn c·ªông ƒë·ªìng (Realtime)</h3>
                <div class="chat-status" id="chatStatus">Ch∆∞a k·∫øt n·ªëi</div>
              </div>
              <button id="btnClearInput" class="btn-ghost">X√≥a √¥ chat</button>
            </div>

            <div id="messages" class="messages"></div>

            <div>
              <div class="chat-input-row">
                <input id="chatInput" type="text" placeholder="Nh·∫≠p tin nh·∫Øn c·ªông ƒë·ªìng..." maxlength="500" />
                <button id="btnSendMsg" class="btn-primary">G·ª≠i</button>
              </div>
              <div class="muted" style="font-size:12px; margin-top:6px;">
                H·ªó tr·ª£: chat c·ªông ƒë·ªìng realtime, presence online, h·ªì s∆° user, truy·ªán/ch∆∞∆°ng/b√¨nh lu·∫≠n, reader + TTS.
              </div>
            </div>
          </div>
        </section>
      </div>

      <section class="card" style="padding:14px;">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
          <h3 class="panel-title" style="margin:0;">Danh s√°ch truy·ªán m·ªõi nh·∫•t</h3>
          <div class="toolbar" style="gap:8px;">
            <input id="searchStory" type="text" placeholder="T√¨m truy·ªán..." style="width:220px;" />
            <button id="btnRefreshStories">L√†m m·ªõi</button>
          </div>
        </div>
        <div id="storyList" class="story-list"></div>
      </section>
    </main>
  </div>

  <script type="module">
    // ===============================
    // 1) FIREBASE IMPORTS (Browser CDN)
    // ===============================
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';

    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      getDocs,
      serverTimestamp,
      collection,
      addDoc,
      query,
      orderBy,
      limit,
      onSnapshot,
      updateDoc,
      deleteDoc,
      increment,
    } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    import {
      getDatabase,
      ref,
      set,
      onDisconnect,
      onValue,
      serverTimestamp as rtdbServerTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';

    // ===============================
    // 2) FIREBASE CONFIG (C·ª¶A B·∫†N)
    // ===============================
    const firebaseConfig = {
      apiKey: "AIzaSyDhq66ZZzNp9_-FnY7T-2gxNlrUDxeDPrU",
      authDomain: "truyen-b3470.firebaseapp.com",
      databaseURL: "https://truyen-b3470-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "truyen-b3470",
      storageBucket: "truyen-b3470.firebasestorage.app",
      messagingSenderId: "93210370757",
      appId: "1:93210370757:web:87828b963906ac862f46ac"
    };

    let app, auth, db, rtdb;
    let currentUser = null;
    let currentUserProfile = null;
    let isAdmin = false;

    let unsubMessages = null;
    let unsubStories = null;
    let unsubPresenceCount = null;
    let overlayUnsubs = [];

    let storyCache = [];
    let storyPage = 1;
    const STORIES_PER_PAGE = 10;

    let ttsUtterance = null;
    let ttsVoices = [];
    let ttsState = {
      speaking: false,
      paused: false,
      voiceName: localStorage.getItem('reader_voice_vi') || '',
      rate: Number(localStorage.getItem('reader_tts_rate') || '1.2'),
    };
    let readerSettings = {
      fontSize: Number(localStorage.getItem('reader_font_size') || '20'),
      lineHeight: Number(localStorage.getItem('reader_line_height') || '1.8'),
      maxWidth: Number(localStorage.getItem('reader_max_width') || '820'),
      theme: localStorage.getItem('reader_theme') || 'dark',
    };

    const $ = (id) => document.getElementById(id);

    const btnGoogleLogin = $('btnGoogleLogin');
    const btnLogout = $('btnLogout');
    const guestBox = $('guestBox');
    const userPanel = $('userPanel');

    const userAvatar = $('userAvatar');
    const userName = $('userName');
    const userEmail = $('userEmail');
    const userMeta = $('userMeta');
    const presenceText = $('presenceText');
    const lastLoginText = $('lastLoginText');

    const displayNameInput = $('displayNameInput');
    const bioInput = $('bioInput');
    const favoriteGenreInput = $('favoriteGenreInput');
    const btnSaveProfile = $('btnSaveProfile');

    const storyTitle = $('storyTitle');
    const storyCover = $('storyCover');
    const storyGenre = $('storyGenre');
    const storyDesc = $('storyDesc');
    const btnPostStory = $('btnPostStory');
    const storyList = $('storyList');
    const searchStory = $('searchStory');
    const btnRefreshStories = $('btnRefreshStories');

    const messagesEl = $('messages');
    const chatInput = $('chatInput');
    const btnSendMsg = $('btnSendMsg');
    const btnClearInput = $('btnClearInput');
    const chatStatus = $('chatStatus');

    function escapeHtml(str = '') {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function fmtDate(v) {
      if (!v) return '---';
      let d;
      if (v?.toDate) d = v.toDate();
      else d = new Date(v);
      if (Number.isNaN(d.getTime())) return '---';
      return d.toLocaleString('vi-VN');
    }

    function requireLogin() {
      if (!currentUser) {
        toast('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p Google tr∆∞·ªõc.', 'warn');
        return false;
      }
      return true;
    }

    function toast(msg, type = 'info') {
      let wrap = document.getElementById('toastWrap');
      if (!wrap) {
        wrap = document.createElement('div');
        wrap.id = 'toastWrap';
        wrap.style.cssText = `
          position:fixed; right:12px; bottom:12px; z-index:99999;
          display:grid; gap:8px; width:min(360px, calc(100vw - 24px));
        `;
        document.body.appendChild(wrap);
      }
      const el = document.createElement('div');
      const border =
        type === 'error' ? 'rgba(255,94,122,.35)' :
        type === 'ok' ? 'rgba(76,211,138,.35)' :
        type === 'warn' ? 'rgba(255,196,80,.35)' :
        'rgba(77,163,255,.35)';
      el.style.cssText = `
        background: linear-gradient(180deg, rgba(20,27,52,.96), rgba(26,35,69,.96));
        border:1px solid ${border};
        border-radius:12px; padding:10px 12px; color:#eaf0ff;
        box-shadow: 0 10px 30px rgba(0,0,0,.35); font-size:13px;
        animation: toastIn .18s ease;
      `;
      el.textContent = msg;
      wrap.appendChild(el);
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(6px)';
        el.style.transition = '.18s ease';
        setTimeout(() => el.remove(), 220);
      }, 2400);
    }

    function ensureGlobalStyleExtras() {
      if (document.getElementById('extra-ui-style')) return;
      const s = document.createElement('style');
      s.id = 'extra-ui-style';
      s.textContent = `
        @keyframes toastIn { from { opacity:.0; transform: translateY(8px) } to { opacity:1; transform: translateY(0) } }
        .pager { display:flex; gap:8px; align-items:center; justify-content:center; margin-top:12px; flex-wrap:wrap; }
        .pager .pinfo { color: var(--muted); font-size: 12px; }
        .route-overlay {
          position: fixed; inset: 0; z-index: 9990;
          background: rgba(5,8,16,.72); backdrop-filter: blur(6px);
          display: none; align-items: center; justify-content: center;
          padding: 12px;
        }
        .route-overlay.show { display: flex; }
        .route-panel {
          width: min(1100px, 100%); max-height: calc(100vh - 24px); overflow: auto;
          background: linear-gradient(180deg, #141b34, #1a2345);
          border: 1px solid rgba(255,255,255,.08);
          border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,.45);
        }
        .route-head {
          position: sticky; top: 0; z-index: 2;
          display:flex; align-items:center; justify-content:space-between; gap:8px;
          padding: 12px 14px;
          border-bottom: 1px solid rgba(255,255,255,.06);
          background: rgba(20,27,52,.92);
          backdrop-filter: blur(6px);
        }
        .route-body { padding: 14px; }
        .grid-2 { display:grid; grid-template-columns: 320px 1fr; gap:12px; }
        .box {
          border:1px solid rgba(255,255,255,.07); background: rgba(255,255,255,.03);
          border-radius: 12px; padding: 12px;
        }
        .cover-lg {
          width:100%; aspect-ratio: 3/4; object-fit: cover; border-radius: 12px;
          border:1px solid rgba(255,255,255,.08); background:#243052;
        }
        .chapter-item, .comment-item, .lib-item {
          border:1px solid rgba(255,255,255,.06); background: rgba(255,255,255,.03);
          border-radius: 10px; padding: 10px; margin-top: 8px;
        }
        .chapter-row {
          display:flex; justify-content:space-between; gap:8px; align-items:center;
          flex-wrap: wrap;
        }
        .chapter-name { font-weight: 700; }
        .small { font-size: 12px; color: var(--muted); }
        .reader-wrap { display:grid; gap:12px; }
        .reader-toolbar {
          position: sticky; top: 58px; z-index: 1;
          display:flex; flex-wrap:wrap; gap:8px;
          padding: 10px;
          border:1px solid rgba(255,255,255,.06);
          border-radius: 12px;
          background: rgba(20,27,52,.9);
          backdrop-filter: blur(6px);
        }
        .reader-content {
          margin: 0 auto;
          border:1px solid rgba(255,255,255,.06);
          border-radius: 14px;
          padding: 16px;
          background: rgba(255,255,255,.02);
          white-space: pre-wrap;
          word-break: break-word;
        }
        .reader-theme-light .reader-content {
          background: rgba(255,255,255,.95); color: #111827; border-color: rgba(0,0,0,.07);
        }
        .reader-theme-sepia .reader-content {
          background: #f6ecd8; color: #362c1f; border-color: rgba(54,44,31,.08);
        }
        .reader-theme-amoled .reader-content {
          background: #000; color: #c5f0ff; border-color: rgba(255,255,255,.12);
        }
        .seg { display:flex; gap:6px; flex-wrap:wrap; }
        .seg button.active { border-color: rgba(77,163,255,.4); background: rgba(77,163,255,.12); }
        .story-badge { display:inline-flex; gap:6px; align-items:center; font-size:12px; color:var(--muted); }
        @media (max-width: 980px) {
          .grid-2 { grid-template-columns: 1fr; }
          .route-overlay { padding: 8px; }
          .route-panel { max-height: calc(100vh - 16px); }
        }
      `;
      document.head.appendChild(s);
    }

    function ensureTopNavButtons() {
      const toolbar = document.querySelector('.header .toolbar');
      if (!toolbar || document.getElementById('btnOpenLibrary')) return;
      const html = `
        <button id="btnOpenLibrary" class="btn-ghost hidden">T·ªß truy·ªán</button>
        <button id="btnOpenHistory" class="btn-ghost hidden">L·ªãch s·ª≠</button>
        <button id="btnOpenMyStories" class="btn-ghost hidden">Truy·ªán c·ªßa t√¥i</button>
      `;
      btnLogout.insertAdjacentHTML('beforebegin', html);

      document.getElementById('btnOpenLibrary').addEventListener('click', () => {
        if (!requireLogin()) return;
        location.hash = '#/library';
      });
      document.getElementById('btnOpenHistory').addEventListener('click', () => {
        if (!requireLogin()) return;
        location.hash = '#/history';
      });
      document.getElementById('btnOpenMyStories').addEventListener('click', () => {
        if (!requireLogin()) return;
        location.hash = '#/my-stories';
      });
    }

    function renderNavVisibility() {
      ['btnOpenLibrary','btnOpenHistory','btnOpenMyStories'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (currentUser) el.classList.remove('hidden');
        else el.classList.add('hidden');
      });
    }

    function getOverlay() {
      let ov = document.getElementById('routeOverlay');
      if (!ov) {
        ov = document.createElement('div');
        ov.id = 'routeOverlay';
        ov.className = 'route-overlay';
        ov.innerHTML = `
          <div class="route-panel">
            <div class="route-head">
              <div>
                <div id="routeTitle" style="font-weight:700;">Chi ti·∫øt</div>
                <div id="routeSubTitle" class="small">---</div>
              </div>
              <div class="seg">
                <button id="btnRouteBack" class="btn-ghost">‚Üê Quay l·∫°i</button>
                <button id="btnRouteClose" class="btn-danger">ƒê√≥ng</button>
              </div>
            </div>
            <div id="routeBody" class="route-body"></div>
          </div>
        `;
        document.body.appendChild(ov);

        ov.addEventListener('click', (e) => {
          if (e.target === ov) closeOverlay();
        });
        ov.querySelector('#btnRouteClose').addEventListener('click', closeOverlay);
        ov.querySelector('#btnRouteBack').addEventListener('click', () => {
          if (location.hash && location.hash !== '#/' && location.hash !== '#/home') {
            history.back();
            setTimeout(() => {
              if (location.hash === '' || location.hash === '#') closeOverlay();
            }, 0);
          } else {
            closeOverlay();
          }
        });
      }
      return ov;
    }

    function setOverlayHeader(title, subtitle = '') {
      const ov = getOverlay();
      ov.querySelector('#routeTitle').textContent = title;
      ov.querySelector('#routeSubTitle').textContent = subtitle || ' ';
    }

    function setOverlayBody(html) {
      const ov = getOverlay();
      ov.querySelector('#routeBody').innerHTML = html;
    }

    function openOverlay() { getOverlay().classList.add('show'); }

    function closeOverlay() {
      cleanupOverlayListeners();
      const ov = getOverlay();
      ov.classList.remove('show');
      ov.querySelector('#routeBody').innerHTML = '';
      if (ttsState.speaking || ttsState.paused) stopTTS();
      if (location.hash.startsWith('#/story/') || location.hash.startsWith('#/read/') || location.hash.startsWith('#/library') || location.hash.startsWith('#/history') || location.hash.startsWith('#/my-stories')) {
        location.hash = '#/home';
      }
    }

    function cleanupOverlayListeners() {
      overlayUnsubs.forEach(fn => { try { fn && fn(); } catch(e){} });
      overlayUnsubs = [];
    }

    function getStoryById(id) { return storyCache.find(x => x.id === id) || null; }

    function getDisplayNameFromProfileOrAuth() {
      return currentUserProfile?.displayName?.trim()
        || currentUser?.displayName
        || currentUser?.email
        || 'Ng∆∞·ªùi d√πng';
    }

    ensureGlobalStyleExtras();
    ensureTopNavButtons();

    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      rtdb = getDatabase(app);

      chatStatus.textContent = 'ƒê√£ k·∫øt n·ªëi Firebase.';
      setupAuth();
      listenStories();
      listenMessages();
      listenPresenceCount();
      setupRouter();
      setupEvents();
      initVoices();
    } catch (err) {
      console.error(err);
      chatStatus.textContent = 'L·ªói kh·ªüi t·∫°o Firebase';
      toast('L·ªói kh·ªüi t·∫°o Firebase: ' + err.message, 'error');
    }

    function setupAuth() {
      const provider = new GoogleAuthProvider();

      btnGoogleLogin.addEventListener('click', async () => {
        try { await signInWithPopup(auth, provider); }
        catch (err) { console.error(err); toast('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ' + err.message, 'error'); }
      });

      btnLogout.addEventListener('click', async () => {
        try {
          if (currentUser) await setPresence(currentUser.uid, false);
          await signOut(auth);
          toast('ƒê√£ ƒëƒÉng xu·∫•t.', 'ok');
        } catch (err) {
          console.error(err);
          toast('ƒêƒÉng xu·∫•t l·ªói: ' + err.message, 'error');
        }
      });

      onAuthStateChanged(auth, async (user) => {
        currentUser = user || null;
        currentUserProfile = null;
        isAdmin = false;
        renderAuthUI();

        if (!currentUser) {
          presenceText.textContent = 'Offline';
          lastLoginText.textContent = '---';
          renderNavVisibility();
          return;
        }

        try {
          await upsertUserProfileFromAuth(currentUser);
          currentUserProfile = await loadUserProfile(currentUser.uid);
          isAdmin = await loadAdminFlag(currentUser.uid);
          await setPresence(currentUser.uid, true);
          renderAuthUI();
          renderStories();
          renderNavVisibility();
          toast(`Xin ch√†o ${getDisplayNameFromProfileOrAuth()}`, 'ok');
        } catch (err) {
          console.error(err);
          toast('L·ªói kh·ªüi t·∫°o h·ªì s∆° ng∆∞·ªùi d√πng: ' + err.message, 'error');
        }
      });
    }

    function renderAuthUI() {
      if (currentUser) {
        guestBox.classList.add('hidden');
        userPanel.classList.remove('hidden');
        btnGoogleLogin.classList.add('hidden');
        btnLogout.classList.remove('hidden');

        userAvatar.src = currentUser.photoURL || 'https://via.placeholder.com/52x52?text=U';
        userName.textContent = currentUserProfile?.displayName || currentUser.displayName || 'Ng∆∞·ªùi d√πng';
        userEmail.textContent = currentUser.email || '---';
        userMeta.textContent = 'UID: ' + currentUser.uid + (isAdmin ? ' ‚Ä¢ ADMIN' : '');
      } else {
        guestBox.classList.remove('hidden');
        userPanel.classList.add('hidden');
        btnGoogleLogin.classList.remove('hidden');
        btnLogout.classList.add('hidden');
      }
      renderNavVisibility();
    }

    async function loadAdminFlag(uid) {
      try {
        const snap = await getDoc(doc(db, 'meta', 'admins'));
        if (!snap.exists()) return false;
        const data = snap.data() || {};
        return !!data[uid];
      } catch (e) { return false; }
    }

    async function upsertUserProfileFromAuth(user) {
      const userRef = doc(db, 'users', user.uid);
      const snap = await getDoc(userRef);
      const baseData = {
        uid: user.uid,
        email: user.email || '',
        photoURL: user.photoURL || '',
        googleName: user.displayName || '',
        lastLoginAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      if (!snap.exists()) {
        await setDoc(userRef, {
          ...baseData,
          displayName: user.displayName || '',
          bio: '',
          favoriteGenre: '',
          role: 'user',
          readerSettings,
          createdAt: serverTimestamp()
        });
      } else {
        await setDoc(userRef, baseData, { merge: true });
      }
    }

    async function loadUserProfile(uid) {
      const snap = await getDoc(doc(db, 'users', uid));
      if (!snap.exists()) return null;
      const data = snap.data();
      displayNameInput.value = data.displayName || data.googleName || '';
      bioInput.value = data.bio || '';
      favoriteGenreInput.value = data.favoriteGenre || '';
      lastLoginText.textContent = fmtDate(data.lastLoginAt);
      if (data.readerSettings && typeof data.readerSettings === 'object') {
        readerSettings = { ...readerSettings, ...data.readerSettings };
      }
      return data;
    }

    btnSaveProfile.addEventListener('click', async () => {
      if (!requireLogin()) return;
      try {
        const payload = {
          displayName: displayNameInput.value.trim(),
          bio: bioInput.value.trim(),
          favoriteGenre: favoriteGenreInput.value.trim(),
          readerSettings,
          updatedAt: serverTimestamp()
        };
        await setDoc(doc(db, 'users', currentUser.uid), payload, { merge: true });
        currentUserProfile = { ...(currentUserProfile || {}), ...payload };
        userName.textContent = payload.displayName || currentUser.displayName || 'Ng∆∞·ªùi d√πng';
        toast('ƒê√£ l∆∞u h·ªì s∆°.', 'ok');
      } catch (err) {
        console.error(err);
        toast('L∆∞u h·ªì s∆° l·ªói: ' + err.message, 'error');
      }
    });

    async function setPresence(uid, online) {
      if (!rtdb) return;
      const userStatusRef = ref(rtdb, `presence/${uid}`);
      try {
        if (online) {
          await set(userStatusRef, { online: true, uid, name: getDisplayNameFromProfileOrAuth(), updatedAt: rtdbServerTimestamp() });
          onDisconnect(userStatusRef).set({ online: false, uid, name: getDisplayNameFromProfileOrAuth(), updatedAt: rtdbServerTimestamp() });
          presenceText.textContent = 'Online';
        } else {
          await set(userStatusRef, { online: false, uid, name: getDisplayNameFromProfileOrAuth(), updatedAt: rtdbServerTimestamp() });
          presenceText.textContent = 'Offline';
        }
      } catch (err) { console.warn('Presence error:', err); }
    }

    function listenPresenceCount() {
      if (!rtdb) return;
      const pRef = ref(rtdb, 'presence');
      if (unsubPresenceCount) unsubPresenceCount();
      unsubPresenceCount = onValue(pRef, (snap) => {
        const data = snap.val() || {};
        const onlineCount = Object.values(data).filter(v => v && v.online).length;
        const currentStatus = chatStatus.textContent || 'ƒê√£ k·∫øt n·ªëi Firebase.';
        const msgPart = currentStatus.split('| Online:')[0].trim();
        chatStatus.textContent = `${msgPart} | Online: ${onlineCount}`;
      });
    }

    btnPostStory.addEventListener('click', async () => {
      if (!requireLogin()) return;
      const title = storyTitle.value.trim();
      const cover = storyCover.value.trim();
      const genre = storyGenre.value.trim();
      const desc = storyDesc.value.trim();
      if (!title) return toast('Vui l√≤ng nh·∫≠p t√™n truy·ªán.', 'warn');

      try {
        await addDoc(collection(db, 'stories'), {
          title, cover, genre, desc,
          authorUid: currentUser.uid,
          authorName: getDisplayNameFromProfileOrAuth(),
          status: 'published',
          views: 0,
          likes: 0,
          chapterCount: 0,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        storyTitle.value = ''; storyCover.value = ''; storyGenre.value = ''; storyDesc.value = '';
        toast('ƒêƒÉng truy·ªán th√†nh c√¥ng.', 'ok');
      } catch (err) {
        console.error(err);
        toast('ƒêƒÉng truy·ªán l·ªói: ' + err.message, 'error');
      }
    });

    function listenStories() {
      if (!db) return;
      if (unsubStories) unsubStories();
      const q = query(collection(db, 'stories'), orderBy('createdAt', 'desc'), limit(200));
      unsubStories = onSnapshot(q, (snap) => {
        storyCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const maxPage = Math.max(1, Math.ceil(filterStories().length / STORIES_PER_PAGE));
        if (storyPage > maxPage) storyPage = maxPage;
        renderStories();
      }, (err) => {
        console.error(err);
        storyList.innerHTML = `<div class="notice">L·ªói t·∫£i truy·ªán: ${escapeHtml(err.message)}</div>`;
      });
    }

    function filterStories() {
      const kw = searchStory.value.trim().toLowerCase();
      return storyCache.filter(s => {
        if (!kw) return true;
        return [s.title, s.genre, s.desc, s.authorName].some(v => String(v || '').toLowerCase().includes(kw));
      });
    }

    function renderStories() {
      const items = filterStories();
      const total = items.length;
      const totalPages = Math.max(1, Math.ceil(total / STORIES_PER_PAGE));
      if (storyPage > totalPages) storyPage = totalPages;
      if (storyPage < 1) storyPage = 1;

      const start = (storyPage - 1) * STORIES_PER_PAGE;
      const pageItems = items.slice(start, start + STORIES_PER_PAGE);

      if (!pageItems.length) {
        storyList.innerHTML = '<div class="notice">Ch∆∞a c√≥ truy·ªán n√†o ho·∫∑c kh√¥ng c√≥ k·∫øt qu·∫£ t√¨m ki·∫øm.</div>';
        return;
      }

      storyList.innerHTML = pageItems.map(s => {
        const canDelete = currentUser && (s.authorUid === currentUser.uid || isAdmin);
        const coverHtml = s.cover
          ? `<img src="${escapeHtml(s.cover)}" alt="cover" style="width:72px;height:96px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#243052;" loading="lazy">`
          : `<div style="width:72px;height:96px;border-radius:10px;border:1px dashed rgba(255,255,255,.12);display:grid;place-items:center;color:#9fb0e0;font-size:12px;">No Cover</div>`;

        return `
          <div class="story-item">
            <div style="display:grid; grid-template-columns:72px 1fr; gap:10px; align-items:start;">
              ${coverHtml}
              <div>
                <div class="name">${escapeHtml(s.title || 'Kh√¥ng t√™n')}</div>
                <div class="desc">${escapeHtml(s.desc || 'Ch∆∞a c√≥ m√¥ t·∫£')}</div>
                <div class="meta">
                  <span>üë§ ${escapeHtml(s.authorName || '---')}</span>
                  <span>üè∑Ô∏è ${escapeHtml(s.genre || '---')}</span>
                  <span>üëÅÔ∏è ${Number(s.views || 0).toLocaleString('vi-VN')}</span>
                  <span>üìö ${Number(s.chapterCount || 0).toLocaleString('vi-VN')} ch∆∞∆°ng</span>
                  <span>üïí ${fmtDate(s.createdAt)}</span>
                </div>
                <div class="story-actions">
                  <button data-action="open" data-id="${s.id}">Chi ti·∫øt</button>
                  <button data-action="read-latest" data-id="${s.id}">ƒê·ªçc</button>
                  ${canDelete ? `<button data-action="delete" data-id="${s.id}" class="btn-danger">X√≥a</button>` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('') + `
        <div class="pager">
          <button ${storyPage <= 1 ? 'disabled' : ''} data-page="prev">‚Üê Tr∆∞·ªõc</button>
          <span class="pinfo">Trang ${storyPage}/${totalPages} ‚Ä¢ ${total} truy·ªán</span>
          <button ${storyPage >= totalPages ? 'disabled' : ''} data-page="next">Sau ‚Üí</button>
        </div>
      `;
    }

    storyList.addEventListener('click', async (e) => {
      const pagerBtn = e.target.closest('button[data-page]');
      if (pagerBtn) {
        storyPage += pagerBtn.dataset.page === 'prev' ? -1 : 1;
        renderStories();
        return;
      }

      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id;
      const story = getStoryById(id);
      if (!story) return;

      if (action === 'open') { location.hash = `#/story/${id}`; return; }

      if (action === 'read-latest') {
        try {
          const snap = await getDocs(query(collection(db, 'stories', id, 'chapters'), orderBy('chapterNo', 'asc'), limit(1)));
          if (snap.empty) {
            toast('Truy·ªán ch∆∞a c√≥ ch∆∞∆°ng. H√£y v√†o Chi ti·∫øt ƒë·ªÉ th√™m ch∆∞∆°ng.', 'warn');
            location.hash = `#/story/${id}`;
            return;
          }
          location.hash = `#/read/${id}/${snap.docs[0].id}`;
        } catch (err) {
          console.error(err);
          toast('Kh√¥ng m·ªü ƒë∆∞·ª£c ch∆∞∆°ng: ' + err.message, 'error');
        }
      }

      if (action === 'delete') {
        if (!requireLogin()) return;
        if (!(story.authorUid === currentUser.uid || isAdmin)) return toast('B·∫°n kh√¥ng th·ªÉ x√≥a truy·ªán n√†y.', 'warn');
        if (!confirm('X√≥a truy·ªán n√†y? (Ch∆∞∆°ng/comment con c√≥ th·ªÉ c·∫ßn d·ªçn ri√™ng n·∫øu rules kh√¥ng cho recursive)')) return;
        try {
          await deleteDoc(doc(db, 'stories', id));
          toast('ƒê√£ x√≥a truy·ªán.', 'ok');
        } catch (err) {
          console.error(err);
          toast('X√≥a truy·ªán l·ªói: ' + err.message, 'error');
        }
      }
    });

    searchStory.addEventListener('input', () => { storyPage = 1; renderStories(); });
    btnRefreshStories.addEventListener('click', renderStories);

    async function openStoryDetail(storyId) {
      cleanupOverlayListeners();
      openOverlay();

      const storyRef = doc(db, 'stories', storyId);
      const storySnap = await getDoc(storyRef);
      if (!storySnap.exists()) {
        setOverlayHeader('Kh√¥ng t√¨m th·∫•y truy·ªán');
        setOverlayBody('<div class="notice">Truy·ªán kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a.</div>');
        return;
      }
      let story = { id: storySnap.id, ...storySnap.data() };

      setOverlayHeader(story.title || 'Chi ti·∫øt truy·ªán', 'ƒêang t·∫£i ch∆∞∆°ng v√† b√¨nh lu·∫≠n...');
      setOverlayBody('<div class="notice">ƒêang t·∫£i d·ªØ li·ªáu truy·ªán...</div>');

      try { await updateDoc(storyRef, { views: increment(1), updatedAt: serverTimestamp() }); } catch (e) {}
      if (currentUser) {
        try {
          await setDoc(doc(db, 'users', currentUser.uid, 'history', storyId), {
            storyId,
            title: story.title || '',
            cover: story.cover || '',
            authorName: story.authorName || '',
            visitedAt: serverTimestamp(),
            lastChapterId: null
          }, { merge: true });
        } catch (e) {}
      }

      const canManage = !!(currentUser && (story.authorUid === currentUser.uid || isAdmin));

      setOverlayBody(`
        <div class="grid-2">
          <div class="box">
            ${story.cover ? `<img class="cover-lg" src="${escapeHtml(story.cover)}" alt="cover" />` : `<div class="cover-lg" style="display:grid;place-items:center;color:#9fb0e0;">No Cover</div>`}
            <div style="margin-top:10px; display:grid; gap:8px;">
              <div class="story-badge">üë§ <b>${escapeHtml(story.authorName || '---')}</b></div>
              <div class="story-badge">üè∑Ô∏è ${escapeHtml(story.genre || '---')}</div>
              <div class="story-badge">üëÅÔ∏è ${Number(story.views || 0).toLocaleString('vi-VN')} l∆∞·ª£t xem</div>
              <div class="story-badge">üìö <span id="storyChapterCountTxt">${Number(story.chapterCount || 0).toLocaleString('vi-VN')}</span> ch∆∞∆°ng</div>
              <div class="story-badge">üïí ${fmtDate(story.createdAt)}</div>
            </div>
            <div style="display:grid; gap:8px; margin-top:10px;">
              <button id="btnFollowStory" class="btn-primary">${currentUser ? 'Theo d√µi / B·ªè theo d√µi' : 'ƒêƒÉng nh·∫≠p ƒë·ªÉ theo d√µi'}</button>
              <button id="btnReadFirstChapter">ƒê·ªçc t·ª´ ƒë·∫ßu</button>
            </div>
          </div>

          <div style="display:grid; gap:12px;">
            <div class="box">
              <div style="font-weight:700; margin-bottom:8px;">M√¥ t·∫£</div>
              <div style="white-space:pre-wrap; line-height:1.55;">${escapeHtml(story.desc || 'Ch∆∞a c√≥ m√¥ t·∫£')}</div>
            </div>

            <div class="box">
              <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap;">
                <div style="font-weight:700;">Danh s√°ch ch∆∞∆°ng</div>
                <div class="small" id="chapterLoadInfo">ƒêang t·∫£i...</div>
              </div>
              ${canManage ? `
                <div style="margin-top:10px; border-top:1px solid rgba(255,255,255,.06); padding-top:10px;">
                  <div style="font-weight:700; margin-bottom:8px;">Th√™m ch∆∞∆°ng m·ªõi</div>
                  <div class="form-group">
                    <label>T√™n ch∆∞∆°ng</label>
                    <input id="chapterTitleInput" type="text" placeholder="VD: Ch∆∞∆°ng 1: Xuy√™n kh√¥ng..." />
                  </div>
                  <div class="form-group">
                    <label>S·ªë ch∆∞∆°ng (chapterNo)</label>
                    <input id="chapterNoInput" type="number" min="1" step="1" placeholder="1" />
                  </div>
                  <div class="form-group">
                    <label>N·ªôi dung ch∆∞∆°ng</label>
                    <textarea id="chapterContentInput" style="min-height:160px;" placeholder="D√°n n·ªôi dung ch∆∞∆°ng..."></textarea>
                  </div>
                  <button id="btnAddChapter" class="btn-primary">L∆∞u ch∆∞∆°ng</button>
                </div>` : ''}
              <div id="chapterListWrap" style="margin-top:8px;"></div>
            </div>

            <div class="box">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                <div style="font-weight:700;">B√¨nh lu·∫≠n</div>
                <div class="small" id="commentCountTxt">0 b√¨nh lu·∫≠n</div>
              </div>
              <div style="margin-top:10px;">
                <div class="chat-input-row">
                  <input id="commentInput" type="text" maxlength="500" placeholder="${currentUser ? 'Vi·∫øt b√¨nh lu·∫≠n...' : 'ƒêƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n'}" />
                  <button id="btnSendComment" class="btn-primary">G·ª≠i</button>
                </div>
              </div>
              <div id="commentListWrap" style="margin-top:8px;"></div>
            </div>
          </div>
        </div>
      `);

      if (currentUser) {
        try {
          const followSnap = await getDoc(doc(db, 'users', currentUser.uid, 'follows', storyId));
          const btnFollow = document.getElementById('btnFollowStory');
          if (btnFollow) btnFollow.textContent = followSnap.exists() ? 'B·ªè theo d√µi' : 'Theo d√µi';
        } catch (e) {}
      }

      document.getElementById('btnReadFirstChapter')?.addEventListener('click', async () => {
        try {
          const snap = await getDocs(query(collection(db, 'stories', storyId, 'chapters'), orderBy('chapterNo', 'asc'), limit(1)));
          if (snap.empty) return toast('Truy·ªán ch∆∞a c√≥ ch∆∞∆°ng.', 'warn');
          location.hash = `#/read/${storyId}/${snap.docs[0].id}`;
        } catch (err) {
          console.error(err); toast('Kh√¥ng th·ªÉ m·ªü ch∆∞∆°ng ƒë·∫ßu: ' + err.message, 'error');
        }
      });

      document.getElementById('btnFollowStory')?.addEventListener('click', async () => {
        if (!requireLogin()) return;
        try {
          const refFollow = doc(db, 'users', currentUser.uid, 'follows', storyId);
          const snap = await getDoc(refFollow);
          if (snap.exists()) {
            await deleteDoc(refFollow);
            toast('ƒê√£ b·ªè theo d√µi.', 'ok');
            document.getElementById('btnFollowStory').textContent = 'Theo d√µi';
          } else {
            await setDoc(refFollow, {
              storyId,
              title: story.title || '',
              cover: story.cover || '',
              authorName: story.authorName || '',
              genre: story.genre || '',
              followedAt: serverTimestamp()
            });
            toast('ƒê√£ th√™m v√†o t·ªß truy·ªán.', 'ok');
            document.getElementById('btnFollowStory').textContent = 'B·ªè theo d√µi';
          }
        } catch (err) {
          console.error(err); toast('L·ªói theo d√µi truy·ªán: ' + err.message, 'error');
        }
      });

      document.getElementById('btnAddChapter')?.addEventListener('click', async () => {
        if (!requireLogin()) return;
        if (!(currentUser && (story.authorUid === currentUser.uid || isAdmin))) return toast('B·∫°n kh√¥ng c√≥ quy·ªÅn th√™m ch∆∞∆°ng.', 'warn');

        const title = (document.getElementById('chapterTitleInput')?.value || '').trim();
        const chapterNo = Number(document.getElementById('chapterNoInput')?.value || 0);
        const content = (document.getElementById('chapterContentInput')?.value || '').trim();
        if (!title) return toast('Nh·∫≠p t√™n ch∆∞∆°ng.', 'warn');
        if (!chapterNo || chapterNo < 1) return toast('S·ªë ch∆∞∆°ng kh√¥ng h·ª£p l·ªá.', 'warn');
        if (!content) return toast('N·ªôi dung ch∆∞∆°ng tr·ªëng.', 'warn');

        try {
          await addDoc(collection(db, 'stories', storyId, 'chapters'), {
            title, chapterNo, content,
            authorUid: currentUser.uid,
            createdAt: serverTimestamp(), updatedAt: serverTimestamp()
          });
          await updateDoc(doc(db, 'stories', storyId), { chapterCount: increment(1), updatedAt: serverTimestamp() });
          document.getElementById('chapterTitleInput').value = '';
          document.getElementById('chapterNoInput').value = '';
          document.getElementById('chapterContentInput').value = '';
          toast('ƒê√£ th√™m ch∆∞∆°ng.', 'ok');
        } catch (err) {
          console.error(err); toast('Th√™m ch∆∞∆°ng l·ªói: ' + err.message, 'error');
        }
      });

      document.getElementById('btnSendComment')?.addEventListener('click', async () => {
        if (!requireLogin()) return;
        const input = document.getElementById('commentInput');
        const text = (input?.value || '').trim();
        if (!text) return;
        try {
          await addDoc(collection(db, 'stories', storyId, 'comments'), {
            uid: currentUser.uid,
            displayName: getDisplayNameFromProfileOrAuth(),
            photoURL: currentUser.photoURL || '',
            text,
            createdAt: serverTimestamp()
          });
          input.value = '';
        } catch (err) {
          console.error(err); toast('G·ª≠i b√¨nh lu·∫≠n l·ªói: ' + err.message, 'error');
        }
      });

      const qChapters = query(collection(db, 'stories', storyId, 'chapters'), orderBy('chapterNo', 'asc'), limit(1000));
      const unsubChapters = onSnapshot(qChapters, (snap) => {
        const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        document.getElementById('chapterLoadInfo').textContent = `${rows.length} ch∆∞∆°ng`;
        const cnt = document.getElementById('storyChapterCountTxt'); if (cnt) cnt.textContent = String(rows.length);
        const wrap = document.getElementById('chapterListWrap'); if (!wrap) return;
        if (!rows.length) { wrap.innerHTML = '<div class="notice">Ch∆∞a c√≥ ch∆∞∆°ng n√†o.</div>'; return; }

        wrap.innerHTML = rows.map(ch => `
          <div class="chapter-item">
            <div class="chapter-row">
              <div>
                <div class="chapter-name">Ch∆∞∆°ng ${Number(ch.chapterNo || 0)} ‚Ä¢ ${escapeHtml(ch.title || 'Kh√¥ng t√™n')}</div>
                <div class="small">üïí ${fmtDate(ch.createdAt)}</div>
              </div>
              <div class="seg">
                <button data-ch-act="read" data-ch-id="${ch.id}">ƒê·ªçc</button>
                ${(currentUser && (story.authorUid === currentUser.uid || isAdmin)) ? `<button data-ch-act="delete" data-ch-id="${ch.id}" class="btn-danger">X√≥a</button>` : ''}
              </div>
            </div>
          </div>
        `).join('');

        wrap.onclick = async (e) => {
          const b = e.target.closest('button[data-ch-act]'); if (!b) return;
          const chId = b.dataset.chId; const act = b.dataset.chAct;
          if (act === 'read') { location.hash = `#/read/${storyId}/${chId}`; return; }
          if (act === 'delete') {
            if (!requireLogin()) return;
            if (!(currentUser && (story.authorUid === currentUser.uid || isAdmin))) return toast('Kh√¥ng c√≥ quy·ªÅn x√≥a ch∆∞∆°ng.', 'warn');
            if (!confirm('X√≥a ch∆∞∆°ng n√†y?')) return;
            try {
              await deleteDoc(doc(db, 'stories', storyId, 'chapters', chId));
              await updateDoc(doc(db, 'stories', storyId), { chapterCount: increment(-1), updatedAt: serverTimestamp() });
              toast('ƒê√£ x√≥a ch∆∞∆°ng.', 'ok');
            } catch (err) { console.error(err); toast('X√≥a ch∆∞∆°ng l·ªói: ' + err.message, 'error'); }
          }
        };
      }, (err) => {
        console.error(err);
        document.getElementById('chapterListWrap').innerHTML = `<div class="notice">L·ªói t·∫£i ch∆∞∆°ng: ${escapeHtml(err.message)}</div>`;
      });

      const qComments = query(collection(db, 'stories', storyId, 'comments'), orderBy('createdAt', 'desc'), limit(100));
      const unsubComments = onSnapshot(qComments, (snap) => {
        const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const countEl = document.getElementById('commentCountTxt'); if (countEl) countEl.textContent = `${rows.length} b√¨nh lu·∫≠n`;
        const wrap = document.getElementById('commentListWrap'); if (!wrap) return;
        if (!rows.length) { wrap.innerHTML = '<div class="notice">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</div>'; return; }
        wrap.innerHTML = rows.map(c => `
          <div class="comment-item">
            <div class="msg-top"><span class="msg-name">${escapeHtml(c.displayName || 'Ng∆∞·ªùi d√πng')}</span><span class="msg-time">${fmtDate(c.createdAt)}</span></div>
            <div class="msg-text">${escapeHtml(c.text || '')}</div>
          </div>
        `).join('');
      }, (err) => {
        console.error(err);
        document.getElementById('commentListWrap').innerHTML = `<div class="notice">L·ªói t·∫£i b√¨nh lu·∫≠n: ${escapeHtml(err.message)}</div>`;
      });

      overlayUnsubs.push(unsubChapters, unsubComments);
    }

    function initVoices() {
      const load = () => { ttsVoices = speechSynthesis.getVoices().filter(v => /vi|vietnam/i.test(v.lang + ' ' + v.name)); };
      load();
      speechSynthesis.onvoiceschanged = load;
    }

    function stopTTS() {
      try { speechSynthesis.cancel(); } catch (e) {}
      ttsUtterance = null;
      ttsState.speaking = false;
      ttsState.paused = false;
      updateReaderTtsButtons();
    }

    function updateReaderTtsButtons() {
      const btnPlay = document.getElementById('readerTtsPlay');
      const btnPause = document.getElementById('readerTtsPause');
      const btnStop = document.getElementById('readerTtsStop');
      if (btnPlay) btnPlay.disabled = ttsState.speaking && !ttsState.paused;
      if (btnPause) btnPause.disabled = !ttsState.speaking;
      if (btnStop) btnStop.disabled = !ttsState.speaking && !ttsState.paused;
      if (btnPause) btnPause.textContent = ttsState.paused ? 'Ti·∫øp t·ª•c' : 'T·∫°m d·ª´ng';
    }

    function speakText(text) {
      if (!('speechSynthesis' in window)) return toast('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Speech API.', 'warn');
      stopTTS();
      const utt = new SpeechSynthesisUtterance(text);
      utt.lang = 'vi-VN';
      utt.rate = Math.max(0.5, Math.min(5, Number(ttsState.rate || 1.2)));
      const voices = speechSynthesis.getVoices();
      const preferred = voices.find(v => v.name === ttsState.voiceName);
      const viVoice = preferred || voices.find(v => /vi|vietnam/i.test(v.lang + ' ' + v.name));
      if (viVoice) utt.voice = viVoice;
      utt.onstart = () => { ttsState.speaking = true; ttsState.paused = false; updateReaderTtsButtons(); };
      utt.onend = () => { ttsState.speaking = false; ttsState.paused = false; updateReaderTtsButtons(); };
      utt.onerror = () => { ttsState.speaking = false; ttsState.paused = false; updateReaderTtsButtons(); toast('TTS l·ªói trong khi ƒë·ªçc.', 'error'); };
      ttsUtterance = utt; speechSynthesis.speak(utt); updateReaderTtsButtons();
    }

    function applyReaderSettings() {
      const wrap = document.getElementById('readerRoot');
      const content = document.getElementById('readerTextContent');
      if (!wrap || !content) return;
      wrap.classList.remove('reader-theme-dark', 'reader-theme-light', 'reader-theme-sepia', 'reader-theme-amoled');
      wrap.classList.add(`reader-theme-${readerSettings.theme}`);
      content.style.fontSize = `${readerSettings.fontSize}px`;
      content.style.lineHeight = String(readerSettings.lineHeight);
      content.style.maxWidth = `${readerSettings.maxWidth}px`;
    }

    async function persistReaderSettings() {
      localStorage.setItem('reader_font_size', String(readerSettings.fontSize));
      localStorage.setItem('reader_line_height', String(readerSettings.lineHeight));
      localStorage.setItem('reader_max_width', String(readerSettings.maxWidth));
      localStorage.setItem('reader_theme', String(readerSettings.theme));
      localStorage.setItem('reader_tts_rate', String(ttsState.rate));
      localStorage.setItem('reader_voice_vi', String(ttsState.voiceName || ''));
      if (currentUser) {
        try {
          await setDoc(doc(db, 'users', currentUser.uid), { readerSettings: { ...readerSettings }, updatedAt: serverTimestamp() }, { merge: true });
        } catch(e) {}
      }
    }

    async function openReader(storyId, chapterId) {
      cleanupOverlayListeners(); openOverlay(); setOverlayHeader('ƒêang t·∫£i ch∆∞∆°ng...', 'Vui l√≤ng ch·ªù');
      try {
        const [storySnap, chapterSnap] = await Promise.all([
          getDoc(doc(db, 'stories', storyId)),
          getDoc(doc(db, 'stories', storyId, 'chapters', chapterId))
        ]);
        if (!storySnap.exists()) { setOverlayBody('<div class="notice">Truy·ªán kh√¥ng t·ªìn t·∫°i.</div>'); return; }
        if (!chapterSnap.exists()) { setOverlayBody('<div class="notice">Ch∆∞∆°ng kh√¥ng t·ªìn t·∫°i.</div>'); return; }

        const story = { id: storySnap.id, ...storySnap.data() };
        const chapter = { id: chapterSnap.id, ...chapterSnap.data() };
        const chaptersSnap = await getDocs(query(collection(db, 'stories', storyId, 'chapters'), orderBy('chapterNo', 'asc'), limit(2000)));
        const chapters = chaptersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        const idx = chapters.findIndex(c => c.id === chapterId);
        const prevCh = idx > 0 ? chapters[idx - 1] : null;
        const nextCh = idx >= 0 && idx < chapters.length - 1 ? chapters[idx + 1] : null;

        setOverlayHeader(`${story.title || 'Truy·ªán'} ‚Ä¢ Ch∆∞∆°ng ${chapter.chapterNo || ''}`, chapter.title || 'Ch∆∞∆°ng');

        const voiceOptions = (speechSynthesis.getVoices() || [])
          .filter(v => /vi|vietnam/i.test(v.lang + ' ' + v.name))
          .map(v => `<option value="${escapeHtml(v.name)}" ${ttsState.voiceName === v.name ? 'selected' : ''}>${escapeHtml(v.name)} (${escapeHtml(v.lang)})</option>`)
          .join('');

        setOverlayBody(`
          <div id="readerRoot" class="reader-wrap reader-theme-${escapeHtml(readerSettings.theme)}">
            <div class="reader-toolbar">
              <div class="seg">
                <button id="btnPrevChapter" ${!prevCh ? 'disabled' : ''}>‚Üê Ch∆∞∆°ng tr∆∞·ªõc</button>
                <button id="btnNextChapter" ${!nextCh ? 'disabled' : ''}>Ch∆∞∆°ng sau ‚Üí</button>
                <button id="btnBackStory">V·ªÅ truy·ªán</button>
              </div>
              <div class="seg">
                <button id="readerTtsPlay" class="btn-primary">‚ñ∂ ƒê·ªçc</button>
                <button id="readerTtsPause">T·∫°m d·ª´ng</button>
                <button id="readerTtsStop">‚ñ† D·ª´ng</button>
              </div>
              <div class="seg">
                <label class="small" style="align-self:center;">Gi·ªçng:</label>
                <select id="readerVoiceSelect" style="width:220px;">
                  <option value="">T·ª± ƒë·ªông ch·ªçn gi·ªçng VI</option>${voiceOptions}
                </select>
              </div>
              <div class="seg">
                <label class="small" style="align-self:center;">T·ªëc ƒë·ªô</label>
                <input id="readerRateInput" type="range" min="0.5" max="5" step="0.1" value="${ttsState.rate}" style="width:130px;">
                <span id="readerRateText" class="small">${ttsState.rate.toFixed(1)}x</span>
              </div>
              <div class="seg">
                <button id="fontMinus">A-</button><button id="fontPlus">A+</button>
                <button id="lineMinus">D√≤ng-</button><button id="linePlus">D√≤ng+</button>
                <button id="widthMinus">Khung-</button><button id="widthPlus">Khung+</button>
              </div>
              <div class="seg">
                <button data-theme="dark" class="themeBtn ${readerSettings.theme === 'dark' ? 'active' : ''}">Dark</button>
                <button data-theme="light" class="themeBtn ${readerSettings.theme === 'light' ? 'active' : ''}">Light</button>
                <button data-theme="sepia" class="themeBtn ${readerSettings.theme === 'sepia' ? 'active' : ''}">Sepia</button>
                <button data-theme="amoled" class="themeBtn ${readerSettings.theme === 'amoled' ? 'active' : ''}">AMOLED</button>
              </div>
              <div class="seg">
                <label class="small" style="align-self:center;">Ch·ªçn ch∆∞∆°ng</label>
                <select id="chapterJumpSelect" style="width:min(360px, 80vw);">
                  ${chapters.map(c => `<option value="${c.id}" ${c.id === chapter.id ? 'selected' : ''}>Ch.${Number(c.chapterNo || 0)} - ${escapeHtml(c.title || 'Kh√¥ng t√™n')}</option>`).join('')}
                </select>
              </div>
            </div>

            <div class="box">
              <div style="font-weight:700;">${escapeHtml(story.title || '')}</div>
              <div class="small">Ch∆∞∆°ng ${Number(chapter.chapterNo || 0)} ‚Ä¢ ${escapeHtml(chapter.title || '')}</div>
            </div>

            <div id="readerTextContent" class="reader-content">${escapeHtml(chapter.content || 'Ch∆∞∆°ng tr·ªëng.')}</div>
          </div>
        `);

        applyReaderSettings(); updateReaderTtsButtons();

        if (currentUser) {
          try {
            await setDoc(doc(db, 'users', currentUser.uid, 'history', storyId), {
              storyId, title: story.title || '', cover: story.cover || '', authorName: story.authorName || '',
              visitedAt: serverTimestamp(), lastChapterId: chapterId, lastChapterNo: chapter.chapterNo || null, lastChapterTitle: chapter.title || ''
            }, { merge: true });
          } catch (e) {}
        }

        document.getElementById('btnBackStory')?.addEventListener('click', () => { if (ttsState.speaking || ttsState.paused) stopTTS(); location.hash = `#/story/${storyId}`; });
        document.getElementById('btnPrevChapter')?.addEventListener('click', () => { if (!prevCh) return; if (ttsState.speaking || ttsState.paused) stopTTS(); location.hash = `#/read/${storyId}/${prevCh.id}`; });
        document.getElementById('btnNextChapter')?.addEventListener('click', () => { if (!nextCh) return; if (ttsState.speaking || ttsState.paused) stopTTS(); location.hash = `#/read/${storyId}/${nextCh.id}`; });
        document.getElementById('chapterJumpSelect')?.addEventListener('change', (e) => { if (ttsState.speaking || ttsState.paused) stopTTS(); location.hash = `#/read/${storyId}/${e.target.value}`; });
        document.getElementById('readerVoiceSelect')?.addEventListener('change', async (e) => { ttsState.voiceName = e.target.value || ''; await persistReaderSettings(); toast('ƒê√£ l∆∞u gi·ªçng ƒë·ªçc.', 'ok'); });
        document.getElementById('readerRateInput')?.addEventListener('input', async (e) => { ttsState.rate = Number(e.target.value || 1.2); document.getElementById('readerRateText').textContent = `${ttsState.rate.toFixed(1)}x`; await persistReaderSettings(); });
        document.getElementById('readerTtsPlay')?.addEventListener('click', () => {
          const text = chapter.content || '';
          if (!text.trim()) return toast('Ch∆∞∆°ng n√†y kh√¥ng c√≥ n·ªôi dung.', 'warn');
          if (ttsState.speaking && ttsState.paused) { speechSynthesis.resume(); ttsState.paused = false; updateReaderTtsButtons(); return; }
          speakText(text);
        });
        document.getElementById('readerTtsPause')?.addEventListener('click', () => {
          if (!ttsState.speaking && !ttsState.paused) return;
          if (ttsState.paused) { speechSynthesis.resume(); ttsState.paused = false; }
          else { speechSynthesis.pause(); ttsState.paused = true; }
          updateReaderTtsButtons();
        });
        document.getElementById('readerTtsStop')?.addEventListener('click', stopTTS);

        document.getElementById('fontMinus')?.addEventListener('click', async () => { readerSettings.fontSize = Math.max(14, readerSettings.fontSize - 1); applyReaderSettings(); await persistReaderSettings(); });
        document.getElementById('fontPlus')?.addEventListener('click', async () => { readerSettings.fontSize = Math.min(34, readerSettings.fontSize + 1); applyReaderSettings(); await persistReaderSettings(); });
        document.getElementById('lineMinus')?.addEventListener('click', async () => { readerSettings.lineHeight = Math.max(1.2, Number((readerSettings.lineHeight - 0.1).toFixed(1))); applyReaderSettings(); await persistReaderSettings(); });
        document.getElementById('linePlus')?.addEventListener('click', async () => { readerSettings.lineHeight = Math.min(3, Number((readerSettings.lineHeight + 0.1).toFixed(1))); applyReaderSettings(); await persistReaderSettings(); });
        document.getElementById('widthMinus')?.addEventListener('click', async () => { readerSettings.maxWidth = Math.max(480, readerSettings.maxWidth - 40); applyReaderSettings(); await persistReaderSettings(); });
        document.getElementById('widthPlus')?.addEventListener('click', async () => { readerSettings.maxWidth = Math.min(1200, readerSettings.maxWidth + 40); applyReaderSettings(); await persistReaderSettings(); });

        document.querySelectorAll('.themeBtn').forEach(btn => {
          btn.addEventListener('click', async () => {
            document.querySelectorAll('.themeBtn').forEach(x => x.classList.remove('active'));
            btn.classList.add('active');
            readerSettings.theme = btn.dataset.theme;
            applyReaderSettings();
            await persistReaderSettings();
          });
        });
      } catch (err) {
        console.error(err);
        setOverlayHeader('L·ªói m·ªü ch∆∞∆°ng');
        setOverlayBody(`<div class="notice">Kh√¥ng th·ªÉ m·ªü ch∆∞∆°ng: ${escapeHtml(err.message)}</div>`);
      }
    }

    async function openUserCollectionView(kind) {
      if (!requireLogin()) return;
      cleanupOverlayListeners(); openOverlay();
      const titleMap = { library: 'T·ªß truy·ªán (Theo d√µi)', history: 'L·ªãch s·ª≠ ƒë·ªçc', 'my-stories': 'Truy·ªán c·ªßa t√¥i' };
      setOverlayHeader(titleMap[kind] || 'D·ªØ li·ªáu ng∆∞·ªùi d√πng', 'ƒêang t·∫£i...');
      setOverlayBody('<div class="notice">ƒêang t·∫£i danh s√°ch...</div>');

      try {
        let rows = [];
        if (kind === 'library') {
          const snap = await getDocs(query(collection(db, 'users', currentUser.uid, 'follows'), orderBy('followedAt', 'desc'), limit(500)));
          rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        } else if (kind === 'history') {
          const snap = await getDocs(query(collection(db, 'users', currentUser.uid, 'history'), orderBy('visitedAt', 'desc'), limit(500)));
          rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        } else if (kind === 'my-stories') {
          rows = storyCache.filter(s => s.authorUid === currentUser.uid).sort((a,b) => {
            const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
            const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
            return tb - ta;
          });
        }

        setOverlayHeader(titleMap[kind] || 'D·ªØ li·ªáu ng∆∞·ªùi d√πng', `${rows.length} m·ª•c`);
        if (!rows.length) { setOverlayBody('<div class="notice">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>'); return; }

        setOverlayBody(`
          <div class="box">
            ${rows.map(r => `
              <div class="lib-item">
                <div style="display:grid; grid-template-columns:56px 1fr auto; gap:10px; align-items:start;">
                  ${r.cover ? `<img src="${escapeHtml(r.cover)}" style="width:56px;height:74px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.07);">` : `<div style="width:56px;height:74px;border-radius:8px;border:1px dashed rgba(255,255,255,.12);display:grid;place-items:center;color:#9fb0e0;font-size:11px;">No cover</div>`}
                  <div>
                    <div style="font-weight:700;">${escapeHtml(r.title || 'Kh√¥ng t√™n')}</div>
                    <div class="small">üë§ ${escapeHtml(r.authorName || '---')}</div>
                    ${kind === 'history'
                      ? `<div class="small">ƒê·ªçc g·∫ßn nh·∫•t: ${escapeHtml(r.lastChapterTitle || '')} ${r.lastChapterNo ? `(Ch.${r.lastChapterNo})` : ''}</div><div class="small">‚è±Ô∏è ${fmtDate(r.visitedAt)}</div>`
                      : kind === 'library'
                        ? `<div class="small">üè∑Ô∏è ${escapeHtml(r.genre || '---')}</div><div class="small">‚è±Ô∏è ${fmtDate(r.followedAt)}</div>`
                        : `<div class="small">üëÅÔ∏è ${Number(r.views || 0).toLocaleString('vi-VN')} ‚Ä¢ üìö ${Number(r.chapterCount || 0).toLocaleString('vi-VN')} ch∆∞∆°ng</div>`}
                  </div>
                  <div class="seg">
                    <button data-userlist-act="open-story" data-story-id="${r.storyId || r.id}">Chi ti·∫øt</button>
                    ${kind === 'history' && r.lastChapterId ? `<button data-userlist-act="continue" data-story-id="${r.storyId}" data-chapter-id="${r.lastChapterId}" class="btn-primary">ƒê·ªçc ti·∫øp</button>` : ''}
                    ${kind === 'library' ? `<button data-userlist-act="unfollow" data-story-id="${r.storyId}" class="btn-danger">B·ªè theo d√µi</button>` : ''}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `);

        const body = document.getElementById('routeBody');
        body.onclick = async (e) => {
          const b = e.target.closest('button[data-userlist-act]'); if (!b) return;
          const act = b.dataset.userlistAct; const storyId = b.dataset.storyId;
          if (act === 'open-story') { location.hash = `#/story/${storyId}`; return; }
          if (act === 'continue') { location.hash = `#/read/${storyId}/${b.dataset.chapterId}`; return; }
          if (act === 'unfollow') {
            if (!confirm('B·ªè theo d√µi truy·ªán n√†y?')) return;
            try { await deleteDoc(doc(db, 'users', currentUser.uid, 'follows', storyId)); toast('ƒê√£ b·ªè theo d√µi.', 'ok'); openUserCollectionView('library'); }
            catch (err) { console.error(err); toast('L·ªói b·ªè theo d√µi: ' + err.message, 'error'); }
          }
        };
      } catch (err) {
        console.error(err);
        setOverlayBody(`<div class="notice">L·ªói t·∫£i d·ªØ li·ªáu: ${escapeHtml(err.message)}</div>`);
      }
    }

    function setupEvents() {
      btnSendMsg.addEventListener('click', sendMessage);
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });
      btnClearInput.addEventListener('click', () => { chatInput.value = ''; chatInput.focus(); });

      window.addEventListener('beforeunload', async () => {
        try { if (currentUser) await setPresence(currentUser.uid, false); } catch (e) {}
      });
      window.addEventListener('hashchange', handleRoute);
    }

    async function sendMessage() {
      if (!requireLogin()) return;
      const text = chatInput.value.trim(); if (!text) return;
      try {
        await addDoc(collection(db, 'messages'), {
          text,
          uid: currentUser.uid,
          displayName: getDisplayNameFromProfileOrAuth(),
          photoURL: currentUser.photoURL || '',
          createdAt: serverTimestamp()
        });
        chatInput.value = '';
      } catch (err) {
        console.error(err); toast('G·ª≠i tin nh·∫Øn l·ªói: ' + err.message, 'error');
      }
    }

    function listenMessages() {
      if (!db) return;
      if (unsubMessages) unsubMessages();
      const q = query(collection(db, 'messages'), orderBy('createdAt', 'desc'), limit(80));
      unsubMessages = onSnapshot(q, (snap) => {
        const rows = snap.docs.map(d => ({ id: d.id, ...d.data() })).reverse();
        renderMessages(rows);
        const currentStatus = chatStatus.textContent;
        const onlineSuffix = currentStatus.includes('| Online:') ? (currentStatus.match(/\| Online:\s*\d+/)?.[0] || '') : '';
        chatStatus.textContent = `ƒêang k·∫øt n·ªëi ‚Ä¢ ${rows.length} tin nh·∫Øn g·∫ßn nh·∫•t ${onlineSuffix}`.trim();
      }, (err) => {
        console.error(err);
        chatStatus.textContent = 'L·ªói t·∫£i tin nh·∫Øn';
        messagesEl.innerHTML = `<div class="notice">L·ªói chat: ${escapeHtml(err.message)}</div>`;
      });
    }

    function renderMessages(rows) {
      if (!rows.length) {
        messagesEl.innerHTML = '<div class="notice">Ch∆∞a c√≥ tin nh·∫Øn n√†o. H√£y g·ª≠i tin ƒë·∫ßu ti√™n!</div>';
        return;
      }
      const wasNearBottom = messagesEl.scrollTop + messagesEl.clientHeight >= messagesEl.scrollHeight - 80;
      messagesEl.innerHTML = rows.map(m => {
        const isMe = currentUser && m.uid === currentUser.uid;
        return `
          <div class="msg ${isMe ? 'me' : ''}">
            <div class="msg-top"><span class="msg-name">${escapeHtml(m.displayName || 'Ng∆∞·ªùi d√πng')}</span><span class="msg-time">${fmtDate(m.createdAt)}</span></div>
            <div class="msg-text">${escapeHtml(m.text || '')}</div>
          </div>
        `;
      }).join('');
      if (wasNearBottom) messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setupRouter() {
      if (!location.hash) location.hash = '#/home';
      handleRoute();
    }

    async function handleRoute() {
      const hash = location.hash || '#/home';
      const parts = hash.replace(/^#\//, '').split('/');
      const route = parts[0] || 'home';
      try {
        if (route === 'home') { closeOverlay(); return; }
        if (route === 'story' && parts[1]) { await openStoryDetail(parts[1]); return; }
        if (route === 'read' && parts[1] && parts[2]) { await openReader(parts[1], parts[2]); return; }
        if (route === 'library') { await openUserCollectionView('library'); return; }
        if (route === 'history') { await openUserCollectionView('history'); return; }
        if (route === 'my-stories') { await openUserCollectionView('my-stories'); return; }
        location.hash = '#/home';
      } catch (err) {
        console.error(err);
        toast('L·ªói ƒëi·ªÅu h∆∞·ªõng: ' + err.message, 'error');
      }
    }
  </script>
</body>
</html>
