<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Truy·ªán Online</title>
  <meta name="theme-color" content="#0d2f66" />
  <style>
    :root{
      --blue0:#0d2f66;
      --blue1:#1e5aa7;
      --blue2:#2a78c9;
      --text:#1b1b1b;
      --muted:#6b7280;
      --bg:#f3f4f6;
      --card:#ffffff;
      --line:#e5e7eb;
      --shadow:0 4px 18px rgba(0,0,0,.08);
      --radius:10px;
      --max:1100px;
      --hotCols:4;
      --heaA:#1d5bb7;
      --heaB:#0d2f66;
      --heaBorder:rgba(255,255,255,.22);
      --heaShadow:0 2px 18px rgba(0,0,0,.28);
      --heaBtnBg:rgba(0,0,0,.20);
      --heaBtnBorder:rgba(255,255,255,.18);
          --topH:0px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;overflow-x:hidden}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      padding-top: var(--topH);
      scroll-padding-top: var(--topH);
    }
    a{color:inherit;text-decoration:none}
    /* ======= HEADER (icon/pill ki·ªÉu nh∆∞ ·∫£nh b·∫°n g·ª≠i) ======= */
.top{
  position:fixed; top:0; left:0; right:0;
  z-index:50;
  width:100%;
  background: linear-gradient(180deg, var(--heaA), var(--heaB));
  box-shadow: var(--heaShadow);
  border-bottom:1px solid var(--heaBorder);
  transform: translateZ(0);
}
.topBar{
  max-width:var(--max);
  margin:0 auto;
  padding:10px calc(12px + env(safe-area-inset-right)) 10px calc(12px + env(safe-area-inset-left));
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.brand{
  display:flex; align-items:center; gap:10px;
  color:#fff;
  font-weight:900;
  letter-spacing:.2px;
  user-select:none;
}
.brandLogo{
  width:40px;height:40px;
  border-radius:12px;
  display:grid;place-items:center;
  background:rgba(255,255,255,.14);
  border:1px solid rgba(255,255,255,.18);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}
.brandText{
  font-size:18px;
  font-weight:900;
  letter-spacing:.4px;
}

.topActions{
  display:flex;
  align-items:center;
  gap:10px;
}

.hdrBtn{
  border:1px solid var(--heaBtnBorder);
  background:var(--heaBtnBg);
  color:#fff;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  cursor:pointer;
  user-select:none;
}
.hdrBtn:active{transform:translateY(1px)}
.hdrBtn:focus{outline:none; box-shadow:0 0 0 3px rgba(99,102,241,.22), inset 0 0 0 1px rgba(255,255,255,.04);}

.circleBtn{
  width:44px;height:44px;
  border-radius:999px;
  display:grid;place-items:center;
  position:relative;
}
.circleBtn .ico{font-size:18px; line-height:1;}

.pillBtn{
  height:44px;
  border-radius:999px;
  display:flex;
  align-items:center;
  gap:10px;
  padding:0 14px;
  position:relative;
  font-weight:900;
}

.onlinePill{
  color:#67e8f9;
  border-color:rgba(103,232,249,.22);
  min-width:78px;
  justify-content:center;
}
.onlineGreenDot{
  width:10px;height:10px;border-radius:999px;
  background:#22c55e;
  box-shadow:0 0 0 3px rgba(34,197,94,.14);
  opacity:.95;
}
.onlineNum{
  font-size:18px;
  letter-spacing:.2px;
  min-width:12px;
  text-align:center;
}

.vipPill{
  border:0;
  background: linear-gradient(180deg, #f7d24d, #c9940a);
  color:#111827;
  box-shadow:0 10px 28px rgba(0,0,0,.35);
  padding:0 16px;
}
.vipPill .vipText{font-weight:900}
.vipPill .vipCoin{font-size:18px; line-height:1}
.vipShort{display:none;font-weight:900}

.badge{
  position:absolute;
  top:-2px; right:-2px;
  min-width:18px;
  height:18px;
  padding:0 5px;
  border-radius:999px;
  background:#ef4444;
  color:#fff;
  font-size:11px;
  font-weight:900;
  display:grid;
  place-items:center;
  border:2px solid rgba(0,0,0,.55);
}

.avatarPill{
  padding:0 10px 0 8px;
  gap:10px;
  min-width:78px;
}
#menuAvatar{
  width:32px;height:32px;
  border-radius:999px;
  object-fit:cover;
  display:none;
}
#menuIcon{
  width:32px;height:32px;
  border-radius:999px;
  display:grid;
  place-items:center;
  font-weight:900;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.10);
}
.caret{
  font-size:14px;
  opacity:.75;
  transform: translateY(-1px);
}

    /* ====== Search modal ====== */
    .searchBg{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      z-index:95;
      padding:12px;
    }
    .searchBox{
      max-width:720px;
      margin:0 auto;
      background:var(--card);
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      border:1px solid rgba(0,0,0,.10);
    }
    .searchHead{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      background:#f5f6f8;
      border-bottom:1px solid var(--line);
    }
    .searchInput{
      flex:1;
      height:40px;
      border-radius:10px;
      border:1px solid #cfd6df;
      padding:0 12px;
      font-weight:800;
      outline:none;
      background:#fff;
    }
    .searchInput:focus{box-shadow:0 0 0 3px rgba(42,120,201,.18)}
    .searchBody{max-height:70vh; overflow:auto}
    .searchItem{
      padding:10px 12px;
      border-top:1px solid var(--line);
      display:flex; gap:10px; align-items:center;
      cursor:pointer;
      background:var(--card);
    }
    .searchItem:hover{background:rgba(0,0,0,.03)}
    .searchItem .t{font-weight:900; font-size:13px; min-width:0; flex:1}
    .searchItem .c{font-size:12px; color:var(--muted); white-space:nowrap}
    .searchEmpty{padding:14px 12px; color:var(--muted); font-size:13px}

    /* ====== Dark mode theo h·ªá th·ªëng ====== */
    @media (prefers-color-scheme: dark){
      :root{
        --text:#e5e7eb;
        --muted:#9ca3af;
        --bg:#0b1220;
        --card:#0f172a;
        --line:#1f2937;
        --shadow:0 6px 24px rgba(0,0,0,.35);
      
        --heaA:#0b1d3c;
        --heaB:#061225;
        --heaBorder:rgba(255,255,255,.10);
        --heaShadow:0 2px 18px rgba(0,0,0,.55);
        --heaBtnBg:rgba(255,255,255,.06);
        --heaBtnBorder:rgba(255,255,255,.12);
      }
      body{background:var(--bg); color:var(--text);}
      .sectionHead{background:rgba(255,255,255,.04)}
      .select{background:#0b1220;color:var(--text);border-color:#334155}
      .drawer{background:#0f172a;color:var(--text)}
      .drawerBtn{background:#0f172a;color:var(--text);border-color:#1f2937}
      .drawerBtn:hover{background:rgba(255,255,255,.06)}
      .modal{background:var(--card)}
      .modalHead{background:rgba(255,255,255,.04)}
      .searchHead{background:rgba(255,255,255,.04)}
      .searchInput{background:#0b1220;color:var(--text);border-color:#334155}
      .mutedBox{background:rgba(255,255,255,.03);border-color:#334155;color:var(--text)}

}

html[data-theme="dark"]{
  --text:#e5e7eb;
  --muted:#9ca3af;
  --bg:#0b1220;
  --card:#0f172a;
  --line:#1f2937;
  --shadow:0 6px 24px rgba(0,0,0,.35);

  --heaA:#0b1d3c;
  --heaB:#061225;
  --heaBorder:rgba(255,255,255,.10);
  --heaShadow:0 2px 18px rgba(0,0,0,.55);
  --heaBtnBg:rgba(255,255,255,.06);
  --heaBtnBorder:rgba(255,255,255,.12);
}
html[data-theme="dark"] body{background:var(--bg); color:var(--text);}
html[data-theme="dark"] .sectionHead{background:rgba(255,255,255,.04)}
html[data-theme="dark"] .select{background:#0b1220;color:var(--text);border-color:#334155}
html[data-theme="dark"] .drawer{background:#0f172a;color:var(--text)}
html[data-theme="dark"] .drawerBtn{background:#0f172a;color:var(--text);border-color:#1f2937}
html[data-theme="dark"] .drawerBtn:hover{background:rgba(255,255,255,.06)}
html[data-theme="dark"] .modal{background:var(--card)}
html[data-theme="dark"] .modalHead{background:rgba(255,255,255,.04)}
html[data-theme="dark"] .searchHead{background:rgba(255,255,255,.04)}
html[data-theme="dark"] .searchInput{background:#0b1220;color:var(--text);border-color:#334155}
html[data-theme="dark"] .mutedBox{background:rgba(255,255,255,.03);border-color:#334155;color:var(--text)}

html[data-theme="light"]{
  --text:#1b1b1b;
  --muted:#6b7280;
  --bg:#f3f4f6;
  --card:#ffffff;
  --line:#e5e7eb;
  --shadow:0 4px 18px rgba(0,0,0,.08);
}
html[data-theme="light"] body{background:var(--bg); color:var(--text);}
html[data-theme="light"] .sectionHead{background:#f6f7f9}
html[data-theme="light"] .select{background:#ffffff;color:var(--text);border-color:#d1d5db}
html[data-theme="light"] .drawer{background:#ffffff;color:var(--text)}
html[data-theme="light"] .drawerBtn{background:#ffffff;color:var(--text);border-color:#e5e7eb}
html[data-theme="light"] .drawerBtn:hover{background:rgba(0,0,0,.03)}
html[data-theme="light"] .modal{background:var(--card)}
html[data-theme="light"] .modalHead{background:#f6f7f9}
html[data-theme="light"] .searchHead{background:#f5f6f8}
html[data-theme="light"] .searchInput{background:#ffffff;color:var(--text);border-color:#cfd6df}
html[data-theme="light"] .mutedBox{background:rgba(0,0,0,.03);border-color:#e5e7eb;color:var(--text)}

.subline{
      max-width:var(--max);
      margin:0 auto;
      padding:8px 12px 10px 12px;
      color:rgba(255,255,255,.88);
      font-size:12.5px;
      border-top:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      backdrop-filter: blur(8px);
    }

    /* ======= LAYOUT ======= */
    .wrap{
      max-width:var(--max);
      margin:12px auto 40px auto;
      padding:0 12px;
    }
    .section{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      margin-bottom:12px;
    }
    .sectionHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      background:#f5f6f8;
      border-bottom:1px solid var(--line);
    }
    .secTitle{
      font-weight:800;
      color:#4b5563;
      display:flex; align-items:center; gap:8px;
      text-transform:uppercase;
      font-size:15px;
      letter-spacing:.2px;
    }
    .secTitle .flame{filter:grayscale(.1)}
    .secRight{
      display:flex; align-items:center; gap:8px;
    }
    .select{
      height:34px;
      border-radius:6px;
      border:1px solid #cfd6df;
      background:#fff;
      padding:0 10px;
      font-weight:700;
      color:#3b4452;
      outline:none;
    }
    .select:focus{box-shadow:0 0 0 3px rgba(42,120,201,.18)}
    .contentPad{padding:10px}

    /* ======= TRUY·ªÜN HOT grid gi·ªëng ·∫£nh ======= */
    .hotGrid{
      display:grid;
      grid-template-columns: repeat(var(--hotCols), 1fr);
      gap:10px;
    }
    .hotItem{
      display:block;
      border-radius:6px;
      overflow:hidden;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .hotCover{
      position:relative;
      width:100%;
      aspect-ratio: 3 / 4;
      background: linear-gradient(135deg, #d1d5db, #9ca3af);
      overflow:hidden;
    }
    .hotCover img{
      width:100%; height:100%; object-fit:cover; display:block;
      transform:scale(1.02);
    }
    .hotName{
      padding:7px 6px;
      font-size:12px;
      font-weight:800;
      line-height:1.15;
      color:#111827;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:30px;
      background:#fff;
    }

    /* ======= LIST gi·ªëng ph·∫ßn "M·ªõi c·∫≠p nh·∫≠t" trong ·∫£nh ======= */
    .listRow{
      display:grid;
      grid-template-columns: 1fr 70px;
      gap:10px;
      padding:10px 10px;
      border-top:1px solid var(--line);
      align-items:center;
    }
    .listRow:first-child{border-top:0}
    .leftLine{min-width:0}
    .storyLine{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .miniCover{
      width:34px;height:46px;
      border-radius:6px;
      background:linear-gradient(135deg,#d1d5db,#9ca3af);
      overflow:hidden;
      flex:none;
      border:1px solid rgba(0,0,0,.08);
    }
    .miniCover img{width:100%;height:100%;object-fit:cover;display:block}
    .lineTitle{
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .lineMeta{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid #cfe3ff;
      background:#eef6ff;
      color:#1f5fa7;
      font-weight:800;
      font-size:11px;
      padding:2px 7px;
      border-radius:999px;
    }
    .chapCount{
      text-align:right;
      font-weight:800;
      color:#2a5da6;
      font-size:13px;
      white-space:nowrap;
    }

    /* ======= Drawer menu gi·ªëng icon 3 g·∫°ch ======= */
    .drawerBg{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      z-index:80;
    }
    .drawer{
      position:absolute; top:0; right:0;
      width:min(320px, 88vw);
      height:100%;
      background:#fff;
      box-shadow:-10px 0 30px rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
    }
    .drawerTop{
      padding:12px;
      background:linear-gradient(180deg, var(--blue2), var(--blue0));
      color:#fff;
    }
    .drawerTop b{display:block;font-size:15px}
    .drawerTop small{opacity:.9}
    .drawerBody{padding:10px; display:grid; gap:8px}
    .drawerBtn{
      width:100%;
      text-align:left;
      padding:10px 10px;
      border-radius:8px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:800;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
    }
    .drawerBtn:hover{background:#f3f4f6}
    .drawerBtn .r{color:#6b7280;font-weight:900}
    .divider{height:1px;background:var(--line);margin:2px 0}
    .hint{
      font-size:12px;
      color:#6b7280;
      padding:0 2px;
      line-height:1.4;
    }
    .mutedBox{
      margin-top:8px;
      border:1px dashed #cfd6df;
      border-radius:8px;
      padding:8px;
      background:#fbfcff;
      color:#475569;
      font-size:12px;
    }

    /* ======= Modal (story preview) ======= */
    .modalBg{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      z-index:90;
      padding:12px;
    }
    .modal{
      max-width:720px;
      margin:0 auto;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 30px 80px rgba(0,0,0,.35);
      border:1px solid rgba(0,0,0,.10);
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      background:#f5f6f8;
      border-bottom:1px solid var(--line);
    }
    .modalHead b{font-size:14px}
    .closeBtn{
      width:38px;height:38px;
      border-radius:9px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .modalBody{padding:12px}
    .modalGrid{
      display:grid;
      grid-template-columns: 88px 1fr;
      gap:12px;
    }
    .modalCover{
      width:88px; aspect-ratio: 3/4;
      border-radius:10px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      background:linear-gradient(135deg,#d1d5db,#9ca3af);
    }
    .modalCover img{width:100%;height:100%;object-fit:cover;display:block}
    .modalDesc{color:#374151;font-size:13px;line-height:1.55}
    .btnRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(180deg,#2a78c9,#1e5aa7);
      color:#fff;
      border-color:rgba(255,255,255,.22);
      box-shadow:0 10px 20px rgba(30,90,167,.25);
    }
    .btn:active{transform:translateY(1px)}


    /* ======= CHAT (tr√≤ chuy·ªán c·ªông ƒë·ªìng) ======= */
    .chatWrap{display:flex;flex-direction:column;gap:10px}
    .chatList{
      max-height:320px;
      overflow:auto;
      border:1px solid var(--line);
      border-radius:10px;
      background:rgba(0,0,0,.02);
      padding:10px;
    }
    html[data-theme="dark"] .chatList{background:rgba(255,255,255,.03)}
    .chatMsg{
      display:flex;
      gap:10px;
      padding:8px 0;
      border-top:1px dashed var(--line);
      align-items:flex-start;
    }
    .chatMsg:first-child{border-top:0}
    .chatAvt{
      width:34px;height:34px;border-radius:999px;
      background:linear-gradient(135deg,#d1d5db,#9ca3af);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
      flex:none;
      display:grid;place-items:center;
      font-weight:900;color:#111827;
    }
    .chatAvt img{width:100%;height:100%;object-fit:cover;display:block}
    .chatMain{min-width:0;flex:1}
    .chatHeadLine{display:flex;gap:8px;align-items:baseline;flex-wrap:wrap}
    .chatName{font-weight:900;font-size:12.5px}
    .chatTime{font-size:11.5px;color:var(--muted)}
    .chatText{margin-top:3px;font-size:13px;line-height:1.5;word-break:break-word}
    .chatInputRow{display:flex;gap:8px}
    .chatInput{
      flex:1;
      height:42px;
      border-radius:10px;
      border:1px solid #cfd6df;
      padding:0 12px;
      font-weight:800;
      outline:none;
      background:#fff;
      color:var(--text);
    }
    .chatInput:focus{box-shadow:0 0 0 3px rgba(42,120,201,.18)}


    /* ======= ADMIN ======= */
    .adminGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .adminCard{
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(255,255,255,.7);
      box-shadow: var(--shadow);
      padding:12px;
    }
    html[data-theme="dark"] .adminCard{background:rgba(0,0,0,.18)}
    .adminCardTitle{font-weight:950;margin-bottom:10px}
    .formRow{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .formRow label{font-size:12px;color:var(--muted);font-weight:900}
    .input, .textarea{
      border:1px solid #cfd6df;
      border-radius:10px;
      padding:10px 12px;
      font-weight:800;
      outline:none;
      background:#fff;
      color:var(--text);
    }
    .textarea{min-height:160px;resize:vertical;line-height:1.5;font-weight:700}
    .input:focus, .textarea:focus{box-shadow:0 0 0 3px rgba(42,120,201,.18)}
    .adminRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .adminSmall{font-size:12px;color:var(--muted)}
    @media (max-width: 860px){
      .adminGrid{grid-template-columns:1fr}
    }


    /* ======= Responsive ======= */
    @media (max-width: 760px){
      :root{ --hotCols: 4; }
      .wrap{margin-top:10px}

    @media (max-width: 560px){
      /* Header t·ª± xu·ªëng d√≤ng ƒë·ªÉ kh√¥ng b·ªã tr√†n (fix l·ªói AVT b·ªã l·ªách nh∆∞ ·∫£nh) */
      .topBar{flex-wrap:wrap; justify-content:flex-start;}
      .brand{flex:1 1 100%;}
      .topActions{
        flex:1 1 100%;
        width:100%;
        justify-content:space-between;
      }
    }

      .sectionHead{padding:10px}
      .contentPad{padding:10px}
    }
    @media (max-width: 420px){
      :root{ --hotCols: 2; }
      .hotGrid{gap:10px}

      /* Header compact ƒë·ªÉ kh√¥ng tr√†n ngang */
      .topBar{padding:8px 10px; gap:8px}
      .brandLogo{width:36px;height:36px}
      .brandText{font-size:16px}
      .topActions{gap:8px}
      .pillBtn{height:40px; padding:0 10px; gap:8px}
      .circleBtn{width:40px;height:40px}
      .onlinePill{min-width:62px}
      .onlineNum{font-size:16px}
      .vipPill{padding:0 12px}
      .vipText{display:none}
      .vipShort{display:inline}
      .avatarPill{min-width:60px; padding:0 8px; gap:8px}
      .caret{font-size:12px}
    }
  
    @media (max-width: 360px){
      .brandText{font-size:15px}
      .topActions{flex-wrap:wrap; justify-content:space-between; gap:6px}
      .pillBtn{height:38px}
      .circleBtn{width:38px;height:38px}
    }

    /* ======= PAGES: List view (Truy·ªán Hot / M·ªõi c·∫≠p nh·∫≠t / Ho√†n th√†nh) ======= */
    .pageHeader{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:12px 12px;
      background:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.00));
      border-bottom:1px solid var(--line);
          position:relative;
    }
    html[data-theme="dark"] .pageHeader{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.00));}
    .pageBackBtn{
      width:44px;height:44px;
      border-radius:10px;
      border:1px solid var(--line);
      background:var(--card);
      cursor:pointer;
      font-weight:950;
      flex:none;
    }
    .pageBackBtn:active{transform:translateY(1px)}
    .pageHeaderMain{min-width:0; flex:1}
    .crumb{font-size:12px;color:var(--muted);font-weight:800}
    .pageTitle{margin-top:2px;font-size:18px;font-weight:950;letter-spacing:.2px}
    .pageDesc{margin-top:4px;font-size:13px;color:var(--muted);line-height:1.5}
    .pageActionBtn{
      height:44px;
      border-radius:10px;
      border:1px solid #cfe3ff;
      background:#eef6ff;
      color:#1f5fa7;
      font-weight:950;
      cursor:pointer;
      flex:none;
      padding:0 12px;
      white-space:nowrap;
    }

.pageActionWrap{ position:relative; margin-left:auto; }
.fullMenu{
  position:absolute;
  right:0;
  top:calc(100% + 8px);
  width: 210px;
  background: var(--card);
  border:1px solid var(--line);
  box-shadow: var(--shadow);
  border-radius: 12px;
  overflow:hidden;
  z-index: 50;
}
.fullMenuTitle{
  padding:10px 12px;
  font-weight:800;
  color:#111827;
  background: linear-gradient(180deg, rgba(13,47,102,.06), rgba(13,47,102,0));
  border-bottom:1px solid var(--line);
  font-size:13px;
}
.fullMenuItem{
  width:100%;
  text-align:left;
  padding:10px 12px;
  border:0;
  background:transparent;
  font-weight:700;
  color:#111827;
  cursor:pointer;
}
.fullMenuItem:hover{ background: rgba(13,47,102,.06); }
.fullMenuItem.isActive{ background: rgba(13,47,102,.10); }
    html[data-theme="dark"] .pageActionBtn{
      border-color:#294b7a;
      background:rgba(42,120,201,.12);
      color:#93c5fd;
    }
    .pageFilters{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
    }
    .pageHint{font-size:12px;color:var(--muted);font-weight:800}

    .bigList{padding:0}
    .bigItem{
      display:grid;
      grid-template-columns: 92px 1fr;
      gap:12px;
      padding:12px;
      border-top:1px solid var(--line);
      cursor:pointer;
      background:var(--card);
    }
    .bigItem:first-child{border-top:0}
    .bigItem:hover{background:rgba(0,0,0,.02)}
    html[data-theme="dark"] .bigItem:hover{background:rgba(255,255,255,.03)}
    .bigCover{
      width:92px;
      aspect-ratio: 3/4;
      border-radius:10px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      background:linear-gradient(135deg,#d1d5db,#9ca3af);
    }
    .bigCover img{width:100%;height:100%;object-fit:cover;display:block}
    .bigTitle{
      font-weight:950;
      font-size:16px;
      line-height:1.2;
    }
    .bigAuthor{
      margin-top:4px;
      font-size:13px;
      color:var(--muted);
      font-style:italic;
      font-weight:700;
      display:flex;align-items:center;gap:6px;
    }
    .bigDesc{
      margin-top:6px;
      font-size:13px;
      color:var(--text);
      opacity:.95;
      line-height:1.55;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .bigBadges{margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .badgeBlue{
      display:inline-flex;align-items:center;justify-content:center;
      padding:4px 10px;
      border-radius:6px;
      background:#2a78c9;
      color:#fff;
      font-weight:950;
      font-size:12px;
    }
    .badgeFull{
      display:inline-flex;align-items:center;justify-content:center;
      padding:4px 10px;
      border-radius:6px;
      border:1px solid #22c55e;
      color:#15803d;
      background:#ecfdf5;
      font-weight:950;
      font-size:12px;
    }
    html[data-theme="dark"] .badgeFull{
      border-color:#16a34a;
      color:#86efac;
      background:rgba(22,163,74,.12);
    }
    @media (max-width: 520px){
      .bigItem{grid-template-columns: 84px 1fr}
      .bigCover{width:84px}
      .pageTitle{font-size:17px}
    }

</style>
</head>
<body>

  <!-- HEADER -->
  <header class="top">
    <div class="topBar">
      <div class="brand" id="homeBtn" title="Trang ch·ªß">
        <div class="brandLogo" aria-hidden="true">
          <!-- Logo ki·ªÉu gi·ªëng ·∫£nh: icon s√°ch + ch·ªØ TRUY·ªÜN Online -->
          <svg viewBox="0 0 64 64" width="34" height="34" role="img" aria-label="Logo">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="#ffffff" stop-opacity="0.98"/>
                <stop offset="1" stop-color="#dbeafe" stop-opacity="0.92"/>
              </linearGradient>
            </defs>
            <path d="M10 14c10 0 16 4 22 8 6-4 12-8 22-8 4 0 6 2 6 6v28c0 3-2 5-5 5-9 0-15 3-21 7-6-4-12-7-21-7-3 0-5-2-5-5V20c0-4 2-6 6-6Z" fill="rgba(255,255,255,.12)" stroke="rgba(255,255,255,.55)" stroke-width="2"/>
            <path d="M32 24v34" stroke="rgba(255,255,255,.65)" stroke-width="2"/>
            <path d="M12 20c8 0 13 3 20 7v29c-6-4-12-6-20-6V20Z" fill="url(#g1)" opacity="0.98"/>
            <path d="M52 20c-8 0-13 3-20 7v29c6-4 12-6 20-6V20Z" fill="url(#g1)" opacity="0.98"/>
          </svg>
        </div>
        <div class="brandTitle">
          <span class="brandText">TRUY·ªÜN Online</span>
        </div>
      </div>

      <div class="topActions">
  <div class="pillBtn hdrBtn onlinePill" id="onlinePill" title="Ng∆∞·ªùi ƒëang online">
    <span class="onlineGreenDot" id="onlineDot" aria-hidden="true"></span>
    <span class="onlineNum" id="onlineNum" aria-live="polite"></span>
  </div>

  <button class="circleBtn hdrBtn" id="searchBtn" aria-label="T√¨m ki·∫øm" title="T√¨m ki·∫øm">
    <span class="ico">üîç</span>
  </button>

  <button class="pillBtn vipPill" id="vipBtn" aria-label="N·∫°p VIP" title="N·∫°p VIP">
    <span class="vipCoin" aria-hidden="true">üí∞</span>
    <span class="vipText">N·∫°p VIP</span><span class="vipShort">N·∫°p</span>
  </button>

  <button class="circleBtn hdrBtn" id="themeBtn" aria-label="ƒê·ªïi giao di·ªán" title="ƒê·ªïi giao di·ªán">
    <span class="ico" id="themeIco">üåô</span>
  </button>

  <button class="circleBtn hdrBtn" id="notifBtn" aria-label="Th√¥ng b√°o" title="Th√¥ng b√°o">
    <span class="ico">üîî</span>
    <span class="badge" id="notifBadge" style="display:none">0</span>
  </button>

  <!-- Khi ƒëƒÉng nh·∫≠p: n√∫t n√†y s·∫Ω hi·ªÉn th·ªã AVT; ch∆∞a ƒëƒÉng nh·∫≠p: ‚ò∞ -->
  <button class="pillBtn hdrBtn avatarPill" id="menuBtn" aria-label="T√†i kho·∫£n & Menu">
    <span id="menuIcon">‚ò∞</span>
    <img id="menuAvatar" alt="Avatar" />
    <span class="caret" aria-hidden="true">‚ñæ</span>
  </button>
</div>
    </div>

    <div class="subline">
      ƒê·ªçc truy·ªán online m·ªõi nh·∫•t, ƒë·ªçc truy·ªán ch·ªØ, truy·ªán hay. T·ªïng h·ª£p v√† c·∫≠p nh·∫≠t li√™n t·ª•c, ƒë·∫ßy ƒë·ªß nh·∫•t.
    </div>
  </header>

  <div id="viewHome">

  <main class="wrap">

    <!-- TRUY·ªÜN ƒêANG ƒê·ªåC -->
    <section class="section" id="secReading">
      <div class="sectionHead">
        <div class="secTitle">üïì TRUY·ªÜN ƒêANG ƒê·ªåC</div>
        <div class="secRight">
          <button class="btn" id="btnLoginSmall" style="padding:8px 10px;border-radius:8px;display:none">ƒêƒÉng nh·∫≠p</button>
        </div>
      </div>
      <div id="readingList"></div>
      <div class="contentPad" id="readingEmpty" style="display:none">
        <div class="mutedBox">
          Ch∆∞a c√≥ truy·ªán ƒëang ƒë·ªçc. Khi b·∫°n m·ªü truy·ªán, m·ª•c n√†y s·∫Ω t·ª± hi·ªán.
        </div>
      </div>
    </section>

    <!-- TRUY·ªÜN HOT -->
    <section class="section" id="secHot">
      <div class="sectionHead">
        <div class="secTitle"><span>TRUY·ªÜN HOT</span> <span class="flame">üî•</span></div>
        <div class="secRight">
          <select class="select" id="hotCategory">
            <option value="all">TH·ªÇ LO·∫†I: T·∫§T C·∫¢</option>
          </select>
        </div>
      </div>
      <div class="contentPad">
        <div class="hotGrid" id="hotGrid"></div>
        <div class="hint" id="hotHint" style="padding-top:8px"></div>
      </div>
    </section>

    <!-- M·ªöI C·∫¨P NH·∫¨T -->
    <section class="section" id="secUpdate">
      <div class="sectionHead">
        <div class="secTitle">‚Üª M·ªöI C·∫¨P NH·∫¨T</div>
        <div class="secRight">
          <select class="select" id="updateCategory">
            <option value="all">TH·ªÇ LO·∫†I: T·∫§T C·∫¢</option>
          </select>
        </div>
      </div>
      <div id="updateList"></div>
      <div class="contentPad">
        <div class="hint" id="updateHint"></div>
      </div>
    </section>

<!-- TR√í CHUY·ªÜN -->
    <section class="section" id="secChat">
      <div class="sectionHead">
        <div class="secTitle">üí¨ TR√í CHUY·ªÜN C·ªòNG ƒê·ªíNG</div>
        <div class="secRight">
          <div class="hint" id="chatStatus"></div>
        </div>
      </div>
      <div class="contentPad">
        <div class="chatWrap">
          <div class="chatList" id="chatList"></div>
          <div class="chatInputRow">
            <input class="chatInput" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn..." maxlength="300" autocomplete="off" />
            <button class="btn primary" id="chatSend">G·ª≠i</button>
          </div>
          <div class="hint" id="chatHint">* ƒê·ªÉ g·ª≠i tin nh·∫Øn b·∫°n c·∫ßn ƒëƒÉng nh·∫≠p Google.</div>
        </div>
      </div>
    </section>

    <!-- TRUY·ªÜN HO√ÄN TH√ÄNH -->
    <section class="section" id="secCompleted">
      <div class="sectionHead">
        <div class="secTitle">‚úÖ TRUY·ªÜN HO√ÄN TH√ÄNH</div>
        <div class="secRight">
          <select class="select" id="completedCategory">
            <option value="all">TH·ªÇ LO·∫†I: T·∫§T C·∫¢</option>
          </select>
        </div>
      </div>
      <div id="completedList"></div>
      <div class="contentPad">
        <div class="hint" id="completedHint"></div>
      </div>
    </section>

    <!-- ADMIN (ch·ªâ hi·ªán v·ªõi admin) -->
    <section class="section" id="secAdmin" style="display:none">
      <div class="sectionHead">
        <div class="secTitle">üõ† QU·∫¢N TR·ªä (ADMIN)</div>
        <div class="secRight"><div class="hint" id="adminState"></div></div>
      </div>
      <div class="contentPad">
        <div class="mutedBox" style="margin:0 0 10px 0">
          ‚Ä¢ Khu n√†y ch·ªâ hi·ªán v·ªõi t√†i kho·∫£n admin.<br/>
          ‚Ä¢ D·ªØ li·ªáu s·∫Ω l∆∞u v√†o <b>Realtime Database</b>: <code>/stories</code> v√† <code>/chapters</code>.
        </div>

        <div class="adminGrid">
          <div class="adminCard">
            <div class="adminCardTitle">‚ûï Th√™m truy·ªán</div>

            <div class="formRow">
              <label>Ti√™u ƒë·ªÅ truy·ªán</label>
              <input class="input" id="aStoryTitle" placeholder="V√≠ d·ª•: V√¥ C·ª±c ƒê·∫°o Gi·ªõi" />
            </div>

            <div class="formRow">
              <label>T√°c gi·∫£ (tu·ª≥ ch·ªçn)</label>
              <input class="input" id="aStoryAuthor" placeholder="B√∫t danh" />
            </div>

            <div class="formRow">
              <label>Th·ªÉ lo·∫°i (ph√¢n c√°ch b·∫±ng d·∫•u ph·∫©y)</label>
              <input class="input" id="aStoryCats" placeholder="Ti√™n hi·ªáp, Huy·ªÅn huy·ªÖn, Ki·∫øm hi·ªáp" />
            </div>

            <div class="formRow">
              <label>·∫¢nh b√¨a (URL) (tu·ª≥ ch·ªçn)</label>
              <input class="input" id="aStoryCover" placeholder="https://..." />
            </div>

            <div class="formRow">
              <label>M√¥ t·∫£ (tu·ª≥ ch·ªçn)</label>
              <textarea class="textarea" id="aStoryDesc" placeholder="Gi·ªõi thi·ªáu ng·∫Øn v·ªÅ truy·ªán..."></textarea>
            </div>

            <div class="adminRow">
              <label style="display:flex;align-items:center;gap:8px;font-weight:900">
                <input type="checkbox" id="aStoryCompleted" />
                Ho√†n th√†nh (Full)
              </label>
              <span class="adminSmall">C√≥ th·ªÉ b·∫≠t/t·∫Øt sau b·∫±ng c√°ch s·ª≠a node story.</span>
            </div>

            <div class="btnRow" style="margin-top:10px">
              <button class="btn primary" id="aStorySave">L∆∞u truy·ªán</button>
              <button class="btn" id="aStoryReset">Xo√° nh·∫≠p</button>
            </div>

            <div class="hint" id="aStoryMsg"></div>
          </div>

          <div class="adminCard">
            <div class="adminCardTitle">üìÑ Th√™m ch∆∞∆°ng</div>

            <div class="formRow">
              <label>Ch·ªçn truy·ªán</label>
              <select class="select" id="aChapStory">
                <option value="">‚Äî Ch·ªçn truy·ªán ‚Äî</option>
              </select>
            </div>

            <div class="adminRow">
              <div class="formRow" style="flex:1;min-width:140px;margin:0">
                <label>S·ªë ch∆∞∆°ng</label>
                <input class="input" id="aChapNo" type="number" min="1" step="1" placeholder="1" />
              </div>
              <div class="formRow" style="flex:2;min-width:180px;margin:0">
                <label>Ti√™u ƒë·ªÅ ch∆∞∆°ng (tu·ª≥ ch·ªçn)</label>
                <input class="input" id="aChapTitle" placeholder="Ch∆∞∆°ng 1: ..." />
              </div>
            </div>

            <div class="formRow" style="margin-top:10px">
              <label>N·ªôi dung ch∆∞∆°ng (h·ªó tr·ª£ xu·ªëng d√≤ng; c√≥ th·ªÉ d√°n HTML &lt;p&gt;...)</label>
              <textarea class="textarea" id="aChapContent" placeholder="D√°n n·ªôi dung ch∆∞∆°ng v√†o ƒë√¢y..."></textarea>
            </div>

            <div class="btnRow">
              <button class="btn primary" id="aChapSave">ƒêƒÉng ch∆∞∆°ng</button>
              <button class="btn" id="aChapReset">Xo√° nh·∫≠p</button>
            </div>

            <div class="hint" id="aChapMsg"></div>
            <div class="mutedBox" style="margin-top:10px">
              M·∫πo: n·∫øu truy·ªán c√≥ nhi·ªÅu ch∆∞∆°ng (r·∫•t nhi·ªÅu), m√¨nh s·∫Ω n√¢ng c·∫•p th√†nh <b>import h√†ng lo·∫°t</b> (d√°n nhi·ªÅu ch∆∞∆°ng m·ªôt l·∫ßn) + <b>ph√¢n trang</b> ·ªü trang ƒë·ªçc.
            </div>
          </div>
        </div>
      </div>
    </section>


  
  </main>
</div>

<div id="viewList" style="display:none">
  <main class="wrap">
    <section class="section" style="overflow:visible">
      <div class="pageHeader">
        <button class="pageBackBtn" id="listBackBtn" aria-label="Quay l·∫°i trang ch·ªß" title="Quay l·∫°i">‚Üê</button>
        <div class="pageHeaderMain">
          <div class="crumb" id="listCrumb">Trang ch·ªß / ...</div>
          <div class="pageTitle" id="listTitle">‚Äî</div>
          <div class="pageDesc" id="listDesc">‚Äî</div>
        </div>
        <div class="pageActionWrap">
  <button class="pageActionBtn" id="listFullBtn" title="L·ªçc Full">L·ªåC FULL</button>
  <div class="fullMenu" id="listFullMenu" hidden>
    <div class="fullMenuTitle">X·∫øp h·∫°ng Hot theo l∆∞·ª£t xem</div>
<button class="fullMenuItem" data-hot-range="all">To√†n b·ªô</button>
    <button class="fullMenuItem" data-hot-range="day">Hot ng√†y</button>
    <button class="fullMenuItem" data-hot-range="week">Hot tu·∫ßn</button>
    <button class="fullMenuItem" data-hot-range="month">Hot th√°ng</button>
  </div>
</div>
      </div>

      <div class="pageFilters">
        <select class="select" id="listCategory">
          <option value="all">TH·ªÇ LO·∫†I: T·∫§T C·∫¢</option>
        </select>
        <div class="pageHint" id="listHint"></div>
      </div>

      <div class="bigList" id="listBox"></div>
    </section>
  </main>
</div>

  <!-- DRAWER -->

  <div class="drawerBg" id="drawerBg" aria-hidden="true">
    <aside class="drawer" role="dialog" aria-modal="true">
      <div class="drawerTop">
        <b>Truy·ªán Online</b>
        <small id="drawerUser">Ch∆∞a ƒëƒÉng nh·∫≠p</small>
      </div>
      <div class="drawerBody">
        <button class="drawerBtn" id="navHome">üè† Trang ch·ªß <span class="r">‚Ä∫</span></button>
        <button class="drawerBtn" id="navHistory">üïò L·ªãch s·ª≠ ƒë·ªçc <span class="r">‚Ä∫</span></button>
        <button class="drawerBtn" id="navProfile">üë§ H·ªì s∆° <span class="r">‚Ä∫</span></button>
        <div class="divider"></div>
        <button class="drawerBtn" id="navAdmin" style="display:none">üõ† Qu·∫£n tr·ªã (Admin) <span class="r">‚Ä∫</span></button>
        <button class="drawerBtn" id="navLogin">üîê ƒêƒÉng nh·∫≠p Google <span class="r" id="loginState">‚Ä∫</span></button>
        <button class="drawerBtn" id="navLogout" style="display:none">üö™ ƒêƒÉng xu·∫•t <span class="r">‚Ä∫</span></button>
        <div class="divider"></div>
        <div class="hint">* Menu n√†y gi·ªëng n√∫t ‚ò∞ tr√™n ·∫£nh. C√°c trang chi ti·∫øt (h·ªì s∆°/ƒë·ªçc truy·ªán) s·∫Ω m·ªü d·∫ßn ·ªü b∆∞·ªõc sau.</div>
      </div>
    </aside>
  </div>


  <!-- SEARCH -->
  <div class="searchBg" id="searchBg" aria-hidden="true">
    <div class="searchBox" role="dialog" aria-modal="true" aria-label="T√¨m ki·∫øm">
      <div class="searchHead">
        <input class="searchInput" id="searchInput" placeholder="T√¨m truy·ªán..." autocomplete="off" />
        <button class="closeBtn" id="searchClose" aria-label="ƒê√≥ng t√¨m ki·∫øm">‚úï</button>
      </div>
      <div class="searchBody" id="searchResults"></div>
    </div>
  </div>

  <!-- MODAL STORY -->
  <div class="modalBg" id="modalBg" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <b id="modalTitle">‚Äî</b>
        <button class="closeBtn" id="modalClose" aria-label="ƒê√≥ng">‚úï</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <script type="module">
    // ===== Firebase (modular) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getDatabase, ref, get, set, update, push, onValue, onDisconnect, remove, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDhq66ZZzNp9_-FnY7T-2gxNlrUDxeDPrU",
      authDomain: "truyen-b3470.firebaseapp.com",
      databaseURL: "https://truyen-b3470-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "truyen-b3470",
      storageBucket: "truyen-b3470.firebasestorage.app",
      messagingSenderId: "93210370757",
      appId: "1:93210370757:web:87828b963906ac862f46ac"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // ===== Helpers =====
    const $ = (id)=>document.getElementById(id);
    const esc = (s)=>String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const fmtNum = (n)=> (n==null? "‚Äî" : ("C. " + n));
    const num = (v)=>{ const n = Number(v); return Number.isFinite(n) ? n : 0; };
    const toLower = (s)=>String(s||"").toLowerCase();
    // ===== Fixed header offset (ƒë·ªÉ header lu√¥n c·ªë ƒë·ªãnh khi cu·ªôn) =====
    function syncTopOffset(){
      const header = document.querySelector("header.top");
      if(!header) return;
      const h = header.getBoundingClientRect().height || header.offsetHeight || 0;
      document.documentElement.style.setProperty("--topH", Math.ceil(h) + "px");
    }
    window.addEventListener("resize", syncTopOffset);
    window.addEventListener("orientationchange", syncTopOffset);
    try{
      if(window.ResizeObserver){
        const ro = new ResizeObserver(()=>syncTopOffset());
        const header = document.querySelector("header.top");
        if(header) ro.observe(header);
      }
    }catch(e){}
    requestAnimationFrame(syncTopOffset);


    // ===== Simple Router (Hash) cho "kh√¥ng gian ri√™ng" =====
    const viewHome = document.getElementById("viewHome");
    const viewList = document.getElementById("viewList");

    function getRoute(){
      const h = (location.hash || "#/").replace(/^#\/?/, "");
      return h || "home"; // home | hot | update | completed
    }
    function go(route){
      if(route === "home") location.hash = "#/";
      else location.hash = "#/" + route;
    }
    function showView(route){
      const isHome = (route === "home");
      const menu = document.getElementById("listFullMenu");
      if(menu) menu.hidden = true;
      if(viewHome) viewHome.style.display = isHome ? "block" : "none";
      if(viewList) viewList.style.display = isHome ? "none" : "block";
      window.scrollTo({ top: 0, behavior: "instant" });
    }

    // Hot ranking range: day / week / month / all
let hotRankRange = (localStorage.getItem("hotRankRange") || "all");
const HOT_RANGE_LABEL = { day:"HOT NG√ÄY", week:"HOT TU·∫¶N", month:"HOT TH√ÅNG", all:"HOT TO√ÄN B·ªò" };

function getHotViewsKey(){
  return hotRankRange==="day" ? "viewsDay"
    : hotRankRange==="week" ? "viewsWeek"
    : hotRankRange==="month" ? "viewsMonth"
    : "viewsAll";
}

function setListHeader(route){
  const crumb = document.getElementById("listCrumb");
  const title = document.getElementById("listTitle");
  const desc  = document.getElementById("listDesc");
  const fullBtn = document.getElementById("listFullBtn");

  const map = {
    hot: { t: "T·ªîNG H·ª¢P TRUY·ªÜN HAY V√Ä HOT NH·∫§T", d: "T·ªïng h·ª£p nh·ªØng truy·ªán Hot, truy·ªán hay nh·∫•t c√≥ l∆∞·ª£t xem cao v√† ƒë∆∞·ª£c ƒë·ªôc gi·∫£ b√¨nh ch·ªçn." },
    update: { t: "TRUY·ªÜN M·ªöI C·∫¨P NH·∫¨T", d: "Danh s√°ch truy·ªán v·ª´a c·∫≠p nh·∫≠t ch∆∞∆°ng m·ªõi, s·∫Øp x·∫øp theo th·ªùi gian c·∫≠p nh·∫≠t." },
    completed: { t: "TRUY·ªÜN HO√ÄN TH√ÄNH (FULL)", d: "T·ªïng h·ª£p truy·ªán ƒë√£ ho√†n th√†nh. B·∫°n c√≥ th·ªÉ ƒë·ªçc tr·ªçn b·ªô t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi." }
  };
  const it = map[route] || { t:"DANH S√ÅCH TRUY·ªÜN", d:"" };

  if(crumb) crumb.textContent = "Trang ch·ªß / " + (route==="hot" ? "Truy·ªán Hot" : route==="update" ? "M·ªõi c·∫≠p nh·∫≠t" : "Truy·ªán ho√†n th√†nh");
  if(title) title.textContent = it.t;
  if(desc)  desc.textContent  = it.d;

  // "L·ªåC FULL" tr√™n trang Hot: m·ªü menu x·∫øp h·∫°ng theo l∆∞·ª£t xem (ng√†y/tu·∫ßn/th√°ng/to√†n b·ªô)
  if(fullBtn){
    if(route === "hot"){
      fullBtn.style.display = "inline-flex";
      fullBtn.textContent = "L·ªåC FULL";
      fullBtn.setAttribute("data-mode", hotRankRange);
    }else{
      fullBtn.style.display = "none";
    }
  }

  document.title = (route==="hot" ? "Truy·ªán Hot" : route==="update" ? "M·ªõi c·∫≠p nh·∫≠t" : route==="completed" ? "Truy·ªán ho√†n th√†nh" : "Truy·ªán Online") + " ‚Ä¢ Truy·ªán Online";
}

function renderListPage(route){
      setListHeader(route);

      const sel = document.getElementById("listCategory");
      const hint = document.getElementById("listHint");
      const box = document.getElementById("listBox");

      if(!sel || !box) return;

      // ƒë·ªï th·ªÉ lo·∫°i
      fillCategorySelect(sel, categories);

      const cat = sel.value || "all";

// Hint: hot range
if(route === "hot" && hint){
  hint.textContent = "X·∫øp h·∫°ng: " + (HOT_RANGE_LABEL[hotRankRange] || "HOT TO√ÄN B·ªò");
}else if(hint && route !== "hot"){
  hint.textContent = "";
}

      let list = stories.slice();

      if(route === "hot"){
        const k = getHotViewsKey();
        list.sort((a,b)=> (num(b[k]) - num(a[k])) || (num(b.hotScore)-num(a.hotScore)) || (num(b.views)-num(a.views)) || (num(b.updatedAt)-num(a.updatedAt)));
      }else if(route === "update"){
        list.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0) || (b.latestChapNo||0) - (a.latestChapNo||0));
      }else if(route === "completed"){
        list = list.filter(s=> isCompletedStory(s));
        list.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0) || (b.views||0)-(a.views||0));
      }

      if(cat !== "all"){
        list = list.filter(s => (s.categories||[]).includes(cat));
      }

      const limit = route === "hot" ? 40 : 60;
      list = list.slice(0, limit);

      if(!list.length){
        box.innerHTML = '<div class="contentPad"><div class="mutedBox">Ch∆∞a c√≥ truy·ªán ph√π h·ª£p trong d·ªØ li·ªáu Firebase.</div></div>';
        if(hint) hint.textContent = "";
        return;
      }

      if(hint) hint.textContent = "Hi·ªÉn th·ªã " + list.length + " truy·ªán" + (cat==="all" ? "" : (" ‚Ä¢ " + cat));

      box.innerHTML = list.map(s=>{
        const author = s.author ? esc(s.author) : "";
        const chap = (s.latestChapNo ?? s.chapterCount);
        const chapText = chap != null ? ("Ch∆∞∆°ng " + chap) : "Ch∆∞∆°ng ‚Äî";
        const full = isCompletedStory(s);
        const desc = (s.desc || "").trim() || "Ch∆∞a c√≥ m√¥ t·∫£.";
        return `
          <div class="bigItem" data-story="${esc(s.id)}">
            <div class="bigCover">${s.coverUrl ? `<img src="${esc(s.coverUrl)}" alt="">` : ""}</div>
            <div>
              <div class="bigTitle">${esc(s.title)}</div>
              ${author ? `<div class="bigAuthor">‚úçÔ∏è ${author}</div>` : ``}
              <div class="bigDesc">${esc(desc)}</div>
              <div class="bigBadges">
                <span class="badgeBlue">${esc(chapText)}</span>
                ${full ? `<span class="badgeFull">Full</span>` : ``}
              </div>
            </div>
          </div>
        `;
      }).join("");

      box.querySelectorAll("[data-story]").forEach(row=>{
        row.addEventListener("click", ()=>{
          const id = row.getAttribute("data-story");
          const st = stories.find(x=>x.id===id);
          openStoryModal(st);
        });
      });
    }

    function applyRoute(){
      const r = getRoute();
      if(!["home","hot","update","completed"].includes(r)){
        go("home");
        return;
      }
      showView(r);
      if(r !== "home"){
        renderListPage(r);
      }else{
        document.title = "Truy·ªán Online";
      }
    }

    window.addEventListener("hashchange", applyRoute);



    // ===== UI: Drawer =====
    function openDrawer(){ $("drawerBg").style.display="block"; $("drawerBg").setAttribute("aria-hidden","false"); }
    function closeDrawer(){ $("drawerBg").style.display="none"; $("drawerBg").setAttribute("aria-hidden","true"); }
    $("menuBtn").addEventListener("click", openDrawer);
    $("drawerBg").addEventListener("click", (e)=>{ if(e.target.id==="drawerBg") closeDrawer(); });

    // ===== UI: Search =====
    function openSearch(){
      $("searchBg").style.display = "block";
      $("searchBg").setAttribute("aria-hidden","false");
      $("searchInput").value = "";
      renderSearch("");
      setTimeout(()=> $("searchInput").focus(), 50);
    }
    function closeSearch(){
      $("searchBg").style.display = "none";
      $("searchBg").setAttribute("aria-hidden","true");
      $("searchResults").innerHTML = "";
    }
    $("searchBtn").addEventListener("click", openSearch);
    $("searchClose").addEventListener("click", closeSearch);
    $("searchBg").addEventListener("click", (e)=>{ if(e.target.id==="searchBg") closeSearch(); });
    $("searchInput").addEventListener("input", (e)=> renderSearch(e.target.value));

    // VIP + Th√¥ng b√°o (placeholder UI)
    $("vipBtn").addEventListener("click", ()=>{
      alert("N·∫°p VIP: m√¨nh s·∫Ω n·ªëi thanh to√°n (MoMo/Stripe...) ·ªü b∆∞·ªõc ti·∫øp theo.");
    });
    $("notifBtn").addEventListener("click", ()=>{
      if(!currentUser) return alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem th√¥ng b√°o.");
      alert("Th√¥ng b√°o: m√¨nh s·∫Ω l√†m danh s√°ch th√¥ng b√°o + chu√¥ng c√≥ badge ·ªü b∆∞·ªõc ti·∫øp theo.");
    });

    // ===== Online counter (Realtime Database presence) =====
    function setOnlineCount(n){
      const dot = $("onlineDot");
      const num = $("onlineNum");
      // Lu√¥n hi·ªÉn th·ªã s·ªë ƒë·ªÉ tr√°nh b·ªã tr·ªëng
      if(n == null || Number.isNaN(Number(n))){
        dot.style.opacity = ".55";
        num.textContent = "--";
        return;
      }
      const v = Math.max(0, Math.floor(Number(n)));
      dot.style.opacity = v > 0 ? "1" : ".75";
      num.textContent = String(v);
    }
    // m·∫∑c ƒë·ªãnh (tr∆∞·ªõc khi Firebase tr·∫£ v·ªÅ)
    setOnlineCount(0);
    // Listen online users (t√≠nh trong 60s g·∫ßn nh·∫•t)
    const _presenceListRef = ref(db, "presence/users");
    onValue(_presenceListRef, (snap)=>{
      const now = Date.now();
      const val = snap.exists() ? (snap.val()||{}) : {};
      // t√≠nh nh·ªØng ng∆∞·ªùi c√≥ heartbeat trong 90 gi√¢y g·∫ßn nh·∫•t (mobile ƒë√¥i khi delay)
      const count = Object.values(val).filter(x => x && (now - (x.lastActive||0) < 90000)).length;
      setOnlineCount(count);
    }, (err)=>{
      console.warn("presence/users read blocked:", err);
      // N·∫øu Rules ch·∫∑n read, v·∫´n hi·ªÉn th·ªã ƒë·ªÉ kh√¥ng b·ªã tr·ªëng
      setOnlineCount(null);
    });

    // Presence for current user
    let _presenceTimer = null;
    let _presenceConnectedUnsub = null;

    function startPresence(u){
      // cleanup
      if(_presenceTimer){ clearInterval(_presenceTimer); _presenceTimer = null; }
      if(_presenceConnectedUnsub){ try{ _presenceConnectedUnsub(); }catch(e){} _presenceConnectedUnsub = null; }

      if(!u) return;

      const pRef = ref(db, "presence/users/" + u.uid);
      const connectedRef = ref(db, ".info/connected");

      const writePresence = ()=>{
        return set(pRef, { uid: u.uid, name: u.displayName||"", lastActive: Date.now() })
          .catch(e=>console.warn("presence write blocked:", e));
      };

      // Ch·ªâ set onDisconnect khi ƒë√£ connect th·∫≠t s·ª±
      _presenceConnectedUnsub = onValue(connectedRef, (snap)=>{
        if(snap.val() === true){
          writePresence();
          onDisconnect(pRef).remove().catch(e=>console.warn("onDisconnect failed:", e));
        }
      }, (err)=>{
        console.warn(".info/connected read blocked:", err);
      });

      // heartbeat
      _presenceTimer = setInterval(writePresence, 25000);
    }

    // Menu button: ƒë·ªïi ‚ò∞ ‚Üî avatar khi ƒëƒÉng nh·∫≠p
    function syncMenuAvatar(u){
      const icon = $("menuIcon");
      const img = $("menuAvatar");
      if(u && u.photoURL){
        img.src = u.photoURL;
        img.style.display = "block";
        icon.style.display = "none";
      }else if(u){
        img.style.display = "none";
        icon.style.display = "block";
        // fallback: ch·ªØ c√°i ƒë·∫ßu n·∫øu kh√¥ng c√≥ ·∫£nh
        const t = (u.displayName || u.email || "U").trim();
        icon.textContent = (t[0] || "U").toUpperCase();
      }else{
        img.style.display = "none";
        icon.style.display = "block";
        icon.textContent = "‚ò∞";
      }
    }

    // ===== Theme (theo h·ªá th·ªëng + n√∫t üåô/‚òÄÔ∏è) =====
const THEME_KEY = "truyen_theme";
const mqDark = window.matchMedia ? window.matchMedia("(prefers-color-scheme: dark)") : null;

function getThemePref(){
  return localStorage.getItem(THEME_KEY) || "system"; // system | light | dark
}
function isDarkNow(themePref){
  if(themePref === "dark") return true;
  if(themePref === "light") return false;
  return mqDark ? mqDark.matches : false;
}
function syncThemeIcon(themePref){
  const el = $("themeIco");
  if(!el) return;
  el.textContent = isDarkNow(themePref) ? "üåô" : "‚òÄÔ∏è";
}
function syncThemeColor(themePref){
  const meta = document.querySelector('meta[name="theme-color"]');
  if(!meta) return;
  meta.setAttribute("content", isDarkNow(themePref) ? "#061225" : "#0d2f66");}
function applyTheme(themePref, persist=true){
  const root = document.documentElement;
  if(themePref === "dark") root.dataset.theme = "dark";
  else if(themePref === "light") root.dataset.theme = "light";
  else root.removeAttribute("data-theme"); // system
  if(persist) localStorage.setItem(THEME_KEY, themePref);
  syncThemeIcon(themePref);
  syncThemeColor(themePref);
}
function nextThemePref(curr){
  if(curr === "system") return isDarkNow("system") ? "light" : "dark";
  if(curr === "dark") return "light";
  return "dark";
}

// √°p d·ª•ng l√∫c load
applyTheme(getThemePref(), false);

// ƒë·ªïi theo h·ªá th·ªëng n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô system
mqDark?.addEventListener?.("change", ()=>{
  if(getThemePref() === "system"){
    syncThemeIcon("system");
    syncThemeColor("system");
  }
});

// n√∫t ƒë·ªïi theme
$("themeBtn")?.addEventListener("click", ()=>{
  const cur = getThemePref();
  applyTheme(nextThemePref(cur));
});


    // ===== UI: Modal =====
    function openModal(title, bodyHtml){
      $("modalTitle").textContent = title;
      $("modalBody").innerHTML = bodyHtml;
      $("modalBg").style.display = "block";
      $("modalBg").setAttribute("aria-hidden","false");
    }
    function closeModal(){
      $("modalBg").style.display = "none";
      $("modalBg").setAttribute("aria-hidden","true");
      $("modalBody").innerHTML = "";
    }
    $("modalClose").addEventListener("click", closeModal);
    $("modalBg").addEventListener("click", (e)=>{ if(e.target.id==="modalBg") closeModal(); });

    // ===== Auth =====
    let currentUser = null;

    async function ensureUserDoc(u){
      if(!u) return;
      const userRef = ref(db, "users/" + u.uid);
      const snap = await get(userRef);
      if(!snap.exists()){
        await set(userRef, {
          uid: u.uid,
          displayName: u.displayName || "",
          email: u.email || "",
          photoURL: u.photoURL || "",
          createdAt: Date.now(),
          lastLoginAt: Date.now()
        });
      }else{
        await update(userRef, { lastLoginAt: Date.now(), displayName: u.displayName||"", photoURL: u.photoURL||"" });
      }
    }

    async function login(){
      try{
        await signInWithPopup(auth, provider);
        closeDrawer();
      }catch(err){
        alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + (err?.message || err));
      }
    }
    async function logout(){
      await signOut(auth);
      closeDrawer();
    }

    $("navLogin").addEventListener("click", login);
    $("btnLoginSmall").addEventListener("click", login);
    $("navLogout").addEventListener("click", logout);

    // Placeholder routes (b∆∞·ªõc sau n√¢ng c·∫•p)
    $("navHome").addEventListener("click", ()=>{ closeDrawer(); window.scrollTo({top:0, behavior:"smooth"}); });
    $("navProfile").addEventListener("click", ()=>{ closeDrawer(); alert("Trang H·ªì s∆°: s·∫Ω l√†m ·ªü b∆∞·ªõc ti·∫øp theo (ƒë√∫ng y√™u c·∫ßu b·∫°n)."); });
    $("navHistory").addEventListener("click", ()=>{ closeDrawer(); alert("Trang L·ªãch s·ª≠: s·∫Ω l√†m ·ªü b∆∞·ªõc ti·∫øp theo."); });
    $("navAdmin")?.addEventListener("click", ()=>{ closeDrawer(); document.getElementById("secAdmin")?.scrollIntoView({behavior:"smooth"}); });
    $("homeBtn").addEventListener("click", ()=> window.scrollTo({top:0, behavior:"smooth"}));

    // ===== ƒêi·ªÅu h∆∞·ªõng: b·∫•m v√†o c√°c m·ª•c ·ªü trang ch·ªß ƒë·ªÉ sang "kh√¥ng gian ri√™ng" =====
    function bindHomeSectionNav(){
      const hotHead = document.querySelector("#secHot .sectionHead");
      const updHead = document.querySelector("#secUpdate .sectionHead");
      const comHead = document.querySelector("#secCompleted .sectionHead");

      hotHead?.addEventListener("click", (e)=>{ if(e.target.closest("select") || e.target.closest("button")) return; go("hot"); });
      updHead?.addEventListener("click", (e)=>{ if(e.target.closest("select") || e.target.closest("button")) return; go("update"); });
      comHead?.addEventListener("click", (e)=>{ if(e.target.closest("select") || e.target.closest("button")) return; go("completed"); });

      // th√™m cursor ƒë·ªÉ nh√¨n gi·ªëng link
      [hotHead, updHead, comHead].forEach(h=>{ if(h) h.style.cursor="pointer"; });
    }
    bindHomeSectionNav();

    // List page controls
    document.getElementById("listBackBtn")?.addEventListener("click", ()=> go("home"));
    document.getElementById("listCategory")?.addEventListener("change", ()=> renderListPage(getRoute()));
    document.getElementById("listFullBtn")?.addEventListener("click", (e)=>{
  const r = getRoute();
  if(r !== "hot") return;

  const menu = document.getElementById("listFullMenu");
  if(!menu) return;

  // toggle menu
  menu.hidden = !menu.hidden;

  // set active
  menu.querySelectorAll(".fullMenuItem").forEach(btn=>{
    btn.classList.toggle("isActive", btn.getAttribute("data-hot-range") === hotRankRange);
  });

  e.stopPropagation();
});

// ch·ªçn range trong menu
document.getElementById("listFullMenu")?.addEventListener("click", (e)=>{
  const btn = e.target?.closest?.(".fullMenuItem");
  if(!btn) return;
  const range = btn.getAttribute("data-hot-range");
  if(!range) return;
  hotRankRange = range;
  localStorage.setItem("hotRankRange", hotRankRange);

  // ƒë√≥ng menu + render l·∫°i
  const menu = document.getElementById("listFullMenu");
  if(menu) menu.hidden = true;
  renderListPage("hot");
  e.stopPropagation();
});

// click ngo√†i ƒë·ªÉ ƒë√≥ng menu
document.addEventListener("click", ()=>{
  const menu = document.getElementById("listFullMenu");
  if(menu && !menu.hidden) menu.hidden = true;
});
onAuthStateChanged(auth, async (u)=>{
      currentUser = u || null;
      syncMenuAvatar(currentUser);
      startPresence(currentUser);
      if(u) await ensureUserDoc(u);

      $("drawerUser").textContent = u ? (u.displayName || u.email || "ƒê√£ ƒëƒÉng nh·∫≠p") : "Ch∆∞a ƒëƒÉng nh·∫≠p";
      $("navLogout").style.display = u ? "block" : "none";
      $("btnLoginSmall").style.display = u ? "none" : "inline-flex";
      $("loginState").textContent = u ? "‚úì" : "‚Ä∫";

      // badge th√¥ng b√°o (n·∫øu b·∫°n c√≥ l∆∞u userData/{uid}/notificationsUnread = number)
      try{
        if(u){
          onValue(ref(db, `userData/${u.uid}/notificationsUnread`), (sn)=>{
            const n = sn.exists() ? (sn.val()||0) : 0;
            const b = $("notifBadge");
            if(n>0){
              b.textContent = n>99 ? "99+" : String(n);
              b.style.display = "grid";
            }else{
              b.style.display = "none";
            }
          });
        }else{
          $("notifBadge").style.display = "none";
        }
      }catch(e){}

      await loadReading(); // ph·ª• thu·ªôc user

      // Admin UI
      const adminOk = toggleAdminUI(currentUser);
      if(adminOk){
        bindAdminUIOnce();
        await refreshAdminStorySelect();
      }


    // ===== Chat c·ªông ƒë·ªìng (Realtime Database) =====
    // Data: chat/messages/{pushId}: { uid, name, photoURL, text, createdAt }
    const chatListEl = $("chatList");
    const chatInputEl = $("chatInput");
    const chatSendBtn = $("chatSend");
    const chatStatusEl = $("chatStatus");
    const chatHintEl = $("chatHint");

    let _lastChatSendAt = 0;

    function renderChatMessages(list){
      if(!chatListEl) return;
      if(!list.length){
        chatListEl.innerHTML = '<div class="searchEmpty">Ch∆∞a c√≥ tin nh·∫Øn n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</div>';
        return;
      }
      const atBottom = (chatListEl.scrollTop + chatListEl.clientHeight >= chatListEl.scrollHeight - 40);

      chatListEl.innerHTML = list.map(m=>{
        const name = esc(m?.name || "Ng∆∞·ªùi d√πng");
        const t = m?.createdAt ? new Date(m.createdAt).toLocaleString("vi-VN", { hour:"2-digit", minute:"2-digit", day:"2-digit", month:"2-digit" }) : "";
        const text = esc(m?.text || "");
        const photo = m?.photoURL ? esc(m.photoURL) : "";
        const letter = (name.trim()[0] || "U").toUpperCase();
        return `
          <div class="chatMsg">
            <div class="chatAvt">${photo ? `<img src="${photo}" alt="">` : letter}</div>
            <div class="chatMain">
              <div class="chatHeadLine">
                <div class="chatName">${name}</div>
                <div class="chatTime">${t}</div>
              </div>
              <div class="chatText">${text}</div>
            </div>
          </div>
        `;
      }).join("");

      if(atBottom) chatListEl.scrollTop = chatListEl.scrollHeight;
    }

    function watchChat(){
      chatStatusEl.textContent = "ƒêang t·∫£i‚Ä¶";
      const qRef = query(ref(db, "chat/messages"), orderByChild("createdAt"), limitToLast(60));
      onValue(qRef, (snap)=>{
        const val = snap.exists() ? (snap.val() || {}) : {};
        const arr = Object.values(val)
          .filter(Boolean)
          .sort((a,b)=> (a.createdAt||0) - (b.createdAt||0));
        renderChatMessages(arr);
        chatStatusEl.textContent = "Live";
        chatHintEl.textContent = currentUser ? "* Chat ƒëang ho·∫°t ƒë·ªông." : "* ƒê·ªÉ g·ª≠i tin nh·∫Øn b·∫°n c·∫ßn ƒëƒÉng nh·∫≠p Google.";
      }, (err)=>{
        chatStatusEl.textContent = "L·ªói";
        chatListEl.innerHTML = '<div class="mutedBox">Kh√¥ng th·ªÉ t·∫£i chat. N·∫øu b·∫°n mu·ªën b·∫≠t chat, h√£y m·ªü quy·ªÅn ƒë·ªçc/ghi cho node <b>/chat/messages</b> trong Realtime Database Rules.</div>';
        console.warn(err);
      });
    }

    async function sendChat(){
      const text = (chatInputEl.value || "").trim();
      if(!text) return;

      if(!currentUser){
        alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ chat v·ªõi m·ªçi ng∆∞·ªùi.");
        openDrawer();
        return;
      }

      const now = Date.now();
      if(now - _lastChatSendAt < 2000){
        chatHintEl.textContent = "B·∫°n g·ª≠i qu√° nhanh, th·ª≠ l·∫°i sau 2 gi√¢y.";
        return;
      }
      _lastChatSendAt = now;

      try{
        const msgRef = push(ref(db, "chat/messages"));
        await set(msgRef, {
          uid: currentUser.uid,
          name: currentUser.displayName || currentUser.email || "Ng∆∞·ªùi d√πng",
          photoURL: currentUser.photoURL || "",
          text: text.slice(0, 300),
          createdAt: now
        });
        chatInputEl.value = "";
        chatHintEl.textContent = "* ƒê√£ g·ª≠i.";
      }catch(err){
        console.warn(err);
        chatHintEl.textContent = "Kh√¥ng g·ª≠i ƒë∆∞·ª£c. C√≥ th·ªÉ Rules ƒëang ch·∫∑n ghi /chat/messages.";
        alert("Kh√¥ng g·ª≠i ƒë∆∞·ª£c tin nh·∫Øn. Ki·ªÉm tra Realtime Database Rules cho /chat/messages.");
      }
    }

    chatSendBtn?.addEventListener("click", sendChat);
    chatInputEl?.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        sendChat();
      }
    });

    watchChat();

    });

    // ===== Data model (Realtime Database)
    // stories/{storyId}: { title, coverUrl, categories: "Ti√™n hi·ªáp,..." OR ["..."], latestChapNo, chapterCount, updatedAt, views, hotScore, desc }
    // userData/{uid}/reading/{storyId}: { storyId, chapNo, updatedAt }
    // =====

    // ===== Story cache =====
    let stories = []; // normalized
    let categories = [];

    function normalizeStory(id, raw){
      const cats = Array.isArray(raw?.categories)
        ? raw.categories
        : String(raw?.categories||"").split(",").map(s=>s.trim()).filter(Boolean);

      // Views fields (hot theo ng√†y/tu·∫ßn/th√°ng/to√†n b·ªô)
      // ∆Øu ti√™n c√°c field r√µ r√†ng; n·∫øu kh√¥ng c√≥ th√¨ fallback v·ªÅ views t·ªïng.
      const vAll = num(raw?.viewsAll ?? raw?.viewsTotal ?? raw?.views ?? raw?.view ?? 0);
      const vMonth = num(raw?.viewsMonth ?? raw?.viewMonth ?? raw?.monthViews ?? raw?.views30d ?? vAll);
      const vWeek  = num(raw?.viewsWeek  ?? raw?.viewWeek  ?? raw?.weekViews  ?? raw?.views7d  ?? vMonth);
      const vDay   = num(raw?.viewsDay   ?? raw?.viewDay   ?? raw?.dayViews   ?? raw?.views1d  ?? vWeek);

      return {
        id,
        title: raw?.title || raw?.name || "Kh√¥ng t√™n",
        coverUrl: raw?.coverUrl || raw?.cover || raw?.image || "",
        categories: cats,
        chapterCount: raw?.chapterCount ?? raw?.chapters ?? raw?.chap ?? raw?.totalChapters ?? null,
        latestChapNo: raw?.latestChapNo ?? raw?.latestChap ?? raw?.latest ?? null,
        updatedAt: raw?.updatedAt ?? raw?.updated ?? raw?.time ?? null,

        // views t·ªïng (gi·ªØ l·∫°i t∆∞∆°ng th√≠ch ch·ªó kh√°c)
        views: vAll,
        // views theo m·ªëc th·ªùi gian
        viewsAll: vAll,
        viewsMonth: vMonth,
        viewsWeek: vWeek,
        viewsDay: vDay,

        hotScore: raw?.hotScore ?? raw?.hot ?? 0,
        desc: raw?.desc || raw?.description || "",
        status: raw?.status || raw?.state || "",
        completed: raw?.completed ?? raw?.isCompleted ?? raw?.finish ?? raw?.full ?? null
      };
    }
function computeCategories(list){
      const set = new Set();
      list.forEach(s => (s.categories||[]).forEach(c => set.add(c)));
      return Array.from(set).sort((a,b)=>a.localeCompare(b,"vi"));
    }

    function fillCategorySelect(sel, items){
      const cur = sel.value || "all";
      sel.innerHTML = '<option value="all">' + (sel.id==="hotCategory" ? "TH·ªÇ LO·∫†I: T·∫§T C·∫¢" : "CH·ªåN TH·ªÇ LO·∫†I") + '</option>';
      items.forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c.toUpperCase();
        sel.appendChild(opt);
      });
      sel.value = items.includes(cur) ? cur : "all";
    }

    function isCompletedStory(s){
      const st = String(s?.status || "").toLowerCase().trim();
      if(st === "completed" || st === "done" || st === "full") return true;
      if(s?.completed === true) return true;
      // n·∫øu completed l√† string "true"/"1"
      if(typeof s?.completed === "string" && ["true","1","yes","y"].includes(s.completed.toLowerCase().trim())) return true;

      const cc = (s?.chapterCount != null) ? Number(s.chapterCount) : null;
      const lc = (s?.latestChapNo != null) ? Number(s.latestChapNo) : null;
      if(cc && lc && !Number.isNaN(cc) && !Number.isNaN(lc) && lc >= cc) return true;

      return false;
    }



    function renderSearch(q){
      const query = toLower((q||"").trim());
      const results = !query ? [] : stories
        .filter(s => toLower(s.title).includes(query) || (s.categories||[]).some(c => toLower(c).includes(query)))
        .slice(0, 30);

      const box = $("searchResults");
      if(!query){
        box.innerHTML = '<div class="searchEmpty">Nh·∫≠p t√™n truy·ªán ho·∫∑c th·ªÉ lo·∫°i ƒë·ªÉ t√¨m‚Ä¶</div>';
        return;
      }
      if(!results.length){
        box.innerHTML = '<div class="searchEmpty">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.</div>';
        return;
      }
      box.innerHTML = results.map(s=>`
        <div class="searchItem" data-story="${esc(s.id)}">
          <div class="miniCover" style="width:34px;height:46px">${s.coverUrl ? `<img src="${esc(s.coverUrl)}" alt="">` : ""}</div>
          <div class="t" title="${esc(s.title)}">${esc(s.title)}</div>
          <div class="c">${(s.latestChapNo!=null) ? ("C. " + s.latestChapNo) : ""}</div>
        </div>
      `).join("");
      box.querySelectorAll("[data-story]").forEach(row=>{
        row.addEventListener("click", ()=>{
          const id = row.getAttribute("data-story");
          const st = stories.find(x=>x.id===id);
          closeSearch();
          openStoryModal(st);
        });
      });
    }


    // ===== Render Hot =====
    function renderHot(){
      const cat = $("hotCategory").value;
      const list = stories
        .filter(s => cat==="all" ? true : (s.categories||[]).includes(cat))
        .slice()
        .sort((a,b)=> (b.hotScore||0) - (a.hotScore||0) || (b.views||0)-(a.views||0) || (b.updatedAt||0)-(a.updatedAt||0))
        .slice(0, 12);

      const grid = $("hotGrid");
      grid.innerHTML = list.map(s => `
        <a class="hotItem" data-story="${esc(s.id)}" href="javascript:void(0)">
          <div class="hotCover">${s.coverUrl ? `<img src="${esc(s.coverUrl)}" alt="">` : ""}</div>
          <div class="hotName">${esc(s.title)}</div>
        </a>
      `).join("");

      $("hotHint").textContent = list.length ? "" : "Ch∆∞a c√≥ truy·ªán HOT ph√π h·ª£p trong d·ªØ li·ªáu Firebase.";
      grid.querySelectorAll("[data-story]").forEach(a=>{
        a.addEventListener("click", ()=>{
          const id = a.getAttribute("data-story");
          const st = stories.find(x=>x.id===id);
          openStoryModal(st);
        });
      });
    }

    // ===== Render Updated =====
    function renderUpdated(){
      const cat = $("updateCategory").value;
      const list = stories
        .filter(s => cat==="all" ? true : (s.categories||[]).includes(cat))
        .slice()
        .sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0) || (b.latestChapNo||0) - (a.latestChapNo||0))
        .slice(0, 20);

      const box = $("updateList");
      box.innerHTML = list.map(s=>`
        <div class="listRow" data-story="${esc(s.id)}">
          <div class="leftLine">
            <div class="storyLine">
              <div class="miniCover">${s.coverUrl ? `<img src="${esc(s.coverUrl)}" alt="">` : ""}</div>
              <div style="min-width:0">
                <div class="lineTitle" title="${esc(s.title)}">${esc(s.title)}</div>
                <div class="lineMeta">
                  ${isCompletedStory(s) ? `<span class="pill">Full</span>` : ``}
                  ${(s.updatedAt!=null) ? `<span>üïí ${new Date(s.updatedAt).toLocaleDateString("vi-VN")}</span>` : ``}
                </div>
              </div>
            </div>
          </div>
          <div class="chapCount">${fmtNum(s.latestChapNo ?? s.chapterCount)}</div>
        </div>
      `).join("");

      $("updateHint").textContent = list.length ? "" : "Ch∆∞a c√≥ truy·ªán trong m·ª•c M·ªõi c·∫≠p nh·∫≠t.";
      box.querySelectorAll("[data-story]").forEach(row=>{
        row.addEventListener("click", ()=>{
          const id = row.getAttribute("data-story");
          const st = stories.find(x=>x.id===id);
          openStoryModal(st);
        });
      });
    }

    

    // ===== Render Completed (Truy·ªán ho√†n th√†nh) =====
    function renderCompleted(){
      const cat = $("completedCategory").value;
      const list = stories
        .filter(s => isCompletedStory(s))
        .filter(s => cat==="all" ? true : (s.categories||[]).includes(cat))
        .slice()
        .sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0) || (b.views||0)-(a.views||0))
        .slice(0, 20);

      const box = $("completedList");
      box.innerHTML = list.map(s=>`
        <div class="listRow" data-story="${esc(s.id)}">
          <div class="leftLine">
            <div class="storyLine">
              <div class="miniCover">${s.coverUrl ? `<img src="${esc(s.coverUrl)}" alt="">` : ""}</div>
              <div style="min-width:0">
                <div class="lineTitle" title="${esc(s.title)}">${esc(s.title)}</div>
                <div class="lineMeta">
                  <span class="pill">Full</span>
                  ${(s.chapterCount!=null) ? `<span>üìö ${Number(s.chapterCount)} ch∆∞∆°ng</span>` : ``}
                  ${(s.updatedAt!=null) ? `<span>üïí ${new Date(s.updatedAt).toLocaleDateString("vi-VN")}</span>` : ``}
                </div>
              </div>
            </div>
          </div>
          <div class="chapCount">${(s.chapterCount!=null) ? ("C. " + s.chapterCount) : (s.latestChapNo!=null ? ("C. " + s.latestChapNo) : "‚Äî")}</div>
        </div>
      `).join("");

      $("completedHint").textContent = list.length ? "" : "Ch∆∞a c√≥ truy·ªán ho√†n th√†nh trong d·ªØ li·ªáu.";
      box.querySelectorAll("[data-story]").forEach(row=>{
        row.addEventListener("click", ()=>{
          const id = row.getAttribute("data-story");
          const st = stories.find(x=>x.id===id);
          openStoryModal(st);
        });
      });
    }

// ===== Render Reading (user) =====
    async function loadReading(){
      if(!currentUser){
        $("readingList").innerHTML = "";
        $("readingEmpty").style.display = "block";
        return;
      }
      const rRef = ref(db, `userData/${currentUser.uid}/reading`);
      const snap = await get(rRef);
      const data = snap.exists() ? snap.val() : {};
      const arr = Object.values(data||{})
        .filter(Boolean)
        .sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0))
        .slice(0, 8);

      if(!arr.length){
        $("readingList").innerHTML = "";
        $("readingEmpty").style.display = "block";
        return;
      }
      $("readingEmpty").style.display = "none";

      $("readingList").innerHTML = arr.map(it=>{
        const st = stories.find(s=>s.id===it.storyId) || { title: it.title||"Truy·ªán", coverUrl:"" };
        const chapNo = it.chapNo ?? it.latestChapNo ?? null;
        return `
          <div class="listRow" data-story="${esc(it.storyId)}">
            <div class="leftLine">
              <div class="storyLine">
                <div class="miniCover">${st.coverUrl ? `<img src="${esc(st.coverUrl)}" alt="">` : ""}</div>
                <div style="min-width:0">
                  <div class="lineTitle" title="${esc(st.title)}">${esc(st.title)}</div>
                  <div class="lineMeta">
                    <span>Ti·∫øp t·ª•c: ${chapNo!=null ? ("Ch∆∞∆°ng " + chapNo) : "‚Äî"}</span>
                    ${it.updatedAt ? `<span>üïí ${new Date(it.updatedAt).toLocaleString("vi-VN")}</span>` : ``}
                  </div>
                </div>
              </div>
            </div>
            <div class="chapCount">‚ñ∂</div>
          </div>
        `;
      }).join("");

      $("readingList").querySelectorAll("[data-story]").forEach(row=>{
        row.addEventListener("click", ()=>{
          const id = row.getAttribute("data-story");
          const st = stories.find(x=>x.id===id);
          openStoryModal(st, { continue: true });
        });
      });
    }

    // ===== Story Modal + "ƒë√°nh d·∫•u ƒëang ƒë·ªçc" =====
    async function markReading(storyId, chapNo=1){
      if(!currentUser) return;
      const st = stories.find(x=>x.id===storyId);
      const payload = {
        storyId,
        chapNo,
        updatedAt: Date.now(),
        title: st?.title || ""
      };
      await set(ref(db, `userData/${currentUser.uid}/reading/${storyId}`), payload);
    }


    // ===== Reader (ƒë·ªçc truy·ªán theo ch∆∞∆°ng t·ª´ RTDB) =====
    // Data:
    // chapters/{storyId}/{chapNo}: { no: number, title: string, content: string, createdAt }
    function stripScripts(htmlText){
      // lo·∫°i b·ªè script ƒë∆°n gi·∫£n (admin l√† ng∆∞·ªùi ƒëƒÉng n·ªôi dung n√™n ƒë√¢y l√† l·ªõp b·∫£o v·ªá nh·∫π)
      return String(htmlText||"").replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, "");
    }

    function safeRenderChapter(htmlText){
      // B·∫£o v·ªá nh·∫π: b·ªè <script> + b·ªè on* handlers
      let t = stripScripts(htmlText);
      t = t.replace(/\son\w+="[^"]*"/gi, "");
      t = t.replace(/\son\w+='[^']*'/gi, "");
      return t;
    }

    async function fetchChapter(storyId, chapNo){
      const sn = await get(ref(db, `chapters/${storyId}/${chapNo}`));
      return sn.exists() ? sn.val() : null;
    }

    async function fetchLastChaptersMeta(storyId, limit=200){
      // d√πng orderByChild('no') ƒë·ªÉ l·∫•y ch∆∞∆°ng m·ªõi nh·∫•t (c·∫ßn c√≥ field no)
      const q = query(ref(db, `chapters/${storyId}`), orderByChild("no"), limitToLast(limit));
      const sn = await get(q);
      if(!sn.exists()) return [];
      const raw = sn.val();
      const arr = Object.entries(raw).map(([k,v])=>({
        key: k,
        no: Number(v?.no ?? k),
        title: v?.title || ""
      })).filter(x=>Number.isFinite(x.no));
      arr.sort((a,b)=>a.no-b.no);
      return arr;
    }

    async function openReader(st){
      if(!st) return;

      const storyId = st.id;
      // ∆∞u ti√™n: ƒëang ƒë·ªçc -> latest -> 1
      let startNo = 1;
      try{
        if(currentUser){
          const rs = await get(ref(db, `userData/${currentUser.uid}/reading/${storyId}`));
          if(rs.exists()){
            startNo = Number(rs.val()?.chapNo || 1) || 1;
          }else if(st.latestChapNo!=null){
            startNo = Number(st.latestChapNo)||1;
          }else if(st.chapterCount!=null){
            startNo = Number(st.chapterCount)||1;
          }
        }else{
          startNo = Number(st.latestChapNo || st.chapterCount || 1) || 1;
        }
      }catch(e){
        startNo = Number(st.latestChapNo || st.chapterCount || 1) || 1;
      }

      // UI
      openModal(st.title, `
        <div class="mutedBox" style="margin-bottom:10px">
          <b>${esc(st.title)}</b><br/>
          Ch·∫ø ƒë·ªô ƒë·ªçc ch∆∞∆°ng (l·∫•y t·ª´ Firebase RTDB). 
          ${currentUser ? "" : "<br/><span class='adminSmall'>* ƒêƒÉng nh·∫≠p ƒë·ªÉ t·ª± l∆∞u v·ªã tr√≠ ƒëang ƒë·ªçc.</span>"}
        </div>

        <div class="adminRow" style="justify-content:space-between">
          <div class="adminRow" style="gap:8px">
            <button class="btn" id="rPrev">‚óÄ</button>
            <button class="btn" id="rNext">‚ñ∂</button>
          </div>

          <div class="adminRow" style="gap:8px;flex:1;justify-content:flex-end">
            <input class="input" id="rGoNo" type="number" min="1" step="1" style="max-width:120px" placeholder="Ch∆∞∆°ng..." />
            <button class="btn" id="rGoBtn">ƒêi</button>
          </div>
        </div>

        <div class="adminRow" style="margin-top:10px">
          <select class="select" id="rChapSelect" style="flex:1;min-width:0">
            <option value="">ƒêang t·∫£i danh s√°ch ch∆∞∆°ng...</option>
          </select>
          <button class="btn primary" id="rClose">ƒê√≥ng</button>
        </div>

        <div class="hint" id="rHint" style="margin-top:8px"></div>

        <div class="mutedBox" style="margin-top:10px">
          <div id="rTitle" style="font-weight:950;margin-bottom:6px">‚Äî</div>
          <div id="rContent" style="font-size:14px;line-height:1.75"></div>
        </div>
      `);

      const sel = $("rChapSelect");
      const hint = $("rHint");
      const titleEl = $("rTitle");
      const contentEl = $("rContent");
      const goNo = $("rGoNo");

      let chapterList = [];
      let currentNo = startNo;

      async function loadList(){
        try{
          chapterList = await fetchLastChaptersMeta(storyId, 200);
          if(!chapterList.length){
            sel.innerHTML = `<option value="">Ch∆∞a c√≥ ch∆∞∆°ng n√†o</option>`;
            hint.textContent = "Ch∆∞a c√≥ ch∆∞∆°ng trong /chapters/" + storyId + ".";
            return;
          }
          sel.innerHTML = chapterList.map(c=>{
            const label = `Ch∆∞∆°ng ${c.no}` + (c.title ? `: ${esc(c.title)}` : "");
            return `<option value="${c.no}">${label}</option>`;
          }).join("");
          // n·∫øu startNo kh√¥ng n·∫±m trong list cu·ªëi, v·∫´n set value (s·∫Ω kh√¥ng c√≥ option) -> d√πng go input
          if(chapterList.some(c=>c.no===currentNo)) sel.value = String(currentNo);
          hint.textContent = "ƒêang hi·ªÉn th·ªã danh s√°ch 200 ch∆∞∆°ng m·ªõi nh·∫•t. (B·∫°n c√≥ th·ªÉ nh·∫≠p s·ªë ch∆∞∆°ng ƒë·ªÉ ƒëi th·∫≥ng.)";
        }catch(err){
          console.warn(err);
          sel.innerHTML = `<option value="">Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch ch∆∞∆°ng</option>`;
          hint.textContent = "Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch ch∆∞∆°ng. Ki·ªÉm tra Rules cho /chapters.";
        }
      }

      async function loadChap(no){
        no = Number(no||1)||1;
        currentNo = no;
        titleEl.textContent = `Ch∆∞∆°ng ${no}` + (st.title ? ` ‚Äî ${st.title}` : "");
        contentEl.innerHTML = "<i>ƒêang t·∫£i...</i>";
        hint.textContent = "";

        try{
          const ch = await fetchChapter(storyId, String(no));
          if(!ch){
            contentEl.innerHTML = "<div class='searchEmpty'>Kh√¥ng t√¨m th·∫•y ch∆∞∆°ng n√†y. (Ki·ªÉm tra /chapters/" + esc(storyId) + "/" + no + ")</div>";
            return;
          }
          const cTitle = ch?.title ? String(ch.title) : "";
          titleEl.textContent = `Ch∆∞∆°ng ${no}` + (cTitle ? `: ${cTitle}` : "");
          const raw = ch?.content ?? ch?.text ?? "";
          const rendered = safeRenderChapter(raw);
          // n·∫øu l√† text thu·∫ßn, t·ª± xu·ªëng d√≤ng
          const looksLikeHtml = /<\w+[^>]*>/.test(rendered);
          contentEl.innerHTML = looksLikeHtml ? rendered : esc(rendered).replace(/\n/g,"<br/>");

          // l∆∞u v·ªã tr√≠ ƒëang ƒë·ªçc
          if(currentUser){
            await markReading(storyId, no);
            await loadReading();
          }
          // sync select / input
          if(sel && chapterList.some(c=>c.no===no)) sel.value = String(no);
          if(goNo) goNo.value = String(no);
        }catch(err){
          console.warn(err);
          contentEl.innerHTML = "<div class='searchEmpty'>Kh√¥ng t·∫£i ƒë∆∞·ª£c ch∆∞∆°ng. Ki·ªÉm tra Realtime Database Rules cho /chapters.</div>";
        }
      }

      $("rClose")?.addEventListener("click", closeModal);
      $("rPrev")?.addEventListener("click", ()=> loadChap(Math.max(1, currentNo-1)));
      $("rNext")?.addEventListener("click", ()=> loadChap(currentNo+1));
      $("rGoBtn")?.addEventListener("click", ()=> loadChap(goNo.value));
      goNo?.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); loadChap(goNo.value);} });
      sel?.addEventListener("change", ()=>{ if(sel.value) loadChap(sel.value); });

      await loadList();
      await loadChap(currentNo);
    }

    // ===== Admin UI (th√™m truy·ªán / ch∆∞∆°ng v√†o RTDB) =====
    const ADMIN_EMAILS = ["sumi22122005@gmail.com"].map(s=>s.toLowerCase());
    let _adminBound = false;

    function isAdmin(u){
      const em = (u?.email||"").toLowerCase();
      return !!em && ADMIN_EMAILS.includes(em);
    }

    function toggleAdminUI(u){
      const ok = isAdmin(u);
      const sec = $("secAdmin");
      const nav = $("navAdmin");
      if(sec) sec.style.display = ok ? "block" : "none";
      if(nav) nav.style.display = ok ? "block" : "none";
      if($("adminState")) $("adminState").textContent = ok ? "‚úì Admin" : "";
      return ok;
    }

    function bindAdminUIOnce(){
      if(_adminBound) return;
      _adminBound = true;

      const msgStory = $("aStoryMsg");
      const msgChap = $("aChapMsg");

      function resetStoryForm(){
        $("aStoryTitle").value = "";
        $("aStoryAuthor").value = "";
        $("aStoryCats").value = "";
        $("aStoryCover").value = "";
        $("aStoryDesc").value = "";
        $("aStoryCompleted").checked = false;
        msgStory.textContent = "";
      }

      function resetChapForm(){
        $("aChapNo").value = "";
        $("aChapTitle").value = "";
        $("aChapContent").value = "";
        msgChap.textContent = "";
      }

      $("aStoryReset")?.addEventListener("click", resetStoryForm);
      $("aChapReset")?.addEventListener("click", resetChapForm);

      $("aStorySave")?.addEventListener("click", async ()=>{
        msgStory.textContent = "";
        if(!currentUser || !isAdmin(currentUser)){
          alert("B·∫°n kh√¥ng c√≥ quy·ªÅn admin.");
          return;
        }
        const title = $("aStoryTitle").value.trim();
        if(!title){ msgStory.textContent = "Nh·∫≠p ti√™u ƒë·ªÅ truy·ªán."; return; }

        const now = Date.now();
        const author = $("aStoryAuthor").value.trim();
        const cats = $("aStoryCats").value.split(",").map(s=>s.trim()).filter(Boolean);
        const coverUrl = $("aStoryCover").value.trim();
        const desc = $("aStoryDesc").value.trim();
        const completed = $("aStoryCompleted").checked;

        try{
          const newRef = push(ref(db, "stories"));
          const storyId = newRef.key;
          const payload = {
            title,
            author,
            categories: cats,
            coverUrl,
            desc,
            completed,
            status: completed ? "completed" : "ongoing",
            createdAt: now,
            updatedAt: now,
            latestChapNo: 0,
            chapterCount: 0,
            views: 0,
            hotScore: 0
          };
          await set(newRef, payload);

          msgStory.textContent = "‚úì ƒê√£ l∆∞u truy·ªán. ID: " + storyId;
          resetStoryForm();

          // reload lists + refresh select
          await loadStories();
          await refreshAdminStorySelect();
          window.scrollTo({top:0,behavior:"smooth"});
        }catch(err){
          console.warn(err);
          msgStory.textContent = "Kh√¥ng l∆∞u ƒë∆∞·ª£c. Ki·ªÉm tra Rules cho /stories.";
          alert("Kh√¥ng l∆∞u ƒë∆∞·ª£c truy·ªán. Ki·ªÉm tra Realtime Database Rules cho /stories.");
        }
      });

      $("aChapSave")?.addEventListener("click", async ()=>{
        msgChap.textContent = "";
        if(!currentUser || !isAdmin(currentUser)){
          alert("B·∫°n kh√¥ng c√≥ quy·ªÅn admin.");
          return;
        }
        const storyId = $("aChapStory").value;
        if(!storyId){ msgChap.textContent = "Ch·ªçn truy·ªán."; return; }

        const no = Number($("aChapNo").value || 0);
        if(!Number.isFinite(no) || no < 1){ msgChap.textContent = "Nh·∫≠p s·ªë ch∆∞∆°ng h·ª£p l·ªá (>=1)."; return; }

        const title = $("aChapTitle").value.trim();
        let content = $("aChapContent").value || "";
        content = stripScripts(content);

        if(!content.trim()){
          msgChap.textContent = "N·ªôi dung ch∆∞∆°ng ƒëang tr·ªëng.";
          return;
        }

        const now = Date.now();

        try{
          // l∆∞u theo key l√† s·ªë ch∆∞∆°ng ƒë·ªÉ d·ªÖ truy v·∫•n tr·ª±c ti·∫øp
          await set(ref(db, `chapters/${storyId}/${no}`), {
            no,
            title,
            content,
            createdAt: now
          });

          // c·∫≠p nh·∫≠t story meta
          const sSnap = await get(ref(db, `stories/${storyId}`));
          const sVal = sSnap.exists() ? sSnap.val() : {};
          const prevLatest = Number(sVal?.latestChapNo || 0) || 0;
          const prevCount  = Number(sVal?.chapterCount || 0) || 0;

          const nextLatest = Math.max(prevLatest, no);
          const nextCount  = Math.max(prevCount, no);

          await update(ref(db, `stories/${storyId}`), {
            latestChapNo: nextLatest,
            chapterCount: nextCount,
            updatedAt: now
          });

          msgChap.textContent = `‚úì ƒê√£ ƒëƒÉng Ch∆∞∆°ng ${no}.`;
          $("aChapNo").value = String(no+1);
          $("aChapTitle").value = "";
          $("aChapContent").value = "";

          await loadStories();
        }catch(err){
          console.warn(err);
          msgChap.textContent = "Kh√¥ng ƒëƒÉng ƒë∆∞·ª£c ch∆∞∆°ng. Ki·ªÉm tra Rules cho /chapters v√† /stories.";
          alert("Kh√¥ng ƒëƒÉng ƒë∆∞·ª£c ch∆∞∆°ng. Ki·ªÉm tra Realtime Database Rules.");
        }
      });
    }

    async function refreshAdminStorySelect(){
      const sel = $("aChapStory");
      if(!sel) return;
      const cur = sel.value;

      // n·∫øu ƒëang l√† demo th√¨ v·∫´n show, nh∆∞ng admin n√™n c√≥ stories th·∫≠t
      const list = (stories||[]).slice().sort((a,b)=>String(a.title||"").localeCompare(String(b.title||""), "vi"));
      sel.innerHTML = `<option value="">‚Äî Ch·ªçn truy·ªán ‚Äî</option>` + list.map(s=>`<option value="${esc(s.id)}">${esc(s.title)}</option>`).join("");
      if(cur && list.some(s=>s.id===cur)) sel.value = cur;
    }


    function openStoryModal(st, opts={}){
      if(!st) return;
      const cats = (st.categories||[]).slice(0,4).map(c=>`<span class="pill">${esc(c)}</span>`).join(" ");
      openModal(st.title, `
        <div class="modalGrid">
          <div class="modalCover">${st.coverUrl ? `<img src="${esc(st.coverUrl)}" alt="">` : ""}</div>
          <div>
            <div class="lineMeta" style="margin:0 0 6px 0">
              ${cats || `<span class="pill">Ch∆∞a c√≥ th·ªÉ lo·∫°i</span>`}
              ${isCompletedStory(st) ? `<span class="pill">Full</span>` : ``}
              ${(st.latestChapNo!=null) ? `<span class="pill">C. ${st.latestChapNo}</span>` : ``}
              ${(st.views!=null) ? `<span class="pill">üëÅ ${st.views}</span>` : ``}
            </div>
            <div class="modalDesc">
              ${st.desc ? esc(st.desc) : "Ch∆∞a c√≥ m√¥ t·∫£. (B∆∞·ªõc sau m√¨nh s·∫Ω l√†m trang chi ti·∫øt truy·ªán + ch∆∞∆°ng gi·ªëng web m·∫´u.)"}
            </div>

            <div class="btnRow">
              <button class="btn primary" id="btnReadNow">ƒê·ªçc ngay</button>
              <button class="btn" id="btnMarkReading">${opts.continue ? "Ti·∫øp t·ª•c ƒë·ªçc" : "ƒê√°nh d·∫•u ƒëang ƒë·ªçc"}</button>
              <button class="btn" id="btnCloseModal">ƒê√≥ng</button>
            </div>

            <div class="mutedBox">
              ‚Ä¢ Hi·ªán t·∫°i l√† b·∫£n <b>trang ch·ªß gi·ªëng ·∫£nh</b> + l·∫•y d·ªØ li·ªáu t·ª´ Firebase.<br/>
              ‚Ä¢ Khi b·∫•m <b>ƒê·ªçc ngay</b>, web s·∫Ω t·∫£i ch∆∞∆°ng t·ª´ <b>Realtime Database</b> (node <code>/chapters/{storyId}/{chapNo}</code>).
            </div>
          </div>
        </div>
      `);

      $("btnCloseModal").addEventListener("click", closeModal);
      $("btnMarkReading").addEventListener("click", async ()=>{
        if(!currentUser){
          alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u 'ƒëang ƒë·ªçc' l√™n Firebase.");
          return;
        }
        await markReading(st.id, 1);
        closeModal();
        await loadReading();
      });
      $("btnReadNow").addEventListener("click", async ()=>{
        // M·ªü trang ƒë·ªçc ch∆∞∆°ng (l·∫•y t·ª´ RTDB /chapters/{storyId}/{chapNo})
        closeModal();
        await openReader(st);
      });
    }

    // ===== Load stories from Firebase =====
    async function loadStories(){
      // ∆∞u ti√™n /stories; n·∫øu b·∫°n ƒëang d√πng node kh√°c, ƒë·ªïi ·ªü ƒë√¢y.
      const sRef = ref(db, "stories");
      const snap = await get(sRef);
      const raw = snap.exists() ? snap.val() : null;

      if(!raw){
        // t·∫°o d·ªØ li·ªáu demo MIN ƒë·ªÉ b·∫°n th·∫•y UI (b·∫°n c√≥ th·ªÉ x√≥a sau)
        stories = [
          { id:"demo1", title:"Kinh Thi√™n Ki·∫øm ƒê·∫ø", coverUrl:"", categories:["Ti√™n hi·ªáp"], latestChapNo:250, chapterCount:250, updatedAt:Date.now()-86400000*2, views:1200, hotScore:50, desc:"Demo (kh√¥ng c√≥ d·ªØ li·ªáu stories tr√™n Firebase)." },
          { id:"demo2", title:"Th√¥n Ph·ªá C·ªï ƒê·∫ø", coverUrl:"", categories:["Huy·ªÅn huy·ªÖn"], latestChapNo:3740, chapterCount:3740, updatedAt:Date.now()-86400000*1, views:900, hotScore:45, desc:"Demo (h√£y th√™m node /stories trong RTDB)." },
          { id:"demo3", title:"Th√°i Hoang Th√¥n Thi√™n Quy·∫øt", coverUrl:"", categories:["Ti√™n hi·ªáp"], latestChapNo:255, updatedAt:Date.now()-86400000*3, views:800, hotScore:40, desc:"Demo" },
          { id:"demo4", title:"Nh·∫•t Ki·∫øm ƒê·ªôc T√¥n", coverUrl:"", categories:["Ki·∫øm hi·ªáp"], latestChapNo:120, updatedAt:Date.now()-86400000*4, views:700, hotScore:35, desc:"Demo" },
          { id:"demo5", title:"Ngh·ªãch Thi√™n Ch√≠ T√¥n", coverUrl:"", categories:["Huy·ªÅn huy·ªÖn"], latestChapNo:22, updatedAt:Date.now()-86400000*5, views:500, hotScore:25, desc:"Demo" },
          { id:"demo6", title:"V√¥ ƒê·ªãch Thi√™n H·∫°", coverUrl:"", categories:["Huy·ªÅn huy·ªÖn"], latestChapNo:95, updatedAt:Date.now()-86400000*6, views:400, hotScore:20, desc:"Demo" },
        ];
      }else{
        stories = Object.entries(raw).map(([id,val])=>normalizeStory(id,val));
      }

      categories = computeCategories(stories);
      fillCategorySelect($("hotCategory"), categories);
      fillCategorySelect($("updateCategory"), categories);
      fillCategorySelect($("completedCategory"), categories);

      renderHot();
      renderUpdated();
      renderCompleted();
      await loadReading();
    }

    $("hotCategory").addEventListener("change", renderHot);
    $("updateCategory").addEventListener("change", renderUpdated);
    $("completedCategory").addEventListener("change", renderCompleted);

    // Start
    loadStories().then(()=>applyRoute()).catch(()=>applyRoute());

    // ===== Tip: sample admin push (kh√¥ng ch·∫°y t·ª± ƒë·ªông) =====
    // B·∫°n c√≥ th·ªÉ m·ªü DevTools v√† g·ªçi window.__seedStories() ƒë·ªÉ t·∫°o 1 truy·ªán m·∫´u l√™n RTDB.
    window.__seedStories = async ()=>{
      const id = push(ref(db, "stories")).key;
      await set(ref(db, "stories/" + id), {
        title: "Truy·ªán m·∫´u seed",
        coverUrl: "",
        categories: "Ti√™n hi·ªáp, Huy·ªÅn huy·ªÖn",
        latestChapNo: 1,
        chapterCount: 1,
        updatedAt: Date.now(),
        views: 0,
        hotScore: 10,
        desc: "Truy·ªán m·∫´u ƒë·ªÉ test giao di·ªán trang ch·ªß."
      });
      alert("ƒê√£ seed 1 truy·ªán m·∫´u v√†o /stories");
      loadStories();
    };
  </script>

</body>
</html>

