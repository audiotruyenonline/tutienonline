<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cá»­u ThiÃªn â€¢ Äá»c Truyá»‡n Tu Luyá»‡n</title>
  <meta name="theme-color" content="#0b0d12" />
  <style>
    :root{
      --bg0:#07080c;
      --bg1:#0b0d12;
      --card:#0f121a;
      --card2:#0c0f16;
      --muted:#8c93a8;
      --text:#e9ecf5;
      --gold:#d7b86b;
      --gold2:#f6d98b;
      --line:rgba(255,255,255,.08);
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:14px;
      --blur: blur(10px);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(215,184,107,.16), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(126,87,255,.12), transparent 60%),
        radial-gradient(700px 600px at 50% 110%, rgba(0,204,255,.08), transparent 55%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
      color:var(--text);
      overflow-x:hidden;
    }
    a{ color:inherit; text-decoration:none; }
    button, input, textarea, select{ font-family:inherit; }
    .hidden{ display:none !important; }

    /* Header */
    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      padding: calc(10px + var(--safe-top)) 12px 10px;
      backdrop-filter: var(--blur);
      background: linear-gradient(180deg, rgba(7,8,12,.92), rgba(7,8,12,.70));
      border-bottom:1px solid var(--line);
    }
    .topbarRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
      flex: 1;
    }
    .logoBox{
      width:34px;height:34px;border-radius:10px;
      background: linear-gradient(135deg, rgba(215,184,107,.25), rgba(215,184,107,.05));
      border:1px solid rgba(215,184,107,.25);
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      overflow:hidden;
      flex: 0 0 auto;
    }
    .logoBox img{ width:100%;height:100%;object-fit:cover; }
    .brandText{
      display:flex;
      flex-direction:column;
      line-height:1.05;
      min-width:0;
    }
    .brandText .name{
      font-weight:900;
      letter-spacing:.2px;
      font-size:16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText .sub{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-size:12px;
      white-space:nowrap;
    }
    .pill b{ color:var(--gold2); font-weight:800; }
    .actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .iconBtn{
      width:38px;height:38px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      transition:.15s transform ease, .15s background ease;
    }
    .iconBtn:active{ transform: scale(.97); }
    .cta{
      height:38px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid rgba(215,184,107,.25);
      background: linear-gradient(180deg, rgba(215,184,107,.20), rgba(215,184,107,.08));
      color: var(--gold2);
      font-weight:900;
      cursor:pointer;
      display:flex;align-items:center;gap:8px;
      box-shadow: 0 12px 30px rgba(215,184,107,.10);
    }
    .avatarBtn{
      width:38px;height:38px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      cursor:pointer;
      position:relative;
      flex: 0 0 auto;
    }
    .avatarBtn img{ width:100%;height:100%;object-fit:cover; display:block; }
    .badgeDot{
      position:absolute;
      right:-1px; top:-1px;
      width:16px;height:16px;border-radius:999px;
      background:#ff4d4d;
      border:2px solid rgba(7,8,12,.95);
      display:flex;align-items:center;justify-content:center;
      font-size:10px;font-weight:900;
      color:#fff;
    }

    /* Layout */
    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 12px calc(92px + var(--safe-bottom));
    }

    /* Sections */
    .section{
      margin-top: 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-bottom: 1px solid var(--line);
    }
    .sectionTitle{
      display:flex;align-items:center;gap:10px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .muted{ color:var(--muted); font-size:13px; }

    .hScroll{
      display:flex;
      gap:12px;
      overflow:auto hidden;
      padding: 12px 12px 14px;
      scroll-snap-type:x mandatory;
    }
    .hScroll::-webkit-scrollbar{ height: 8px; }
    .hScroll::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.12); border-radius: 999px; }
    .storyCard{
      width: 140px;
      flex: 0 0 auto;
      scroll-snap-align: start;
      border-radius: 16px;
      overflow:hidden;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: 0 14px 28px rgba(0,0,0,.35);
      cursor:pointer;
      position:relative;
      transition:.15s transform ease;
    }
    .storyCard:active{ transform: scale(.98); }
    .cover{
      width:100%;
      aspect-ratio: 3/4;
      background: rgba(255,255,255,.06);
      position:relative;
    }
    .cover img{ width:100%;height:100%;object-fit:cover; display:block; }
    .cover::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, transparent 55%, rgba(0,0,0,.75));
    }
    .cardMeta{
      position:absolute;
      left:10px; top:10px;
      display:flex;
      gap:6px;
    }
    .miniTag{
      font-size:11px;
      font-weight:900;
      padding: 3px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.30);
      backdrop-filter: var(--blur);
      color: var(--text);
    }
    .miniTag.gold{
      border-color: rgba(215,184,107,.30);
      color: var(--gold2);
    }
    .cardBody{
      padding: 10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .cardTitle{
      font-weight:900;
      font-size:13px;
      line-height:1.2;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
      min-height: 32px;
    }
    .cardStats{
      display:flex;
      gap:10px;
      color: var(--muted);
      font-size:11.5px;
      align-items:center;
      flex-wrap:wrap;
    }
    .stat{ display:inline-flex; align-items:center; gap:6px; }

    /* Vertical list */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 12px;
    }
    .rowCard{
      display:flex;
      gap:12px;
      padding: 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      cursor:pointer;
      transition:.15s transform ease;
      position:relative;
    }
    .rowCard:active{ transform: scale(.99); }
    .rowCover{
      width: 64px;
      height: 84px;
      border-radius: 14px;
      overflow:hidden;
      background: rgba(255,255,255,.06);
      flex: 0 0 auto;
    }
    .rowCover img{ width:100%;height:100%;object-fit:cover; display:block; }
    .rowMain{ min-width:0; flex:1; }
    .rowTitle{ font-weight:900; font-size:14px; line-height:1.25; }
    .rowDesc{
      color: var(--muted);
      font-size: 12.5px;
      margin-top: 4px;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .rowLine{
      margin-top: 8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 12px;
      flex-wrap:wrap;
    }

    /* Bottom nav */
    .bottomNav{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:60;
      padding: 10px 12px calc(10px + var(--safe-bottom));
      background: linear-gradient(180deg, rgba(7,8,12,.05), rgba(7,8,12,.92));
      backdrop-filter: var(--blur);
      border-top: 1px solid var(--line);
    }
    .navBar{
      max-width: 1180px;
      margin: 0 auto;
      display:flex;
      gap:10px;
      justify-content:space-between;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 6px;
      box-shadow: var(--shadow);
    }
    .navItem{
      flex:1;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      gap:4px;
      padding: 8px 6px;
      border-radius: 14px;
      color: var(--muted);
      font-size: 11.5px;
      cursor:pointer;
      user-select:none;
      transition:.15s background ease, .15s color ease;
    }
    .navItem.active{
      background: rgba(215,184,107,.12);
      border: 1px solid rgba(215,184,107,.25);
      color: var(--gold2);
    }

    /* Drawer */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      z-index:80;
      display:none;
    }
    .drawer{
      position:fixed;
      top:0; right:0;
      height:100%;
      width:min(380px, 90vw);
      background: linear-gradient(180deg, rgba(15,18,26,.98), rgba(10,12,18,.98));
      border-left:1px solid var(--line);
      z-index:90;
      transform: translateX(110%);
      transition: .22s transform ease;
      box-shadow: -18px 0 50px rgba(0,0,0,.55);
      display:flex;
      flex-direction:column;
    }
    .drawer.open{ transform: translateX(0); }
    .overlay.show{ display:block; }
    .drawerHead{
      padding: calc(14px + var(--safe-top)) 14px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .drawerBody{ padding: 12px 14px; overflow:auto; }
    .btn{
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 900;
      background: rgba(255,255,255,.05);
      color: var(--text);
      border:1px solid var(--line);
      transition:.15s transform ease;
    }
    .btn:active{ transform: scale(.98); }
    .btn.gold{
      border-color: rgba(215,184,107,.25);
      background: linear-gradient(180deg, rgba(215,184,107,.20), rgba(215,184,107,.06));
      color: var(--gold2);
    }
    .btn.danger{
      border-color: rgba(255,77,77,.35);
      background: rgba(255,77,77,.12);
      color: #ffd1d1;
    }
    .field{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
    }
    .field::placeholder{ color: rgba(233,236,245,.45); }
    textarea.field{ min-height: 120px; resize: vertical; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .sep{ height:1px; background: var(--line); margin: 14px 0; }

    /* Modal / Reader */
    .modal{
      position:fixed; inset:0;
      z-index:100;
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 10px 10px calc(10px + var(--safe-bottom));
    }
    .modal.show{ display:flex; }
    .sheet{
      width: min(900px, 100%);
      max-height: 92vh;
      background: linear-gradient(180deg, rgba(15,18,26,.98), rgba(10,12,18,.98));
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .sheetHead{
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sheetTitle{
      font-weight: 1000;
      font-size: 14px;
      line-height:1.2;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .sheetBody{
      overflow:auto;
      padding: 14px;
    }

    .chipRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 6px;}
    .chip{
      font-size:12px;
      padding: 4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }

    .chapterList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 12px;
    }
    .chapterItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
    }
    .chapterItem:active{ transform: scale(.995); }
    .chapterItem .left{
      display:flex; flex-direction:column; gap:3px;
      min-width:0;
    }
    .chapterItem .t{
      font-weight: 900;
      font-size: 13.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 62vw;
    }
    .chapterItem .s{
      font-size: 12px;
      color: var(--muted);
    }

    .reader{
      padding: 10px 14px 16px;
    }
    .readerTitle{
      font-size: 17px;
      font-weight: 1000;
      line-height:1.2;
      margin: 6px 0 10px;
    }
    .readerControls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin: 10px 0 12px;
    }
    .readerText{
      font-size: var(--reader-size, 16px);
      line-height: 1.8;
      color: rgba(233,236,245,.92);
      white-space: pre-wrap;
    }
    .progress{
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    .progress > i{
      display:block;
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(215,184,107,.25), rgba(246,217,139,.55));
      border-right: 1px solid rgba(255,255,255,.12);
    }
    .small{ font-size:12px; color: var(--muted); }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      top: calc(10px + var(--safe-top));
      z-index:200;
      min-width: min(92vw, 380px);
      background: rgba(15,18,26,.95);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px 12px;
      display:none;
      box-shadow: var(--shadow);
      color: var(--text);
      backdrop-filter: var(--blur);
    }
    .toast.show{ display:block; animation: toastIn .18s ease; }
    @keyframes toastIn{ from{ transform: translateX(-50%) translateY(-8px); opacity:0;} to{ transform: translateX(-50%) translateY(0); opacity:1;} }

    /* Light mode */
    body.light{
      --bg0:#f7f5ef;
      --bg1:#fbfbfd;
      --card:#ffffff;
      --card2:#ffffff;
      --muted:#6c7284;
      --text:#14161c;
      --line: rgba(20,22,28,.10);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(215,184,107,.22), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(126,87,255,.10), transparent 60%),
        radial-gradient(700px 600px at 50% 110%, rgba(0,204,255,.08), transparent 55%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
    }
    body.light .topbar{ background: linear-gradient(180deg, rgba(251,251,253,.92), rgba(251,251,253,.72)); }
    body.light .miniTag{ background: rgba(255,255,255,.55); }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <header class="topbar">
    <div class="topbarRow">
      <div class="brand" role="button" tabindex="0" onclick="App.openDrawer()">
        <div class="logoBox" title="Logo (báº¡n thay áº£nh tÃ¹y Ã½)">
          <!-- Báº¡n cÃ³ thá»ƒ thay src báº±ng logo cá»§a báº¡n -->
          <img id="logoImg" alt="logo" src="https://i.imgur.com/4M7IWwP.png" onerror="this.style.display='none'; this.parentElement.textContent='ğŸ€„';" />
        </div>
        <div class="brandText">
          <div class="name">Cá»­u ThiÃªn</div>
          <div class="sub">
            <span class="pill" title="Sá»‘ online sáº½ Ä‘á»“ng bá»™ sau"><span>ğŸ‘</span> <b id="onlineCount">â€”</b> online</span>
            <span class="pill" title="Tu vi hiá»‡n táº¡i"><span>âš¡</span> <b id="cultivationLabel">PhÃ m NhÃ¢n</b></span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="iconBtn" title="TÃ¬m truyá»‡n" onclick="App.openSearch()">
          ğŸ”
        </button>
        <button class="cta" title="Náº¡p VIP (má»Ÿ drawer Ä‘á»ƒ xem QR)" onclick="App.openPay()">
          ğŸª™ Náº¡p
        </button>
        <button class="iconBtn" id="themeBtn" title="SÃ¡ng/Tá»‘i" onclick="App.toggleTheme()">ğŸŒ™</button>
        <button class="iconBtn" title="ThÃ´ng bÃ¡o" onclick="App.toast('ChÆ°a cÃ³ thÃ´ng bÃ¡o má»›i')">
          ğŸ””
        </button>
        <button class="avatarBtn" id="avatarBtn" title="TÃ i khoáº£n" onclick="App.openDrawer()">
          <img id="avatarImg" alt="avatar" src="https://i.imgur.com/F32pUuu.jpeg" />
          <div class="badgeDot" id="notifDot" style="display:none;">!</div>
        </button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- HOME -->
    <section class="section" id="homeSection">
      <div class="sectionHead">
        <div>
          <div class="sectionTitle">ğŸ•’ Äang Ä‘á»c</div>
          <div class="muted">Tiáº¿p tá»¥c chÆ°Æ¡ng báº¡n Ä‘ang Ä‘á»c.</div>
        </div>
        <button class="btn" onclick="App.openLibrary()">Xem táº¥t cáº£ â†’</button>
      </div>
      <div class="hScroll" id="continueRow">
        <!-- cards -->
      </div>
    </section>

    <section class="section">
      <div class="sectionHead">
        <div>
          <div class="sectionTitle">ğŸ² KhÃ¡m phÃ¡ ngáº«u nhiÃªn</div>
          <div class="muted">KÃ©o ngang Ä‘á»ƒ xem thÃªm.</div>
        </div>
        <button class="btn" onclick="App.shuffleRandom()">Thá»­ váº­n may</button>
      </div>
      <div class="hScroll" id="randomRow"></div>
    </section>

    <section class="section">
      <div class="sectionHead">
        <div>
          <div class="sectionTitle">âœ¨ Má»›i cáº­p nháº­t <span class="pill" title="Live cáº­p nháº­t theo Firestore">LIVE</span></div>
          <div class="muted">Danh sÃ¡ch truyá»‡n má»›i cáº­p nháº­t gáº§n Ä‘Ã¢y.</div>
        </div>
        <button class="btn" onclick="App.openSearch()">Xem táº¥t cáº£ â†’</button>
      </div>
      <div class="list" id="latestList"></div>
    </section>
  </main>

  <!-- Bottom navigation -->
  <footer class="bottomNav">
    <div class="navBar">
      <div class="navItem active" id="navHome" onclick="App.nav('home')">ğŸ <div>Trang chá»§</div></div>
      <div class="navItem" id="navSearch" onclick="App.nav('search')">ğŸ”<div>TÃ¬m</div></div>
      <div class="navItem" id="navLibrary" onclick="App.nav('library')">ğŸ“š<div>Tá»§</div></div>
      <div class="navItem" id="navFollow" onclick="App.nav('follow')">â¤ï¸<div>Theo dÃµi</div></div>
      <div class="navItem" id="navCult" onclick="App.nav('cult')">âš¡<div>Tu luyá»‡n</div></div>
    </div>
  </footer>

  <!-- Drawer -->
  <div class="overlay" id="overlay" onclick="App.closeDrawer()"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawerHead">
      <div style="display:flex;align-items:center;gap:10px;min-width:0;">
        <div class="avatarBtn" style="width:44px;height:44px;">
          <img id="drawerAvatar" alt="avatar" src="https://i.imgur.com/F32pUuu.jpeg">
        </div>
        <div style="min-width:0;">
          <div style="font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" id="drawerName">KhÃ¡ch</div>
          <div class="small" id="drawerEmail">ChÆ°a Ä‘Äƒng nháº­p</div>
        </div>
      </div>
      <button class="iconBtn" onclick="App.closeDrawer()" title="ÄÃ³ng">âœ•</button>
    </div>
    <div class="drawerBody">
      <div class="section" style="box-shadow:none;background:rgba(255,255,255,.02);">
        <div class="sectionHead" style="border-bottom:none;">
          <div>
            <div class="sectionTitle">âš¡ Tu vi</div>
            <div class="small" id="cultivationSub">Äá»c truyá»‡n Ä‘á»ƒ tÄƒng tu vi.</div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:1000;color:var(--gold2);" id="cultivationLevel">PhÃ m NhÃ¢n</div>
            <div class="small" id="cultivationExp">0 / 100</div>
          </div>
        </div>
        <div style="padding:0 14px 14px;">
          <div class="progress"><i id="cultivationBar"></i></div>
          <div class="small" style="margin-top:8px;">Má»—i chÆ°Æ¡ng Ä‘á»c xong +EXP. CÃ³ thá»ƒ báº¥m â€œÄÃ£ Ä‘á»c xongâ€ á»Ÿ cuá»‘i chÆ°Æ¡ng.</div>
        </div>
      </div>

      <div class="sep"></div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" onclick="App.nav('home');App.closeDrawer();">ğŸ  Trang chá»§</button>
        <button class="btn" onclick="App.nav('search');App.closeDrawer();">ğŸ” TÃ¬m</button>
        <button class="btn" onclick="App.nav('library');App.closeDrawer();">ğŸ“š Tá»§ truyá»‡n</button>
        <button class="btn" onclick="App.nav('follow');App.closeDrawer();">â¤ï¸ Theo dÃµi</button>
        <button class="btn" onclick="App.nav('cult');App.closeDrawer();">âš¡ Tu luyá»‡n</button>
      </div>

      <div class="sep"></div>

      <!-- Pay / VIP -->
      <div>
        <div style="font-weight:1000;margin-bottom:10px;">ğŸª™ VIP / á»¦ng há»™</div>
        <div class="small">Báº¡n cÃ³ thá»ƒ Ä‘á»ƒ QR ngÃ¢n hÃ ng táº¡i Ä‘Ã¢y. NgÆ°á»i náº¡p ghi Ä‘Ãºng â€œmÃ£ náº¡pâ€ Ä‘á»ƒ báº¡n Ä‘á»‘i soÃ¡t.</div>
        <div class="sep"></div>
        <div class="grid2">
          <input class="field" id="payCode" placeholder="MÃ£ náº¡p (vÃ­ dá»¥: CT1234)" />
          <button class="btn gold" onclick="App.copyPayCode()">ğŸ“‹ Copy mÃ£</button>
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <button class="btn" onclick="App.toast('Báº¡n thay QR theo ngÃ¢n hÃ ng cá»§a báº¡n nhÃ©!')">ğŸ§¾ HÆ°á»›ng dáº«n</button>
          <button class="btn gold" onclick="App.toast('Sau nÃ y mÃ¬nh sáº½ lÃ m trang VIP chi tiáº¿t + quyá»n lá»£i.')">âœ¨ Quyá»n lá»£i VIP</button>
        </div>
        <div class="sep"></div>
        <div style="border:1px dashed rgba(215,184,107,.35);border-radius:16px;padding:12px;background:rgba(215,184,107,.06);">
          <div style="font-weight:1000;color:var(--gold2);">ğŸ“Œ Chá»— Ä‘áº·t QR</div>
          <div class="small">Báº¡n cÃ³ thá»ƒ thay hÃ¬nh áº£nh QR trong HTML (tÃ¬m â€œqr-placeholderâ€).</div>
          <div style="margin-top:10px;display:flex;justify-content:center;">
            <img id="qr-placeholder" alt="QR placeholder" src="https://i.imgur.com/4gX4qN8.png" style="width:220px;max-width:100%;border-radius:16px;border:1px solid rgba(255,255,255,.10);" />
          </div>
        </div>
      </div>

      <div class="sep"></div>

      <!-- Auth -->
      <div id="authBox">
        <div style="font-weight:1000;margin-bottom:10px;">ğŸ” TÃ i khoáº£n</div>
        <button class="btn gold" id="btnLogin" onclick="App.loginGoogle()">ÄÄƒng nháº­p Google</button>
        <button class="btn danger hidden" id="btnLogout" onclick="App.logout()">ÄÄƒng xuáº¥t</button>
        <div class="small" style="margin-top:10px;">
          * ÄÄƒng nháº­p Ä‘á»ƒ Ä‘á»“ng bá»™ theo dÃµi/tá»§/lá»‹ch sá»­/tu vi lÃªn Firebase.
        </div>
      </div>

      <div class="sep"></div>

      <!-- Admin panel -->
      <div id="adminPanel" class="hidden">
        <div style="font-weight:1000;margin-bottom:10px;">ğŸ›  Admin</div>

        <div class="small">Chá»‰ email trong danh sÃ¡ch admin má»›i tháº¥y má»¥c nÃ y.</div>

        <div class="sep"></div>

        <div style="font-weight:1000;margin-bottom:6px;">â• ThÃªm truyá»‡n</div>
        <input class="field" id="a_title" placeholder="TÃªn truyá»‡n" />
        <input class="field" id="a_author" placeholder="TÃ¡c giáº£ (tuá»³ chá»n)" />
        <input class="field" id="a_cover" placeholder="Link áº£nh bÃ¬a (URL) - khuyÃªn dÃ¹ng imgur" />
        <input class="field" id="a_category" placeholder="Thá»ƒ loáº¡i (vÃ­ dá»¥: TiÃªn Hiá»‡p)" />
        <textarea class="field" id="a_desc" placeholder="MÃ´ táº£"></textarea>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
          <button class="btn gold" onclick="App.adminCreateStory()">LÆ°u truyá»‡n</button>
          <button class="btn" onclick="App.adminOpenImport()">Nháº­p dá»¯ liá»‡u cÅ© (LocalStorage)</button>
        </div>

        <div class="sep"></div>

        <div style="font-weight:1000;margin-bottom:6px;">â• ThÃªm chÆ°Æ¡ng cho truyá»‡n</div>
        <select class="field" id="a_storySelect"></select>
        <div class="grid2">
          <input class="field" id="a_chapIndex" placeholder="Sá»‘ chÆ°Æ¡ng (1,2,3...)" inputmode="numeric" />
          <input class="field" id="a_chapTitle" placeholder="TÃªn chÆ°Æ¡ng" />
        </div>
        <textarea class="field" id="a_chapContent" placeholder="Ná»™i dung chÆ°Æ¡ng (truyá»‡n chá»¯)"></textarea>
        <button class="btn gold" style="margin-top:10px;" onclick="App.adminAddChapter()">LÆ°u chÆ°Æ¡ng</button>

        <div class="sep"></div>

        <div class="small">
          âš ï¸ LÆ°u Ã½: Firestore rules cáº§n cáº¥u hÃ¬nh trong Firebase Console (mÃ¬nh cÃ³ ghi hÆ°á»›ng dáº«n á»Ÿ cuá»‘i file).
        </div>
      </div>
    </div>
  </aside>

  <!-- Modal: Search / Library / Follow / Cultivation / Story Detail / Reader -->
  <div class="modal" id="modal">
    <div class="sheet" id="sheet">
      <div class="sheetHead">
        <div class="sheetTitle" id="sheetTitle">...</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="iconBtn" onclick="App.closeModal()" title="ÄÃ³ng">âœ•</button>
        </div>
      </div>
      <div class="sheetBody" id="sheetBody"></div>
    </div>
  </div>

  <!-- Firebase (v9 modular) -->
  <script type="module">
    // =============================
    // 0) Firebase config
    // =============================
    // âœ… Báº¡n cÃ³ thá»ƒ thay config nÃ y báº±ng project Firebase cá»§a báº¡n.
    // (apiKey khÃ´ng pháº£i bÃ­ máº­t, nhÆ°ng báº¡n váº«n cáº§n Security Rules Ä‘Ãºng.)
    const firebaseConfig = {
      apiKey: "AIzaSyBXwVGry1tXPmplvIPW243TY56IKWahMKM",
      authDomain: "cuuhuyenvangioi.firebaseapp.com",
      projectId: "cuuhuyenvangioi",
      storageBucket: "cuuhuyenvangioi.firebasestorage.app",
      messagingSenderId: "158345855725",
      appId: "1:158345855725:web:2db1424211abb9cfba42e4"
    };

    // =============================
    // 1) Imports
    // =============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc,
      serverTimestamp, query, orderBy, limit, getDocs, onSnapshot,
      increment
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // =============================
    // 2) Init
    // =============================
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // =============================
    // 3) Helpers
    // =============================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const ADMIN_EMAILS = new Set([
      "sumi22122005@gmail.com" // âœ… Admin email
    ]);

    const DEFAULT_COVER = "https://i.imgur.com/F32pUuu.jpeg";
    const LS = {
      theme: "ct_theme",
      follow: "ct_follow",
      library: "ct_library",
      history: "ct_history",
      lastRead: "ct_lastread",
      readerSize: "ct_reader_size",
    };

    const CULT_REALMS = [
      { name: "PhÃ m NhÃ¢n", need: 100 },
      { name: "Luyá»‡n KhÃ­", need: 220 },
      { name: "TrÃºc CÆ¡", need: 380 },
      { name: "Kim Äan", need: 600 },
      { name: "NguyÃªn Anh", need: 900 },
      { name: "HÃ³a Tháº§n", need: 1400 },
      { name: "Luyá»‡n HÆ°", need: 2200 },
      { name: "Äáº¡i Thá»«a", need: 3400 },
      { name: "Äá»™ Kiáº¿p", need: 5200 },
      { name: "TiÃªn NhÃ¢n", need: 8000 }
    ];

    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
    function now(){ return Date.now(); }

    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>t.classList.remove("show"), 2800);
    }

    function uidSafe(s){ return (s||"").replace(/[^\w\-]+/g,"_").slice(0,120); }

    function fmtTime(ts){
      if(!ts) return "";
      const d = (ts instanceof Date) ? ts : new Date(ts);
      return d.toLocaleString("vi-VN", { hour12:false });
    }

    // Web Speech API (TTS)
    let ttsUtter = null;
    function ttsStop(){
      try { speechSynthesis.cancel(); } catch(e){}
      ttsUtter = null;
    }
    function ttsSpeak(text){
      if(!("speechSynthesis" in window)) {
        toast("Thiáº¿t bá»‹ khÃ´ng há»— trá»£ Ä‘á»c truyá»‡n (TTS).");
        return;
      }
      ttsStop();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "vi-VN";
      u.rate = 1;
      u.pitch = 1;
      ttsUtter = u;
      speechSynthesis.speak(u);
    }

    // =============================
    // 4) Data access (Firestore)
    // =============================
    // stories: collection("stories")
    // chapters: doc("stories/{storyId}") -> collection("chapters")
    // users: doc("users/{uid}") with profile + cultivation + lists

    async function ensureUserDoc(user){
      if(!user) return;
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          uid: user.uid,
          email: user.email || "",
          displayName: user.displayName || "NgÆ°á»i chÆ¡i",
          photoURL: user.photoURL || "",
          createdAt: serverTimestamp(),
          cultivationExp: 0,
          cultivationRealmIndex: 0,
          follow: [],
          library: [],
          history: [],
          lastRead: null,
          vipTier: 0
        });
      } else {
        // keep profile fresh
        await updateDoc(ref, {
          email: user.email || "",
          displayName: user.displayName || "NgÆ°á»i chÆ¡i",
          photoURL: user.photoURL || ""
        });
      }
    }

    async function loadUserState(uid){
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    async function saveUserLists(uid, patch){
      const ref = doc(db, "users", uid);
      await updateDoc(ref, patch);
    }

    // =============================
    // 5) App state
    // =============================
    const State = {
      user: null,
      userDoc: null,
      isAdmin: false,
      stories: [],
      storyMap: new Map(),
      unsubStories: null,
      activeStory: null,
      activeChapter: null,
      nav: "home", // home/search/library/follow/cult
    };

    // =============================
    // 6) Rendering
    // =============================
    function setNav(active){
  State.nav = active;
  const ids = { home:"navHome", search:"navSearch", library:"navLibrary", follow:"navFollow", cult:"navCult" };
  Object.values(ids).forEach(id=> $("#"+id)?.classList.remove("active"));
  const on = ids[active];
  if(on) $("#"+on)?.classList.add("active");

  // open modal pages
  if(active === "home"){
    App.closeModal();
  } else if(active === "search"){
    App.openSearch();
  } else if(active === "library"){
    App.openLibrary();
  } else if(active === "follow"){
    App.openFollowed();
  } else if(active === "cult"){
    App.openCultivation();
  }
}

    function updateHeaderProfile(){
      const u = State.user;
      $("#avatarImg").src = (u?.photoURL) || "https://i.imgur.com/F32pUuu.jpeg";
      $("#drawerAvatar").src = (u?.photoURL) || "https://i.imgur.com/F32pUuu.jpeg";
      $("#drawerName").textContent = u?.displayName || "KhÃ¡ch";
      $("#drawerEmail").textContent = u?.email || "ChÆ°a Ä‘Äƒng nháº­p";

      $("#btnLogin").classList.toggle("hidden", !!u);
      $("#btnLogout").classList.toggle("hidden", !u);

      $("#adminPanel").classList.toggle("hidden", !State.isAdmin);
      if(State.isAdmin) refreshAdminStorySelect();
    }

    function calcCultivationView(){
      const exp = State.userDoc?.cultivationExp ?? 0;
      let idx = State.userDoc?.cultivationRealmIndex ?? 0;
      idx = clamp(idx, 0, CULT_REALMS.length-1);
      const realm = CULT_REALMS[idx];
      const nextNeed = realm.need;
      const pct = clamp((exp / nextNeed) * 100, 0, 100);

      $("#cultivationLabel").textContent = realm.name;
      $("#cultivationLevel").textContent = realm.name;
      $("#cultivationExp").textContent = `${exp} / ${nextNeed}`;
      $("#cultivationBar").style.width = `${pct}%`;
    }

    function storyCardHTML(s, extraTag=""){
      const tags = [];
      if(s.status) tags.push(`<span class="miniTag gold">${s.status}</span>`);
      if(extraTag) tags.push(`<span class="miniTag">${extraTag}</span>`);
      const views = s.views ?? 0;
      const likes = s.likes ?? 0;
      const chapCount = s.chapterCount ?? 0;
      const cover = s.coverUrl || DEFAULT_COVER;

      return `
        <div class="storyCard" data-id="${s.id}">
          <div class="cover">
            <img src="${cover}" alt="cover" onerror="this.src='${DEFAULT_COVER}'"/>
            <div class="cardMeta">${tags.join("")}</div>
          </div>
          <div class="cardBody">
            <div class="cardTitle">${escapeHtml(s.title || "KhÃ´ng tÃªn")}</div>
            <div class="cardStats">
              <span class="stat">ğŸ‘ ${views}</span>
              <span class="stat">ğŸ‘ ${likes}</span>
              <span class="stat">ğŸ“„ ${chapCount}</span>
            </div>
          </div>
        </div>
      `;
    }

    function rowCardHTML(s){
      const cover = s.coverUrl || DEFAULT_COVER;
      return `
        <div class="rowCard" data-id="${s.id}">
          <div class="rowCover"><img src="${cover}" alt="cover" onerror="this.src='${DEFAULT_COVER}'"></div>
          <div class="rowMain">
            <div class="rowTitle">${escapeHtml(s.title || "KhÃ´ng tÃªn")}</div>
            <div class="rowDesc">${escapeHtml(s.desc || "")}</div>
            <div class="rowLine">
              <span>ğŸ‘¤ ${escapeHtml(s.author || "TÃ¡c giáº£")}</span>
              <span>ğŸ•’ ${s.updatedAtMillis ? fmtTime(s.updatedAtMillis) : ""}</span>
            </div>
          </div>
        </div>
      `;
    }

    function renderHome(){
      const stories = State.stories;

      // Continue reading from user doc (or local)
      const lastRead = State.userDoc?.lastRead || JSON.parse(localStorage.getItem(LS.lastRead) || "null");
      const continueList = [];
      if(lastRead?.storyId){
        const st = State.storyMap.get(lastRead.storyId);
        if(st) continueList.push({s:st, tag: "Äá»c tiáº¿p"});
      }

      // also show history last few
      const history = (State.userDoc?.history || JSON.parse(localStorage.getItem(LS.history) || "[]")).slice(0,8);
      history.forEach(item=>{
        const st = State.storyMap.get(item.storyId);
        if(st && !continueList.some(x=>x.s.id===st.id)) continueList.push({s:st, tag:"Gáº§n Ä‘Ã¢y"});
      });

      const continueRow = $("#continueRow");
      continueRow.innerHTML = continueList.length
        ? continueList.map(x=>storyCardHTML(x.s, x.tag)).join("")
        : `<div class="muted" style="padding:10px 2px;">ChÆ°a cÃ³ lá»‹ch sá»­ Ä‘á»c. HÃ£y chá»n má»™t truyá»‡n Ä‘á»ƒ báº¯t Ä‘áº§u.</div>`;

      // Random
      const randomRow = $("#randomRow");
      const shuffled = [...stories].sort(()=>Math.random()-0.5).slice(0,12);
      randomRow.innerHTML = shuffled.map(s=>storyCardHTML(s)).join("") || `<div class="muted">ChÆ°a cÃ³ truyá»‡n.</div>`;

      // Latest list
      const latestList = $("#latestList");
      latestList.innerHTML = stories.slice(0,12).map(s=>rowCardHTML(s)).join("") || `<div class="muted">ChÆ°a cÃ³ truyá»‡n.</div>`;

      // click handlers
      attachStoryClicks(continueRow);
      attachStoryClicks(randomRow);
      attachStoryClicks(latestList);
    }

    function attachStoryClicks(root){
      $$("[data-id]", root).forEach(el=>{
        el.onclick = ()=> App.openStory(el.dataset.id);
      });
    }

    function escapeHtml(str){
      return (str || "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function renderSearchPage(){
      const html = `
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <input class="field" id="qSearch" placeholder="TÃ¬m truyá»‡n..." />
          <select class="field" id="qCategory" style="max-width:220px;">
            <option value="">Táº¥t cáº£ thá»ƒ loáº¡i</option>
          </select>
          <button class="btn gold" onclick="App.runSearch()">TÃ¬m</button>
        </div>
        <div class="sep"></div>
        <div class="list" id="searchResults"></div>
      `;
      App.openModal("ğŸ” TÃ¬m truyá»‡n", html, ()=> {
        // fill categories
        const cats = Array.from(new Set(State.stories.map(s=>s.category).filter(Boolean))).sort();
        const sel = $("#qCategory");
        cats.forEach(c=>{
          const op = document.createElement("option");
          op.value = c; op.textContent = c;
          sel.appendChild(op);
        });
        $("#qSearch").addEventListener("input", App.runSearch);
        $("#qCategory").addEventListener("change", App.runSearch);
        App.runSearch();
      });
    }

    function renderLibraryPage(){
      const list = State.userDoc?.library || JSON.parse(localStorage.getItem(LS.library) || "[]");
      const html = `
        <div class="small">Truyá»‡n báº¡n Ä‘Ã£ lÆ°u vÃ o tá»§.</div>
        <div class="sep"></div>
        <div class="list" id="libList"></div>
      `;
      App.openModal("ğŸ“š Tá»§ truyá»‡n", html, ()=>{
        const box = $("#libList");
        const stories = list.map(x=>State.storyMap.get(x.storyId)).filter(Boolean);
        box.innerHTML = stories.length ? stories.map(s=>rowCardHTML(s)).join("") : `<div class="muted">ChÆ°a cÃ³ truyá»‡n trong tá»§.</div>`;
        attachStoryClicks(box);
      });
    }

    function renderFollowedPage(){
      const list = State.userDoc?.follow || JSON.parse(localStorage.getItem(LS.follow) || "[]");
      const html = `
        <div class="small">Truyá»‡n báº¡n theo dÃµi.</div>
        <div class="sep"></div>
        <div class="list" id="folList"></div>
      `;
      App.openModal("â¤ï¸ Theo dÃµi", html, ()=>{
        const box = $("#folList");
        const stories = list.map(x=>State.storyMap.get(x.storyId)).filter(Boolean);
        box.innerHTML = stories.length ? stories.map(s=>rowCardHTML(s)).join("") : `<div class="muted">ChÆ°a theo dÃµi truyá»‡n nÃ o.</div>`;
        attachStoryClicks(box);
      });
    }

    function renderCultivationPage(){
      const realm = $("#cultivationLevel")?.textContent || "PhÃ m NhÃ¢n";
      const html = `
        <div class="reader">
          <div style="font-weight:1000;font-size:16px;">âš¡ Tu luyá»‡n</div>
          <div class="small" style="margin-top:6px;">Äá»c truyá»‡n Ä‘á»ƒ tÄƒng EXP. CÃ ng Ä‘á»c cÃ ng lÃªn cáº£nh giá»›i.</div>
          <div class="sep"></div>

          <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div>
              <div style="font-weight:1000;color:var(--gold2);font-size:18px;">${realm}</div>
              <div class="small" id="cultModalExp">...</div>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn" onclick="App.toast('Gá»£i Ã½: chá»n 1 truyá»‡n â†’ má»Ÿ chÆ°Æ¡ng â†’ Ä‘á»c tá»›i cuá»‘i â†’ báº¥m â€œÄÃ£ Ä‘á»c xongâ€.')">ğŸ“Œ CÃ¡ch tÄƒng tu vi</button>
              <button class="btn gold" onclick="App.nav('search')">ğŸ” Äi Ä‘á»c truyá»‡n</button>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="progress"><i id="cultModalBar"></i></div>
          </div>

          <div class="sep"></div>
          <div style="font-weight:1000;margin-bottom:8px;">ğŸ•˜ Lá»‹ch sá»­ Ä‘á»c gáº§n Ä‘Ã¢y</div>
          <div class="list" id="histList"></div>
        </div>
      `;
      App.openModal("âš¡ Tu luyá»‡n", html, ()=>{
        // sync bar/exp from drawer
        const exp = State.userDoc?.cultivationExp ?? 0;
        let idx = State.userDoc?.cultivationRealmIndex ?? 0;
        idx = clamp(idx, 0, CULT_REALMS.length-1);
        const need = CULT_REALMS[idx].need;
        $("#cultModalExp").textContent = `${exp} / ${need} EXP`;
        $("#cultModalBar").style.width = `${clamp((exp/need)*100,0,100)}%`;

        const hist = (State.userDoc?.history || JSON.parse(localStorage.getItem(LS.history) || "[]")).slice(0,12);
        const box = $("#histList");
        const stories = hist.map(x=>State.storyMap.get(x.storyId)).filter(Boolean);
        box.innerHTML = stories.length ? stories.map(s=>rowCardHTML(s)).join("") : `<div class="muted">ChÆ°a cÃ³ lá»‹ch sá»­.</div>`;
        attachStoryClicks(box);
      });
    }

    function renderStoryDetail(storyId){
      const s = State.storyMap.get(storyId);
      if(!s) return toast("KhÃ´ng tÃ¬m tháº¥y truyá»‡n.");
      State.activeStory = s;

      const isFollowed = isInList("follow", storyId);
      const isInLib = isInList("library", storyId);

      const html = `
        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <div style="width:110px;flex:0 0 auto;border-radius:16px;overflow:hidden;border:1px solid var(--line);background:rgba(255,255,255,.04);">
            <img src="${s.coverUrl||DEFAULT_COVER}" style="width:100%;height:100%;object-fit:cover;display:block;" onerror="this.src='${DEFAULT_COVER}'">
          </div>
          <div style="flex:1;min-width:0;">
            <div style="font-weight:1000;font-size:16px;line-height:1.25;">${escapeHtml(s.title)}</div>
            <div class="chipRow">
              ${s.category ? `<span class="chip">ğŸ· ${escapeHtml(s.category)}</span>` : ""}
              <span class="chip">ğŸ‘ ${(s.views||0)}</span>
              <span class="chip">ğŸ‘ ${(s.likes||0)}</span>
              <span class="chip">ğŸ“„ ${(s.chapterCount||0)} chÆ°Æ¡ng</span>
            </div>
            <div class="small" style="margin-top:8px;">${escapeHtml(s.desc||"")}</div>
            <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
              <button class="btn gold" onclick="App.readFirst()">ğŸ“– Äá»c tá»« Ä‘áº§u</button>
              <button class="btn" onclick="App.readContinue()">ğŸ•’ Äá»c tiáº¿p</button>
              <button class="btn" onclick="App.toggleFollow('${storyId}')">${isFollowed ? "ğŸ’” Bá» theo dÃµi" : "â¤ï¸ Theo dÃµi"}</button>
              <button class="btn" onclick="App.toggleLibrary('${storyId}')">${isInLib ? "âŒ XoÃ¡ khá»i tá»§" : "ğŸ“š ThÃªm vÃ o tá»§"}</button>
            </div>
          </div>
        </div>

        <div class="sep"></div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-weight:1000;">ğŸ“„ Danh sÃ¡ch chÆ°Æ¡ng</div>
          <button class="btn" onclick="App.reloadChapters()">âŸ³ Táº£i láº¡i</button>
        </div>
        <div class="chapterList" id="chapterList">
          <div class="muted">Äang táº£i chÆ°Æ¡ng...</div>
        </div>
      `;

      App.openModal("ğŸ“š Chi tiáº¿t truyá»‡n", html, async ()=>{
        await bumpStoryView(s.id);
        await App.reloadChapters();
      });
    }

    async function bumpStoryView(storyId){
      try{
        const ref = doc(db, "stories", storyId);
        await updateDoc(ref, { views: increment(1), updatedAt: serverTimestamp() });
      }catch(e){}
    }

    async function loadChapters(storyId){
      // Simple: fetch all (OK for MVP). Later can paginate.
      const qCh = query(collection(db, "stories", storyId, "chapters"), orderBy("index","asc"), limit(3000));
      const snap = await getDocs(qCh);
      const chapters = [];
      snap.forEach(d=>{
        const data = d.data();
        chapters.push({ id:d.id, ...data });
      });
      return chapters;
    }

    async function renderChaptersList(storyId){
      const chapters = await loadChapters(storyId);
      State.activeStory.chaptersCache = chapters;

      // update count if needed
      if((State.activeStory.chapterCount||0) !== chapters.length){
        try{
          await updateDoc(doc(db,"stories",storyId), { chapterCount: chapters.length });
        }catch(e){}
      }

      const box = $("#chapterList");
      if(!box) return;
      if(!chapters.length){
        box.innerHTML = `<div class="muted">ChÆ°a cÃ³ chÆ°Æ¡ng. Admin hÃ£y thÃªm chÆ°Æ¡ng.</div>`;
        return;
      }
      box.innerHTML = chapters.map(ch=>{
        const done = isChapterDone(storyId, ch.id) ? "âœ…" : "ğŸ“–";
        return `
          <div class="chapterItem" data-chid="${ch.id}">
            <div class="left">
              <div class="t">${done} ChÆ°Æ¡ng ${ch.index}: ${escapeHtml(ch.title||"")}</div>
              <div class="s">${(ch.updatedAtMillis ? fmtTime(ch.updatedAtMillis) : "")}</div>
            </div>
            <div class="miniTag">â†’</div>
          </div>
        `;
      }).join("");

      $$("[data-chid]", box).forEach(el=>{
        el.onclick = ()=> App.openReader(storyId, el.dataset.chid);
      });
    }

    function isInList(kind, storyId){
      const key = kind === "follow" ? "follow" : "library";
      const arr = State.userDoc?.[key] || JSON.parse(localStorage.getItem(kind === "follow" ? LS.follow : LS.library) || "[]");
      return arr.some(x=>x.storyId === storyId);
    }

    function setInList(kind, storyId, yes){
      const key = kind === "follow" ? "follow" : "library";
      const lsKey = kind === "follow" ? LS.follow : LS.library;
      const arr = State.userDoc?.[key] || JSON.parse(localStorage.getItem(lsKey) || "[]");
      const has = arr.some(x=>x.storyId === storyId);
      let next = arr;
      if(yes && !has) next = [{storyId, at: now()}, ...arr].slice(0,500);
      if(!yes && has) next = arr.filter(x=>x.storyId !== storyId);

      if(State.user){
        const patch = {}; patch[key] = next;
        saveUserLists(State.user.uid, patch).then(()=>{ State.userDoc[key]=next; renderHome(); });
      } else {
        localStorage.setItem(lsKey, JSON.stringify(next));
        renderHome();
      }
    }

    function getHistory(){
      return State.userDoc?.history || JSON.parse(localStorage.getItem(LS.history) || "[]");
    }

    function pushHistory(storyId, chapterId){
      const story = State.storyMap.get(storyId);
      const item = { storyId, chapterId, at: now(), title: story?.title || "" };
      let hist = getHistory().filter(x=>x.storyId !== storyId); // keep 1 per story
      hist.unshift(item);
      hist = hist.slice(0,200);

      if(State.user){
        saveUserLists(State.user.uid, { history: hist, lastRead: item }).then(()=>{
          State.userDoc.history = hist;
          State.userDoc.lastRead = item;
          renderHome();
          calcCultivationView();
        });
      } else {
        localStorage.setItem(LS.history, JSON.stringify(hist));
        localStorage.setItem(LS.lastRead, JSON.stringify(item));
        renderHome();
      }
    }

    function isChapterDone(storyId, chapterId){
      const key = `ct_done_${storyId}`;
      const done = JSON.parse(localStorage.getItem(key) || "[]");
      return done.includes(chapterId);
    }
    function markChapterDone(storyId, chapterId){
      const key = `ct_done_${storyId}`;
      const done = JSON.parse(localStorage.getItem(key) || "[]");
      if(!done.includes(chapterId)){
        done.push(chapterId);
        localStorage.setItem(key, JSON.stringify(done.slice(0,5000)));
      }
    }

    function getReaderSize(){
      const n = Number(localStorage.getItem(LS.readerSize) || 16);
      return clamp(n, 14, 22);
    }
    function setReaderSize(n){
      localStorage.setItem(LS.readerSize, String(clamp(n,14,22)));
      document.documentElement.style.setProperty("--reader-size", `${getReaderSize()}px`);
    }

    // =============================
    // 7) Reader + cultivation exp
    // =============================
    async function openReader(storyId, chapterId){
      const s = State.storyMap.get(storyId);
      if(!s) return toast("KhÃ´ng tÃ¬m tháº¥y truyá»‡n.");
      const chapters = s.chaptersCache || await loadChapters(storyId);
      const ch = chapters.find(x=>x.id === chapterId);
      if(!ch) return toast("KhÃ´ng tÃ¬m tháº¥y chÆ°Æ¡ng.");

      State.activeStory = s;
      State.activeChapter = ch;

      pushHistory(storyId, chapterId);

      const html = `
        <div class="reader">
          <div class="small">ğŸ“š ${escapeHtml(s.title)} â€¢ ChÆ°Æ¡ng ${ch.index}</div>
          <div class="readerTitle">${escapeHtml(ch.title || "")}</div>

          <div class="readerControls">
            <button class="btn" onclick="App.prevChapter()">â† TrÆ°á»›c</button>
            <button class="btn" onclick="App.nextChapter()">Sau â†’</button>
            <button class="btn gold" onclick="App.tts()">ğŸ”Š Nghe</button>
            <button class="btn" onclick="App.ttsStop()">â¹ Dá»«ng</button>
            <button class="btn" onclick="App.fontMinus()">A-</button>
            <button class="btn" onclick="App.fontPlus()">A+</button>
          </div>

          <div class="readerText" id="readerText">${escapeHtml(ch.content || "")}</div>

          <div class="sep"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <button class="btn gold" onclick="App.finishChapter()">âœ… ÄÃ£ Ä‘á»c xong (nháº­n EXP)</button>
            <button class="btn" onclick="App.openStory('${storyId}')">ğŸ“„ Danh sÃ¡ch chÆ°Æ¡ng</button>
          </div>

          <div class="small" style="margin-top:10px;">
            Máº¹o: Ä‘á»c tá»›i cuá»‘i vÃ  báº¥m â€œÄÃ£ Ä‘á»c xongâ€ Ä‘á»ƒ tÄƒng tu vi nhanh hÆ¡n.
          </div>
        </div>
      `;

      App.openModal("ğŸ“– Äá»c truyá»‡n", html, ()=>{
        // apply font size
        setReaderSize(getReaderSize());
        // scroll top
        $("#sheetBody").scrollTop = 0;
      });
    }

    function getNeighborChapter(delta){
      const s = State.activeStory;
      const ch = State.activeChapter;
      if(!s || !ch) return null;
      const list = s.chaptersCache || [];
      const idx = list.findIndex(x=>x.id === ch.id);
      const next = list[idx + delta];
      return next || null;
    }

    async function gainExp(amount){
      if(amount <= 0) return;
      // local first
      if(!State.user){
        // guest exp in localStorage
        const key = "ct_guest_cult";
        const cur = JSON.parse(localStorage.getItem(key) || '{"exp":0,"idx":0}');
        let exp = (cur.exp||0) + amount;
        let idx = cur.idx||0;
        while(idx < CULT_REALMS.length-1 && exp >= CULT_REALMS[idx].need){
          exp -= CULT_REALMS[idx].need;
          idx++;
        }
        localStorage.setItem(key, JSON.stringify({exp, idx}));
        // reflect to UI as pseudo userDoc
        State.userDoc = { ...(State.userDoc||{}), cultivationExp: exp, cultivationRealmIndex: idx };
        calcCultivationView();
        return;
      }

      // logged-in: update Firestore atomically-ish
      const ref = doc(db, "users", State.user.uid);
      // pull latest from state
      let exp = State.userDoc?.cultivationExp ?? 0;
      let idx = State.userDoc?.cultivationRealmIndex ?? 0;
      exp += amount;
      while(idx < CULT_REALMS.length-1 && exp >= CULT_REALMS[idx].need){
        exp -= CULT_REALMS[idx].need;
        idx++;
      }
      State.userDoc.cultivationExp = exp;
      State.userDoc.cultivationRealmIndex = idx;
      calcCultivationView();
      try{
        await updateDoc(ref, { cultivationExp: exp, cultivationRealmIndex: idx });
      }catch(e){}
    }

    // =============================
    // 8) Load stories (realtime)
    // =============================
    function subscribeStories(){
      if(State.unsubStories) State.unsubStories();
      const qy = query(collection(db, "stories"), orderBy("updatedAt", "desc"), limit(60));
      State.unsubStories = onSnapshot(qy, (snap)=>{
        const arr = [];
        snap.forEach(d=>{
          const data = d.data();
          arr.push({
            id: d.id,
            ...data,
            updatedAtMillis: data.updatedAt?.toMillis ? data.updatedAt.toMillis() : null
          });
        });
        State.stories = arr;
        State.storyMap = new Map(arr.map(s=>[s.id, s]));
        renderHome();
        if(State.isAdmin) refreshAdminStorySelect();
      }, (err)=>{
        console.error(err);
        toast("KhÃ´ng táº£i Ä‘Æ°á»£c truyá»‡n tá»« Firebase. Kiá»ƒm tra máº¡ng / Firestore rules.");
      });
    }

    // =============================
    // 9) Admin
    // =============================
    function refreshAdminStorySelect(){
      const sel = $("#a_storySelect");
      if(!sel) return;
      sel.innerHTML = "";
      State.stories.forEach(s=>{
        const op = document.createElement("option");
        op.value = s.id;
        op.textContent = s.title || s.id;
        sel.appendChild(op);
      });
    }

    async function adminCreateStory(){
      const title = $("#a_title").value.trim();
      const author = $("#a_author").value.trim();
      const coverUrl = $("#a_cover").value.trim();
      const category = $("#a_category").value.trim();
      const desc = $("#a_desc").value.trim();
      if(!title || !desc) return toast("Nháº­p TÃªn truyá»‡n + MÃ´ táº£.");

      try{
        await addDoc(collection(db,"stories"), {
          title, author,
          coverUrl: coverUrl || DEFAULT_COVER,
          category,
          desc,
          views: 0,
          likes: 0,
          chapterCount: 0,
          status: "HOT",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        toast("âœ… ÄÃ£ thÃªm truyá»‡n!");
        $("#a_title").value = "";
        $("#a_author").value = "";
        $("#a_cover").value = "";
        $("#a_category").value = "";
        $("#a_desc").value = "";
      }catch(e){
        console.error(e);
        toast("âŒ KhÃ´ng thÃªm Ä‘Æ°á»£c. Kiá»ƒm tra Firestore rules.");
      }
    }

    async function adminAddChapter(){
      const storyId = $("#a_storySelect").value;
      const index = Number($("#a_chapIndex").value);
      const title = $("#a_chapTitle").value.trim();
      const content = $("#a_chapContent").value.trim();
      if(!storyId || !index || !title || !content) return toast("Nháº­p Ä‘á»§: truyá»‡n + sá»‘ chÆ°Æ¡ng + tÃªn + ná»™i dung.");

      try{
        await addDoc(collection(db,"stories",storyId,"chapters"), {
          index,
          title,
          content,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        await updateDoc(doc(db,"stories",storyId), { updatedAt: serverTimestamp(), chapterCount: increment(1) });
        toast("âœ… ÄÃ£ thÃªm chÆ°Æ¡ng!");
        $("#a_chapIndex").value = "";
        $("#a_chapTitle").value = "";
        $("#a_chapContent").value = "";
      }catch(e){
        console.error(e);
        toast("âŒ KhÃ´ng thÃªm Ä‘Æ°á»£c chÆ°Æ¡ng. Kiá»ƒm tra Firestore rules.");
      }
    }

    function adminOpenImport(){
      const html = `
        <div class="small">
          TÃ­nh nÄƒng nÃ y sáº½ Ä‘á»c dá»¯ liá»‡u truyá»‡n cÅ© trong LocalStorage (file HTML trÆ°á»›c) vÃ  Ä‘áº©y sang Firestore.<br>
          - Truyá»‡n cÅ© dáº¡ng: localStorage["stories"] (cÃ³ episodes).<br>
          - MÃ¬nh sáº½ Ä‘á»•i episodes â†’ chapters (ná»™i dung Ä‘á»ƒ â€œ(chÆ°a cÃ³ ná»™i dung)â€ náº¿u trÆ°á»›c Ä‘Ã³ lÃ  audio).<br><br>
          âš ï¸ NÃªn cháº¡y 1 láº§n. TrÃ¡nh import trÃ¹ng.
        </div>
        <div class="sep"></div>
        <button class="btn gold" onclick="App.adminImportOld()">Báº¯t Ä‘áº§u import</button>
      `;
      App.openModal("â¬†ï¸ Import dá»¯ liá»‡u cÅ©", html);
    }

    async function adminImportOld(){
      const raw = localStorage.getItem("stories");
      if(!raw) return toast("KhÃ´ng tháº¥y localStorage['stories'] Ä‘á»ƒ import.");
      let list = [];
      try{ list = JSON.parse(raw) || []; }catch(e){ return toast("Dá»¯ liá»‡u cÅ© khÃ´ng há»£p lá»‡."); }
      if(!Array.isArray(list) || !list.length) return toast("Dá»¯ liá»‡u cÅ© trá»‘ng.");

      toast("Äang import... (Ä‘á»«ng táº¯t trang)");
      for(const s of list){
        const title = (s.title || "").trim();
        if(!title) continue;
        // Create story
        const docRef = await addDoc(collection(db,"stories"), {
          title,
          author: s.author || "",
          coverUrl: s.image || s.coverUrl || DEFAULT_COVER,
          category: s.category || "",
          desc: s.desc || "",
          views: s.views || 0,
          likes: s.stars || 0,
          chapterCount: (s.episodes||[]).length || 0,
          status: s.isHot ? "HOT" : (s.isFull ? "FULL" : ""),
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        // Chapters (episodes)
        const eps = Array.isArray(s.episodes) ? s.episodes : [];
        let idx = 0;
        for(const ep of eps){
          idx++;
          const ct = ep?.content || `(ChÆ°Æ¡ng nÃ y trÆ°á»›c Ä‘Ã¢y lÃ  audio: ${ep?.audio || ""})\n\n(ChÆ°a cÃ³ ná»™i dung chá»¯. Báº¡n cÃ³ thá»ƒ sá»­a láº¡i báº±ng cÃ¡ch thÃªm chÆ°Æ¡ng má»›i hoáº·c chá»‰nh trá»±c tiáº¿p trong Firestore.)`;
          await addDoc(collection(db,"stories",docRef.id,"chapters"), {
            index: idx,
            title: ep?.name || `ChÆ°Æ¡ng ${idx}`,
            content: ct,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        }
      }
      toast("âœ… Import xong! Quay láº¡i Trang chá»§ Ä‘á»ƒ xem.");
      App.closeModal();
    }

    // =============================
    // 10) Search
    // =============================
    function runSearch(){
      const q = ($("#qSearch")?.value || "").trim().toLowerCase();
      const cat = ($("#qCategory")?.value || "").trim();
      const box = $("#searchResults");
      if(!box) return;

      let list = State.stories;
      if(cat) list = list.filter(s => (s.category||"") === cat);
      if(q){
        list = list.filter(s => (s.title||"").toLowerCase().includes(q) || (s.desc||"").toLowerCase().includes(q));
      }
      box.innerHTML = list.length ? list.map(s=>rowCardHTML(s)).join("") : `<div class="muted">KhÃ´ng cÃ³ káº¿t quáº£.</div>`;
      attachStoryClicks(box);
    }

    // =============================
    // 11) Theme
    // =============================
    function applyTheme(theme){
      const isLight = theme === "light";
      document.body.classList.toggle("light", isLight);
      $("#themeBtn").textContent = isLight ? "â˜€ï¸" : "ğŸŒ™";
      localStorage.setItem(LS.theme, theme);
    }

    // =============================
    // 12) Public API for onclick
    // =============================
    window.App = {
      toast,
      nav: setNav,

      openDrawer(){
        $("#overlay").classList.add("show");
        $("#drawer").classList.add("open");
      },
      closeDrawer(){
        $("#overlay").classList.remove("show");
        $("#drawer").classList.remove("open");
      },

      openModal(title, html, after){
        $("#sheetTitle").textContent = title || "";
        $("#sheetBody").innerHTML = html || "";
        $("#modal").classList.add("show");
        ttsStop();
        requestAnimationFrame(()=>after && after());
      },
      closeModal(){
        $("#modal").classList.remove("show");
        $("#sheetBody").innerHTML = "";
        ttsStop();
      },

      openSearch(){ renderSearchPage(); setNav("search"); },
      openLibrary(){ renderLibraryPage(); setNav("library"); },
      openFollowed(){ renderFollowedPage(); setNav("follow"); },
      openCultivation(){ renderCultivationPage(); setNav("cult"); },

      openPay(){
        App.openDrawer();
        $("#payCode").value = `CT${Math.floor(1000 + Math.random()*9000)}`;
        toast("MÃ£ náº¡p Ä‘Ã£ táº¡o. Copy vÃ  dÃ¡n vÃ o ná»™i dung chuyá»ƒn khoáº£n.");
      },
      copyPayCode(){
        const v = $("#payCode").value.trim();
        if(!v) return toast("ChÆ°a cÃ³ mÃ£.");
        navigator.clipboard?.writeText(v);
        toast("âœ… ÄÃ£ copy mÃ£ náº¡p.");
      },

      toggleTheme(){
        const cur = localStorage.getItem(LS.theme) || (matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark");
        applyTheme(cur === "light" ? "dark" : "light");
      },

      openStory(storyId){
        renderStoryDetail(storyId);
      },
      async reloadChapters(){
        const s = State.activeStory;
        if(!s) return;
        const box = $("#chapterList");
        if(box) box.innerHTML = `<div class="muted">Äang táº£i chÆ°Æ¡ng...</div>`;
        try{ await renderChaptersList(s.id); }catch(e){
          console.error(e);
          toast("KhÃ´ng táº£i Ä‘Æ°á»£c chÆ°Æ¡ng.");
        }
      },
      readFirst(){
        const s = State.activeStory;
        if(!s) return;
        const ch = (s.chaptersCache||[])[0];
        if(ch) App.openReader(s.id, ch.id);
        else App.reloadChapters().then(()=>{
          const ch2 = (s.chaptersCache||[])[0];
          if(ch2) App.openReader(s.id, ch2.id);
        });
      },
      readContinue(){
        const s = State.activeStory;
        if(!s) return;
        const lastRead = State.userDoc?.lastRead || JSON.parse(localStorage.getItem(LS.lastRead) || "null");
        if(lastRead?.storyId === s.id && lastRead?.chapterId) return App.openReader(s.id, lastRead.chapterId);
        App.readFirst();
      },

      openReader,

      prevChapter(){
        const prev = getNeighborChapter(-1);
        if(!prev) return toast("ÄÃ£ á»Ÿ chÆ°Æ¡ng Ä‘áº§u.");
        App.openReader(State.activeStory.id, prev.id);
      },
      nextChapter(){
        const next = getNeighborChapter(1);
        if(!next) return toast("ÄÃ£ á»Ÿ chÆ°Æ¡ng cuá»‘i.");
        App.openReader(State.activeStory.id, next.id);
      },

      tts(){
        const text = $("#readerText")?.textContent || "";
        if(!text.trim()) return toast("ChÆ°Æ¡ng trá»‘ng.");
        ttsSpeak(text);
      },
      ttsStop(){ ttsStop(); toast("ÄÃ£ dá»«ng Ä‘á»c."); },

      fontMinus(){
        setReaderSize(getReaderSize()-1);
        toast(`Cá»¡ chá»¯: ${getReaderSize()}px`);
      },
      fontPlus(){
        setReaderSize(getReaderSize()+1);
        toast(`Cá»¡ chá»¯: ${getReaderSize()}px`);
      },

      async finishChapter(){
        const s = State.activeStory, ch = State.activeChapter;
        if(!s || !ch) return;
        if(isChapterDone(s.id, ch.id)) return toast("Báº¡n Ä‘Ã£ nháº­n EXP chÆ°Æ¡ng nÃ y rá»“i.");
        markChapterDone(s.id, ch.id);

        // exp based on length (simple)
        const len = (ch.content||"").length;
        const amount = clamp(8 + Math.floor(len/1200)*2, 8, 24);

        await gainExp(amount);
        toast(`âœ… Nháº­n +${amount} EXP!`);
      },

      toggleFollow(storyId){
        const yes = !isInList("follow", storyId);
        setInList("follow", storyId, yes);
        toast(yes ? "ÄÃ£ theo dÃµi" : "ÄÃ£ bá» theo dÃµi");
        // rerender story detail buttons
        renderStoryDetail(storyId);
      },
      toggleLibrary(storyId){
        const yes = !isInList("library", storyId);
        setInList("library", storyId, yes);
        toast(yes ? "ÄÃ£ thÃªm vÃ o tá»§" : "ÄÃ£ xoÃ¡ khá»i tá»§");
        renderStoryDetail(storyId);
      },

      shuffleRandom(){
        renderHome();
        toast("ğŸ² ÄÃ£ lÃ m má»›i danh sÃ¡ch ngáº«u nhiÃªn!");
      },

      runSearch,

      // Auth
      async loginGoogle(){
        try{
          await signInWithPopup(auth, provider);
        }catch(e){
          console.error(e);
          toast("âŒ KhÃ´ng Ä‘Äƒng nháº­p Ä‘Æ°á»£c. Kiá»ƒm tra popup / trÃ¬nh duyá»‡t.");
        }
      },
      async logout(){
        try{ await signOut(auth); }catch(e){}
      },

      // Admin
      adminCreateStory,
      adminAddChapter,
      adminOpenImport,
      adminImportOld,
    };

    // =============================
    // 13) Boot
    // =============================
    function boot(){
      // theme
      const saved = localStorage.getItem(LS.theme);
      if(saved) applyTheme(saved);
      else applyTheme(matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark");

      // reader font
      setReaderSize(getReaderSize());

      // cultivation for guest
      if(!State.user){
        const g = JSON.parse(localStorage.getItem("ct_guest_cult") || '{"exp":0,"idx":0}');
        State.userDoc = { cultivationExp: g.exp||0, cultivationRealmIndex: g.idx||0, library: JSON.parse(localStorage.getItem(LS.library)||"[]"), follow: JSON.parse(localStorage.getItem(LS.follow)||"[]"), history: JSON.parse(localStorage.getItem(LS.history)||"[]"), lastRead: JSON.parse(localStorage.getItem(LS.lastRead)||"null") };
        calcCultivationView();
      }

      // online placeholder (sau nÃ y dÃ¹ng Realtime Database presence)
      $("#onlineCount").textContent = "0";

      subscribeStories();

      // global click close modal if tap outside sheet on desktop
      $("#modal").addEventListener("click", (e)=>{
        if(e.target.id === "modal") App.closeModal();
      });

      // close modal on ESC
      window.addEventListener("keydown",(e)=>{
        if(e.key === "Escape") App.closeModal();
      });

      renderHome();
    }

    onAuthStateChanged(auth, async (user)=>{
      State.user = user || null;
      State.isAdmin = !!(user?.email && ADMIN_EMAILS.has(user.email));
      if(user){
        await ensureUserDoc(user);
        State.userDoc = await loadUserState(user.uid);
      } else {
        // back to guest state
        const g = JSON.parse(localStorage.getItem("ct_guest_cult") || '{"exp":0,"idx":0}');
        State.userDoc = { cultivationExp: g.exp||0, cultivationRealmIndex: g.idx||0, library: JSON.parse(localStorage.getItem(LS.library)||"[]"), follow: JSON.parse(localStorage.getItem(LS.follow)||"[]"), history: JSON.parse(localStorage.getItem(LS.history)||"[]"), lastRead: JSON.parse(localStorage.getItem(LS.lastRead)||"null") };
      }

      updateHeaderProfile();
      calcCultivationView();
      renderHome();
    });

    boot();

    // =============================
    // 14) Firestore Security Rules (dÃ¡n vÃ o Firebase Console > Firestore > Rules)
    // =============================
    // rules_version = '2';
    // service cloud.firestore {
    //   match /databases/{database}/documents {
    //     function isSignedIn() { return request.auth != null; }
    //     function isAdmin() {
    //       // CÃ¡ch 1 (Ä‘Æ¡n giáº£n): check email admin
    //       return isSignedIn() && (request.auth.token.email in ['sumi22122005@gmail.com']);
    //     }
    //
    //     match /stories/{storyId} {
    //       allow read: if true; // ai cÅ©ng Ä‘á»c Ä‘Æ°á»£c
    //       allow write: if isAdmin();
    //       match /chapters/{chapterId} {
    //         allow read: if true;
    //         allow write: if isAdmin();
    //       }
    //     }
    //
    //     match /users/{uid} {
    //       allow read, write: if isSignedIn() && request.auth.uid == uid;
    //     }
    //   }
    // }
  </script>
</body>
</html>

